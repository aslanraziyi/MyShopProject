D:\MyShopProject\wwwroot\css\site.css

/* Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
for details on configuring this project to bundle and minify static web assets. */
a.navbar-brand {
    white-space: normal;
    text-align: center;
    word-break: break-all;
}

a {
    color: #0077cc;
}

.btn-primary {
    color: #fff;
    background-color: #1b6ec2;
    border-color: #1861ac;
}

.nav-pills .nav-link.active, .nav-pills .show > .nav-link {
    color: #fff;
    background-color: #1b6ec2;
    border-color: #1861ac;
}

.border-top {
    border-top: 1px solid #e5e5e5;
}

.border-bottom {
    border-bottom: 1px solid #e5e5e5;
}

.box-shadow {
    box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .05);
}

button.accept-policy {
    font-size: 1rem;
    line-height: inherit;
}
/* فوتر معمولی - در انتهای محتوا */
.footer {
    position: relative !important;
    bottom: auto !important;
    width: 100% !important;
    white-space: nowrap;
    line-height: 60px;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
    border-top: 3px solid #3498db !important;
    margin-top: auto;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

    .footer.text-muted {
        color: #ecf0f1 !important;
    }

    .footer a.text-muted {
        color: #bdc3c7 !important;
        transition: color 0.3s ease;
    }

        .footer a.text-muted:hover {
            color: #3498db !important;
        }
/* استایل‌های عمومی */
html {
    font-size: 14px;
    position: relative;
    min-height: 100%;
    height: 100%;
}

@media (min-width: 768px) {
    html {
        font-size: 16px;
    }
}

.btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
    box-shadow: 0 0 0 0.1rem white, 0 0 0 0.25rem #258cfb;
}

html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}

body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    margin-bottom: 0;
    padding: 0;
    position: relative;
    font-family: 'Vazirmatn', sans-serif !important;
}

.container {
    flex: 1;
}

.main-content {
    flex: 1;
}

.content-wrapper {
    min-height: 70vh;
    position: relative;
}

.page-end-space {
    height: 100px;
    background: transparent;
}

.product-card {
    margin-bottom: 2rem;
}
/* سبد خرید شناور - تغییر موقعیت: 5 سانت به پایین */
.floating-cart {
    position: fixed;
    top: 125px;
    left: 30px;
    z-index: 1000;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    padding: 15px;
    border: 2px solid #28a745;
    transition: all 0.3s ease;
    cursor: pointer;
}

    .floating-cart:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        background: #f8f9fa;
    }

.floating-cart-link {
    display: block;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
}

.floating-cart-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.floating-cart-icon {
    font-size: 1.5rem;
    color: #28a745;
}

.floating-cart-count {
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

.floating-cart-text {
    font-size: 0.9rem;
    font-weight: bold;
    color: #2c3e50;
}

.floating-cart.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    border-color: #6c757d;
}

    .floating-cart.disabled:hover {
        transform: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        background: #fff;
    }

    .floating-cart.disabled .floating-cart-icon {
        color: #6c757d;
    }

    .floating-cart.disabled .floating-cart-link {
        cursor: not-allowed;
    }

.sticky-summary {
    position: fixed !important;
    top: 15rem !important;
    left: 13rem !important;
    z-index: 100 !important;
    transition: all 0.3s ease !important;
    width: 350px !important;
    max-height: calc(100vh - 6rem) !important;
}

.order-summary-card {
    border: 2px solid #3498db !important;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2) !important;
    transition: all 0.3s ease !important;
    height: fit-content !important;
    min-height: 300px !important;
}

    .order-summary-card:hover {
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3) !important;
        transform: translateY(-2px) !important;
    }

    .order-summary-card .card-body {
        min-height: 250px !important;
        display: flex !important;
        flex-direction: column !important;
    }

    .order-summary-card .btn {
        border-radius: 8px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
    }

        .order-summary-card .btn:hover {
            transform: translateY(-1px) !important;
        }

@media print {
    .no-print, .btn, .action-buttons, .card-header.bg-secondary, .bg-light,
    .floating-cart, .navbar, .footer, .sticky-summary, .order-summary-card,
    .form-control, .form-label, .text-danger, .validation-summary-errors,
    .col-lg-6:first-child {
        display: none !important;
    }

    body {
        background: white !important;
        font-size: 11px !important;
        line-height: 1.1 !important;
        margin: 0 !important;
        padding: 5px !important;
        color: #000 !important;
        width: 100% !important;
    }

    .container {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }

    .invoice-container {
        border: none !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }

    .print-header {
        margin-bottom: 4px !important;
        padding-bottom: 3px !important;
        border-bottom: 2px solid #000 !important;
    }

        .print-header h4 {
            font-size: 14px !important;
            margin-bottom: 1px !important;
            color: #000 !important;
            font-weight: bold !important;
        }

        .print-header h5 {
            font-size: 12px !important;
            margin-bottom: 0 !important;
            color: #000 !important;
            font-weight: bold !important;
        }

        .print-header small {
            font-size: 10px !important;
            color: #000 !important;
            font-weight: bold !important;
        }

    .print-customer-info {
        margin-bottom: 6px !important;
        padding: 6px !important;
        background: #f8f9fa !important;
        border: 1px solid #000 !important;
        border-radius: 2px !important;
    }

        .print-customer-info h6 {
            font-size: 11px !important;
            margin-bottom: 4px !important;
            color: #000 !important;
            font-weight: bold !important;
        }

    .customer-info-row {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 8px !important;
        font-size: 9px !important;
        margin-bottom: 3px !important;
    }

        .customer-info-row .col-3 {
            flex: 1 !important;
            min-width: 25% !important;
        }

        .customer-info-row .text-dark {
            color: #000 !important;
            font-weight: bold !important;
        }

    .customer-info .row.mt-2 {
        margin-top: 3px !important;
        font-size: 9px !important;
    }

    .invoice-table {
        margin-bottom: 8px !important;
    }

        .invoice-table h6 {
            font-size: 11px !important;
            margin-bottom: 4px !important;
            color: #000 !important;
            font-weight: bold !important;
        }

    .table {
        font-size: 9px !important;
        width: 100% !important;
        border-collapse: collapse !important;
        margin-bottom: 5px !important;
    }

        .table th,
        .table td {
            padding: 3px 4px !important;
            border: 1px solid #000 !important;
            text-align: center !important;
        }

        .table th {
            background: #f8f9fa !important;
            font-weight: bold !important;
            color: #000 !important;
        }

        .table td {
            color: #000 !important;
        }

        .table tfoot td {
            background: #e9ecef !important;
            font-weight: bold !important;
            color: #000 !important;
        }

    .card, .card-body, .p-4, .mt-4, .mb-4, .row, .col-lg-6 {
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        width: 100% !important;
    }

    @page {
        margin: 0.3cm !important;
        size: auto;
    }

    .table tbody tr {
        page-break-inside: avoid;
    }

    .fw-bold {
        font-weight: bold !important;
        color: #000 !important;
    }

    strong {
        font-weight: bold !important;
        color: #000 !important;
    }
}

@media (max-width: 768px) {
    .sticky-summary {
        position: relative !important;
        top: 0 !important;
        left: auto !important;
        width: 100% !important;
        margin-top: 4.5rem !important;
        max-height: none !important;
    }

    .order-summary-card {
        height: auto !important;
        min-height: auto !important;
    }

        .order-summary-card .card-body {
            min-height: auto !important;
        }

    .page-end-space {
        height: 80px;
    }

    .footer {
        line-height: 50px;
    }

    .floating-cart {
        top: 105px;
        left: 15px;
        padding: 10px;
    }

    .floating-cart-icon {
        font-size: 1.2rem;
    }

    .floating-cart-text {
        font-size: 0.8rem;
    }

    .cart-item {
        padding: 10px;
        margin-bottom: 10px;
    }

    .user-dropdown-menu {
        transform: translateX(40px) !important;
    }

    .user-menu-item {
        margin-left: 2.5rem !important;
    }

    .cart-menu-item {
        margin-left: 1.5rem !important;
    }

    .debug-info {
        display: none;
    }

    .form-control {
        font-size: 16px;
    }

    .image-preview {
        max-width: 150px;
        max-height: 120px;
    }
}

.user-dropdown-menu {
    left: auto !important;
    right: 0 !important;
    transform: translateX(80px) !important;
}

.user-menu-item {
    margin-left: 5rem !important;
}

.cart-menu-item {
    margin-left: 3rem !important;
}

.debug-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin: 10px 0;
    font-size: 12px;
    color: #6c757d;
}

.form-label {
    color: #2c3e50 !important;
    font-weight: 600 !important;
    margin-bottom: 8px;
}

.form-control,
input,
textarea,
select,
input[type="text"],
input[type="email"],
input[type="password"],
input[type="number"],
input[type="tel"],
input[type="url"],
input[type="search"],
input[type="date"],
input[type="datetime-local"],
input[type="month"],
input[type="week"],
input[type="time"],
input[type="file"] {
    border: 2px solid #000 !important;
    border-radius: 8px;
    transition: all 0.3s ease;
    color: #3498db !important;
    font-weight: 500;
    padding: 10px 12px;
}

    .form-control:focus,
    input:focus,
    textarea:focus,
    select:focus {
        border-color: #000 !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.15) !important;
        color: #2980b9 !important;
    }

    input[type="number"].form-control {
        font-weight: 600;
    }

.image-preview {
    max-width: 200px;
    max-height: 150px;
    border: 2px solid #3498db;
    border-radius: 8px;
    padding: 5px;
    background: white;
}

.upload-btn {
    border: 2px solid #6c757d;
    border-radius: 8px;
    color: #6c757d;
    font-weight: 500;
    transition: all 0.3s ease;
}

    .upload-btn:hover {
        background-color: #6c757d;
        color: white;
    }

.cart-item {
    transition: all 0.3s ease;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}

    .cart-item:hover {
        background: #e9ecef;
        transform: translateX(-5px);
    }

@media (max-width: 576px) {
    .floating-cart {
        top: 95px;
        left: 10px;
        padding: 8px;
    }

    .user-dropdown-menu {
        transform: translateX(20px) !important;
    }

    .user-menu-item {
        margin-left: 1.5rem !important;
    }

    .cart-menu-item {
        margin-left: 1rem !important;
    }
}

body.short-content {
    min-height: 100vh;
}

    body.short-content .main-content {
        min-height: 70vh;
    }

#Register .form-control,
#Register select.form-control,
#Register textarea.form-control {
    border: 2px solid #000 !important;
    background-color: #f8fdff !important;
}

    #Register .form-control:focus,
    #Register select.form-control:focus,
    #Register textarea.form-control:focus {
        border-color: #000 !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.15) !important;
        background-color: #ffffff !important;
    }

/* === اصلاحات مدیریت کاربران === */
.users-table {
    font-size: 0.9rem;
}

    .users-table th,
    .users-table td {
        vertical-align: middle;
        text-align: center;
        padding: 10px 6px !important;
    }

    .users-table .form-check-input {
        width: 18px;
        height: 18px;
        border: 2px solid #000 !important;
        accent-color: #667eea;
        cursor: pointer;
    }

    .users-table .avatar {
        font-size: 0.8rem;
        font-weight: bold;
    }

    .users-table code {
        font-size: 0.8rem;
    }

    .users-table .badge {
        font-size: 0.8rem;
    }

/* === جدید: حالت اکسل با بردر مشکی برای جدول کاربران === */
.users-table--excel {
    border: 2px solid #000 !important;
    border-collapse: collapse !important;
    background: #fff !important;
}

    .users-table--excel thead th,
    .users-table--excel tbody td,
    .users-table--excel tfoot td {
        border: 1px solid #000 !important;
    }

    .users-table--excel thead th {
        background: #f1f3f5 !important;
        color: #000 !important;
        font-weight: 700 !important;
    }

    /* برای تفکیک بهتر سطرها روی هاور */
    .users-table--excel tbody tr:hover {
        background: #fafafa !important;
    }

/* === جدید: برجسته‌سازی فیلترها با بردر مشکی === */
.filter-input-black {
    border: 2px solid #000 !important;
    box-shadow: none !important;
}

    .filter-input-black:focus {
        border: 2px solid #000 !important;
        box-shadow: 0 0 0 0.15rem rgba(0,0,0,0.15) !important;

-------------------------------------------------------------------------------------------------------
site.js
// مدیریت وضعیت سبد خرید و تعداد محصولات
const CartManager = {
    // ذخیره تعداد محصولات در localStorage
    saveProductQuantities: function () {
        if (typeof Storage === "undefined") return;

        try {
            const quantities = {};
            document.querySelectorAll('.product-card').forEach(card => {
                const productId = card.dataset.productId;
                const quantityInput = card.querySelector('.product-quantity');
                if (quantityInput) {
                    quantities[productId] = quantityInput.value;
                }
            });
            localStorage.setItem('myshop_productQuantities', JSON.stringify(quantities));
        } catch (e) {
            console.error('خطا در ذخیره‌سازی:', e);
        }
    },

    // بارگذاری تعداد محصولات از localStorage
    loadProductQuantities: function () {
        if (typeof Storage === "undefined") return;

        try {
            const saved = localStorage.getItem('myshop_productQuantities');
            if (saved) {
                const quantities = JSON.parse(saved);

                document.querySelectorAll('.product-card').forEach(card => {
                    const productId = card.dataset.productId;
                    const quantityInput = card.querySelector('.product-quantity');
                    if (quantityInput && quantities[productId]) {
                        const maxVal = parseInt(quantityInput.getAttribute('max'));
                        const savedVal = parseInt(quantities[productId]);
                        const finalVal = Math.min(savedVal, maxVal);

                        if (finalVal > 0) {
                            quantityInput.value = finalVal;
                        }
                    }
                });
            }
        } catch (e) {
            console.error('خطا در بارگذاری:', e);
        }
    },

    // پاک کردن تعدادهای ذخیره شده
    clearProductQuantities: function () {
        if (typeof Storage === "undefined") return;

        try {
            localStorage.removeItem('myshop_productQuantities');
        } catch (e) {
            console.error('خطا در پاک کردن:', e);
        }
    },

    // به روزرسانی تعداد سبد خرید
    updateCartCount: function () {
        fetch('/Cart/GetCartItemCount')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const cartCount = document.getElementById('cartCount');
                if (cartCount) {
                    cartCount.textContent = data.count;
                }
                const floatingCartCount = document.getElementById('floatingCartCount');
                if (floatingCartCount) {
                    floatingCartCount.textContent = data.count;
                }
            })
            .catch(error => {
                console.error('Error updating cart count:', error);
                const cartCount = document.getElementById('cartCount');
                if (cartCount) {
                    cartCount.textContent = '0';
                }
                const floatingCartCount = document.getElementById('floatingCartCount');
                if (floatingCartCount) {
                    floatingCartCount.textContent = '0';
                }
            });
    },

    // مقداردهی اولیه
    init: function () {
        console.log('CartManager initialized');

        // بارگذاری تعدادها
        this.loadProductQuantities();
        this.updateCartCount();

        // ذخیره وضعیت هنگام خروج از صفحه
        window.addEventListener('beforeunload', () => {
            this.saveProductQuantities();
        });
    }
};

// راه‌اندازی وقتی DOM آماده است
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () {
        CartManager.init();
    });
} else {
    CartManager.init();
}

// تابع‌های کمکی برای نمایش پیام
function showSuccessMessage(message) {
    console.log(' ' + message);
    const toastHtml = `
        <div class="alert alert-success alert-dismissible fade show position-fixed"
             style="top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;">
            <strong></strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => alert.remove());
    }, 4000);
}

function showErrorMessage(message) {
    console.error(' ' + message);
    const toastHtml = `
        <div class="alert alert-danger alert-dismissible fade show position-fixed"
             style="top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;">
            <strong></strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => alert.remove());
    }, 4000);
}

// --- جستجوی زنده ---
const searchInput = document.querySelector('#searchInput');
const searchResults = document.querySelector('#searchResults');

if (searchInput && searchResults) {
    let debounceTimer;

    searchInput.addEventListener('input', function () {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        debounceTimer = setTimeout(() => {
            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            fetch(`/Products/Search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    if (data.length === 0) {
                        searchResults.innerHTML = '<div class="p-3 text-center text-muted">موردی یافت نشد</div>';
                        searchResults.style.display = 'block';
                        return;
                    }

                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item p-3 border-bottom';
                        div.innerHTML = `
                            <div class="d-flex">
                                <img src="${item.imageUrl}" alt="${item.productName}" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${item.productName}</h6>
                                    <p class="mb-1 text-success">قیمت: ${item.price.toLocaleString()} تومان</p>
                                    <small class="text-muted">
                                        <strong>${item.matchText}</strong> 
                                        <em>در ${item.matchField}</em>
                                    </small>
                                </div>
                            </div>
                        `;
                        div.addEventListener('click', () => {
                            window.location.href = `/Products/Details/${item.id}`;
                        });
                        searchResults.appendChild(div);
                    });

                    searchResults.style.display = 'block';
                })
                .catch(err => {
                    console.error('خطا در جستجو:', err);
                    searchResults.innerHTML = '<div class="p-3 text-center text-danger">خطا در جستجو</div>';
                    searchResults.style.display = 'block';
                });
        }, 300);
    });

    // بستن نتایج با کلیک بیرون
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
}

// مدیریت موقعیت خلاصه سفارش - نسخه ساده و قطعی
function initializeCartSummaryPosition() {
    const summary = document.querySelector('.sticky-summary');
    const footer = document.querySelector('footer');

    if (!summary || !footer) return;

    let isStuck = false;

    function updatePosition() {
        if (window.innerWidth <= 768) return;

        const scrollTop = window.scrollY;
        const footerTop = footer.getBoundingClientRect().top + scrollTop;
        const summaryHeight = summary.offsetHeight;
        const summaryBottom = scrollTop + summary.getBoundingClientRect().top + summaryHeight;

        if (summaryBottom >= footerTop - 10) {
            if (!isStuck) {
                isStuck = true;
                const stopPosition = footerTop - summaryHeight - 10;
                summary.style.top = (stopPosition - scrollTop) + 'px';
                console.log('خلاصه سفارش در بالای فوتر متوقف شد');
            }
        } else {
            if (isStuck) {
                isStuck = false;
                summary.style.top = '15rem';
            }
        }
    }

    window.addEventListener('scroll', updatePosition);
    window.addEventListener('resize', updatePosition);
    setTimeout(updatePosition, 100);
}

document.addEventListener('DOMContentLoaded', function () {
    initializeCartSummaryPosition();
});
-----------------------------------------------------------------------------------------------
D:\MyShopProject\Controllers\AccountController.cs

using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;
using System.Security.Claims;
using System.Security.Cryptography;
using System.Text;
using System.Globalization;
using System.Net;
using System.Net.Mail;

namespace MyShopProject.Controllers
{
    public class AccountController : Controller
    {
        private readonly AppDbContext _context;
        private readonly IConfiguration _configuration;

        public AccountController(AppDbContext context, IConfiguration configuration)
        {
            _context = context;
            _configuration = configuration;
        }

        // GET: Account/Register
        public IActionResult Register()
        {
            if (HttpContext.Session.GetString("UserID") != null)
            {
                return RedirectToAction("Index", "Products");
            }
            return View();
        }

        // POST: Account/Register
        [HttpPost]
        public async Task<IActionResult> Register(User user, string password)
        {
            if (ModelState.IsValid)
            {
                try
                {
                    bool userExists = await _context.Users.AnyAsync(u => u.Email == user.Email);
                    if (userExists)
                    {
                        ModelState.AddModelError("Email", "این ایمیل قبلاً ثبت شده است");
                        return View(user);
                    }

                    // ترکیب آدرس: استان + ادامه آدرس
                    if (!string.IsNullOrEmpty(user.Province) && !string.IsNullOrEmpty(user.DetailedAddress))
                    {
                        user.Address = $"{user.Province.Trim()} - {user.DetailedAddress.Trim()}";
                    }
                    else
                    {
                        user.Address = string.Empty;
                    }

                    user.PasswordHash = HashPassword(password);
                    user.CreatedAt = DateTime.Now;
                    _context.Users.Add(user);
                    await _context.SaveChangesAsync();

                    // تنظیم سشن
                    HttpContext.Session.SetString("UserID", user.UserID.ToString());
                    HttpContext.Session.SetString("Email", user.Email ?? "");
                    HttpContext.Session.SetString("Name", user.FirstName ?? "");
                    HttpContext.Session.SetString("Role", user.IsAdmin ? "Admin" : "User");

                    // ایجاد Claims برای احراز نقش
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.Name, user.Email),
                        new Claim(ClaimTypes.NameIdentifier, user.UserID.ToString()),
                        new Claim(ClaimTypes.Role, user.IsAdmin ? "Admin" : "User")
                    };

                    var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    var principal = new ClaimsPrincipal(identity);

                    await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

                    await TransferGuestCartToUser(user.UserID);

                    TempData["SuccessMessage"] = $"خوش آمدید {user.FirstName}! ثبت نام شما با موفقیت انجام شد.";
                    return RedirectToAction("Index", "Products");
                }
                catch
                {
                    ModelState.AddModelError("", "خطا در ثبت نام. لطفاً دوباره تلاش کنید.");
                    return View(user);
                }
            }
            return View(user);
        }

        // GET: Account/Login
        public IActionResult Login()
        {
            if (HttpContext.Session.GetString("UserID") != null)
            {
                return RedirectToAction("Index", "Products");
            }
            if (TempData["SuccessMessage"] != null)
                ViewBag.SuccessMessage = TempData["SuccessMessage"];
            if (TempData["OTPLoginHint"] != null)
                ViewBag.OTPLoginHint = TempData["OTPLoginHint"];
            return View();
        }

        // POST: Account/Login
        [HttpPost]
        public async Task<IActionResult> Login(string email, string password, string returnUrl = null)
        {
            try
            {
                if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(password))
                {
                    ModelState.AddModelError("", "ایمیل و رمز عبور را وارد کنید");
                    return View();
                }

                var user = await _context.Users.FirstOrDefaultAsync(u => u.Email == email);
                if (user == null)
                {
                    ModelState.AddModelError("", "کاربری با این ایمیل یافت نشد");
                    return View();
                }

                // بررسی ورود با OTP
                var otpKey = $"OTP_{email}";
                var storedOTP = HttpContext.Session.GetString(otpKey);
                var otpTimeStr = HttpContext.Session.GetString($"OTP_Time_{email}");
                if (storedOTP == password && !string.IsNullOrEmpty(otpTimeStr))
                {
                    if (DateTime.TryParseExact(otpTimeStr, "yyyyMMddHHmm", null, DateTimeStyles.None, out DateTime otpTime))
                    {
                        if (DateTime.Now.Subtract(otpTime).TotalMinutes > 15)
                        {
                            HttpContext.Session.Remove(otpKey);
                            HttpContext.Session.Remove($"OTP_Time_{email}");
                            HttpContext.Session.Remove($"OTP_UserID_{email}");
                            ModelState.AddModelError("", "رمز یکبارمصرف منقضی شده است");
                            return View();
                        }
                    }

                    // تنظیم سشن
                    HttpContext.Session.SetString("UserID", user.UserID.ToString());
                    HttpContext.Session.SetString("Email", user.Email ?? "");
                    HttpContext.Session.SetString("Name", user.FirstName ?? "");
                    HttpContext.Session.SetString("Role", user.IsAdmin ? "Admin" : "User");
                    HttpContext.Session.SetString("ForcePasswordChange", "true");

                    // ایجاد Claims
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.Name, user.Email),
                        new Claim(ClaimTypes.NameIdentifier, user.UserID.ToString()),
                        new Claim(ClaimTypes.Role, user.IsAdmin ? "Admin" : "User")
                    };

                    var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    var principal = new ClaimsPrincipal(identity);
                    await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

                    HttpContext.Session.Remove(otpKey);
                    HttpContext.Session.Remove($"OTP_Time_{email}");
                    HttpContext.Session.Remove($"OTP_UserID_{email}");

                    await TransferGuestCartToUser(user.UserID);
                    TempData["SuccessMessage"] = "با رمز یکبارمصرف وارد شدید. لطفاً رمز عبور دائمی خود را تنظیم کنید.";
                    return RedirectToAction("Profile");
                }

                // بررسی رمز اصلی
                if (VerifyPassword(password, user.PasswordHash ?? ""))
                {
                    // تنظیم سشن
                    HttpContext.Session.SetString("UserID", user.UserID.ToString());
                    HttpContext.Session.SetString("Email", user.Email ?? "");
                    HttpContext.Session.SetString("Name", user.FirstName ?? "");
                    HttpContext.Session.SetString("Role", user.IsAdmin ? "Admin" : "User");

                    // ایجاد Claims
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.Name, user.Email),
                        new Claim(ClaimTypes.NameIdentifier, user.UserID.ToString()),
                        new Claim(ClaimTypes.Role, user.IsAdmin ? "Admin" : "User")
                    };

                    var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    var principal = new ClaimsPrincipal(identity);
                    await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

                    await TransferGuestCartToUser(user.UserID);
                    TempData["SuccessMessage"] = $"خوش آمدید {user.FirstName} عزیز!";

                    if (!string.IsNullOrEmpty(returnUrl) && Url.IsLocalUrl(returnUrl))
                        return Redirect(returnUrl);

                    return RedirectToAction("Index", "Cart");
                }
                else
                {
                    ModelState.AddModelError("", "رمز عبور اشتباه است");
                    return View();
                }
            }
            catch
            {
                ModelState.AddModelError("", "خطا در ورود. لطفاً دوباره تلاش کنید.");
                return View();
            }
        }

        // POST: Account/ForceChangePassword
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ForceChangePassword(string newPassword, string confirmPassword)
        {
            if (HttpContext.Session.GetString("ForcePasswordChange") != "true")
            {
                return RedirectToAction("Index", "Products");
            }

            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
                return RedirectToAction("Login");

            if (newPassword != confirmPassword)
            {
                TempData["ErrorMessage"] = "رمز عبور و تکرار آن مطابقت ندارند";
                return RedirectToAction("Profile");
            }

            if (newPassword.Length < 6)
            {
                TempData["ErrorMessage"] = "رمز عبور باید حداقل 6 کاراکتر باشد";
                return RedirectToAction("Profile");
            }

            var user = await _context.Users.FindAsync(int.Parse(userID));
            if (user == null)
                return RedirectToAction("Login");

            user.PasswordHash = HashPassword(newPassword);
            await _context.SaveChangesAsync();
            HttpContext.Session.Remove("ForcePasswordChange");

            TempData["SuccessMessage"] = "رمز عبور با موفقیت تنظیم شد. خوش آمدید!";
            return RedirectToAction("Index", "Products");
        }

        // GET: Account/ForgotPassword
        public IActionResult ForgotPassword()
        {
            return View();
        }

        // POST: Account/ForgotPassword
        [HttpPost]
        public async Task<IActionResult> ForgotPassword(string email)
        {
            try
            {
                if (string.IsNullOrEmpty(email))
                {
                    TempData["ErrorMessage"] = "لطفاً ایمیل خود را وارد کنید";
                    return View();
                }

                var user = await _context.Users.FirstOrDefaultAsync(u => u.Email == email);
                if (user == null)
                {
                    TempData["SuccessMessage"] = "اگر ایمیل در سیستم موجود باشد، رمز یکبارمصرف ارسال خواهد شد";
                    return View();
                }

                string otp = GenerateOTP();
                HttpContext.Session.SetString($"OTP_{user.Email}", otp);
                HttpContext.Session.SetString($"OTP_Time_{user.Email}", DateTime.Now.ToString("yyyyMMddHHmm"));
                HttpContext.Session.SetString($"OTP_UserID_{user.Email}", user.UserID.ToString());

                bool emailSent = await SendOTPEmail(user.Email, user.FirstName, otp);
                if (emailSent)
                {
                    TempData["SuccessMessage"] = "رمز یکبارمصرف به ایمیل شما ارسال شد.";
                    TempData["OTPLoginHint"] = $"رمز یکبارمصرف برای <strong>{email}</strong> ارسال شد. با ایمیل و این رمز وارد شوید.";
                    return RedirectToAction("Login");
                }
                else
                {
                    TempData["OTPCode"] = otp;
                    TempData["SuccessMessage"] = "رمز یکبارمصرف ایجاد شد. در حالت توسعه می‌توانید از رمز زیر استفاده کنید:";
                    TempData["OTPLoginHint"] = $"رمز تست: <strong>{otp}</strong> (فقط در حالت توسعه)";
                    return RedirectToAction("Login");
                }
            }
            catch
            {
                TempData["ErrorMessage"] = "خطا در پردازش درخواست. لطفاً دوباره تلاش کنید.";
                return View();
            }
        }

        private async Task<bool> SendOTPEmail(string email, string firstName, string otp)
        {
            try
            {
                var smtpServer = _configuration["EmailSettings:SmtpServer"] ?? "smtp.gmail.com";
                var smtpPort = int.Parse(_configuration["EmailSettings:SmtpPort"] ?? "587");
                var smtpUsername = _configuration["EmailSettings:Username"] ?? "shoprecpass@gmail.com";
                var smtpPassword = _configuration["EmailSettings:Password"] ?? "yzfm hyou ecln qtjh";
                var fromEmail = _configuration["EmailSettings:FromEmail"] ?? "shoprecpass@gmail.com";

                using var client = new SmtpClient(smtpServer, smtpPort);
                client.Credentials = new NetworkCredential(smtpUsername, smtpPassword);
                client.EnableSsl = true;

                var mailMessage = new MailMessage
                {
                    From = new MailAddress(fromEmail, "فروشگاه من"),
                    Subject = "رمز یکبارمصرف ورود - فروشگاه من",
                    Body = $@"
<div dir='rtl' style='font-family: Tahoma, Arial, sans-serif;'>
    <h2 style='color: #2c3e50;'>ورود با رمز یکبارمصرف</h2>
    <p>سلام {firstName} عزیز،</p>
    <p>رمز یکبارمصرف شما برای ورود به فروشگاه:</p>
    <div style='text-align: center; margin: 20px 0;'>
        <div style='background-color: #f8f9fa; border: 2px dashed #3498db;
                    padding: 15px; border-radius: 10px; font-size: 24px;
                    font-weight: bold; color: #2c3e50; letter-spacing: 5px;'>
            {otp}
        </div>
    </div>
    <p>این رمز تا 15 دقیقه آینده معتبر است.</p>
    <p style='color: #e74c3c; font-weight: bold;'>
        توجه: این رمز را در فیلد رمز عبور وارد کنید.
    </p>
    <p>اگر این درخواست را ارسال نکرده‌اید، این ایمیل را نادیده بگیرید.</p>
    <hr style='border: none; border-top: 1px solid #eee; margin: 20px 0;'>
    <p style='color: #7f8c8d; font-size: 12px;'>این ایمیل به صورت خودکار ارسال شده است.</p>
</div>",
                    IsBodyHtml = true
                };
                mailMessage.To.Add(email);
                await client.SendMailAsync(mailMessage);
                return true;
            }
            catch
            {
                return false;
            }
        }

        // GET: Account/Profile
        public async Task<IActionResult> Profile()
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
            {
                TempData["ErrorMessage"] = "لطفاً ابتدا وارد شوید";
                return RedirectToAction("Login");
            }

            var user = await _context.Users.FindAsync(int.Parse(userID));
            if (user == null)
            {
                TempData["ErrorMessage"] = "کاربر یافت نشد";
                return RedirectToAction("Login");
            }

            // جداسازی استان و ادامه آدرس
            string province = string.Empty;
            string detailedAddress = string.Empty;
            if (!string.IsNullOrEmpty(user.Address))
            {
                var parts = user.Address.Split(" - ", 2);
                province = parts.Length > 0 ? parts[0] : string.Empty;
                detailedAddress = parts.Length > 1 ? parts[1] : string.Empty;
            }

            var persianCalendar = new PersianCalendar();
            var createdAtPersian = $"{persianCalendar.GetYear(user.CreatedAt)}/{persianCalendar.GetMonth(user.CreatedAt):00}/{persianCalendar.GetDayOfMonth(user.CreatedAt):00}";
            var createdAtMiladi = user.CreatedAt.ToString("yyyy/MM/dd");

            var profile = new MyShopProject.Models.ProfileViewModel
            {
                UserID = user.UserID,
                Email = user.Email,
                FirstName = user.FirstName,
                LastName = user.LastName,
                PhoneNumber = user.PhoneNumber,
                PostalCode = user.PostalCode,
                Province = province,
                DetailedAddress = detailedAddress,
                Address = user.Address,
                CreatedAt = user.CreatedAt,
                Role = user.IsAdmin ? "مدیر" : "کاربر"
            };

            ViewBag.CreatedAtPersian = createdAtPersian;
            ViewBag.CreatedAtMiladi = createdAtMiladi;
            ViewBag.ForcePasswordChange = HttpContext.Session.GetString("ForcePasswordChange") == "true";
            return View(profile);
        }

        // POST: Account/Profile
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Profile(MyShopProject.Models.ProfileViewModel model)
        {
            if (!ModelState.IsValid)
            {
                var user = await _context.Users.FindAsync(model.UserID);
                if (user != null)
                {
                    var persianCalendar = new PersianCalendar();
                    var createdAtPersian = $"{persianCalendar.GetYear(user.CreatedAt)}/{persianCalendar.GetMonth(user.CreatedAt):00}/{persianCalendar.GetDayOfMonth(user.CreatedAt):00}";
                    var createdAtMiladi = user.CreatedAt.ToString("yyyy/MM/dd");
                    ViewBag.CreatedAtPersian = createdAtPersian;
                    ViewBag.CreatedAtMiladi = createdAtMiladi;
                }
                ViewBag.ForcePasswordChange = HttpContext.Session.GetString("ForcePasswordChange") == "true";
                return View(model);
            }

            try
            {
                var user = await _context.Users.FindAsync(model.UserID);
                if (user == null)
                {
                    TempData["ErrorMessage"] = "کاربر یافت نشد";
                    return RedirectToAction("Login");
                }

                user.FirstName = model.FirstName;
                user.LastName = model.LastName;
                user.PhoneNumber = model.PhoneNumber;
                user.PostalCode = model.PostalCode;

                if (!string.IsNullOrEmpty(model.Province) && !string.IsNullOrEmpty(model.DetailedAddress))
                {
                    user.Province = model.Province.Trim();
                    user.DetailedAddress = model.DetailedAddress.Trim();
                    user.Address = $"{user.Province} - {user.DetailedAddress}";
                }
                else
                {
                    user.Province = string.Empty;
                    user.DetailedAddress = string.Empty;
                    user.Address = string.Empty;
                }

                await _context.SaveChangesAsync();
                HttpContext.Session.SetString("Name", user.FirstName ?? "");

                TempData["SuccessMessage"] = "پروفایل با موفقیت به روزرسانی شد";
                return RedirectToAction("Profile");
            }
            catch
            {
                TempData["ErrorMessage"] = "خطا در به روزرسانی پروفایل";
                ViewBag.ForcePasswordChange = HttpContext.Session.GetString("ForcePasswordChange") == "true";
                return View(model);
            }
        }

        // POST: Account/ChangePassword
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ChangePassword(ChangePasswordViewModel model)
        {
            if (!ModelState.IsValid)
            {
                TempData["ErrorMessage"] = "لطفاً اطلاعات را به درستی وارد کنید";
                return RedirectToAction("Profile");
            }

            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
            {
                TempData["ErrorMessage"] = "لطفاً ابتدا وارد شوید";
                return RedirectToAction("Login");
            }

            var user = await _context.Users.FindAsync(int.Parse(userID));
            if (user == null)
            {
                TempData["ErrorMessage"] = "کاربر یافت نشد";
                return RedirectToAction("Login");
            }

            if (!VerifyPassword(model.CurrentPassword, user.PasswordHash ?? ""))
            {
                TempData["ErrorMessage"] = "رمز عبور فعلی اشتباه است";
                return RedirectToAction("Profile");
            }

            user.PasswordHash = HashPassword(model.NewPassword);
            await _context.SaveChangesAsync();

            TempData["SuccessMessage"] = "رمز عبور شما با موفقیت تغییر یافت";
            return RedirectToAction("Profile");
        }

        public IActionResult Logout()
        {
            HttpContext.Session.Clear();
            HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            TempData["SuccessMessage"] = "با موفقیت از سیستم خارج شدید.";
            return RedirectToAction("Index", "Products");
        }

        private async Task TransferGuestCartToUser(int userId)
        {
            try
            {
                var guestCartItems = GetGuestCartItems();
                if (!guestCartItems.Any()) return;

                var userCart = await _context.Carts
                    .Include(c => c.CartItems)
                    .ThenInclude(ci => ci.Product)
                    .FirstOrDefaultAsync(c => c.UserID == userId && c.IsActive);

                if (userCart == null)
                {
                    userCart = new Cart { UserID = userId, IsActive = true };
                    _context.Carts.Add(userCart);
                    await _context.SaveChangesAsync();
                }

                foreach (var guestItem in guestCartItems)
                {
                    var existingItem = userCart.CartItems.FirstOrDefault(ci => ci.ProductID == guestItem.ProductID);
                    if (existingItem != null)
                        existingItem.Quantity += guestItem.Quantity;
                    else
                    {
                        var newCartItem = new CartItem
                        {
                            CartID = userCart.CartID,
                            ProductID = guestItem.ProductID,
                            Quantity = guestItem.Quantity,
                            AddedAt = DateTime.Now
                        };
                        _context.CartItems.Add(newCartItem);
                    }
                }

                await _context.SaveChangesAsync();
                ClearGuestCart();
                SaveUserCartToSession(userId);
            }
            catch { }
        }

        private List<CartItemViewModel> GetGuestCartItems()
        {
            var sessionKey = GetGuestCartSessionKey();
            var cartJson = HttpContext.Session.GetString(sessionKey);
            if (string.IsNullOrEmpty(cartJson)) return new List<CartItemViewModel>();

            try
            {
                var cartItems = System.Text.Json.JsonSerializer.Deserialize<List<CartItemViewModel>>(cartJson) ?? new List<CartItemViewModel>();
                var productIds = cartItems.Select(x => x.ProductID).Distinct().ToList();
                var products = _context.Products.Where(p => productIds.Contains(p.ProductID)).ToList();
                var productDict = products.ToDictionary(p => p.ProductID, p => p);

                foreach (var item in cartItems)
                {
                    item.Product = productDict.TryGetValue(item.ProductID, out var p) ? p : new Product
                    {
                        ProductID = item.ProductID,
                        ProductName = "محصول حذف شده",
                        Brand = "نامشخص",
                        Price = 0,
                        StockQuantity = 0
                    };
                }
                return cartItems;
            }
            catch { return new List<CartItemViewModel>(); }
        }

        private void ClearGuestCart()
        {
            var sessionKey = GetGuestCartSessionKey();
            HttpContext.Session.Remove(sessionKey);
        }

        private void SaveUserCartToSession(int userId)
        {
            try
            {
                var userCart = _context.Carts
                    .Include(c => c.CartItems)
                    .ThenInclude(ci => ci.Product)
                    .FirstOrDefault(c => c.UserID == userId && c.IsActive);

                if (userCart != null)
                {
                    var cartItemsForSession = userCart.CartItems.Select(ci => new CartItemViewModel
                    {
                        CartItemID = ci.CartItemID,
                        ProductID = ci.ProductID,
                        Quantity = ci.Quantity,
                        Product = ci.Product
                    }).ToList();

                    SaveUserCartItems(cartItemsForSession, userId);
                }
            }
            catch { }
        }

        private void SaveUserCartItems(List<CartItemViewModel> cartItems, int userId)
        {
            var sessionKey = $"Cart_{userId}";
            var itemsToSave = cartItems.Select(item => new CartItemViewModel
            {
                CartItemID = item.CartItemID,
                ProductID = item.ProductID,
                Quantity = item.Quantity
            }).ToList();

            var cartJson = System.Text.Json.JsonSerializer.Serialize(itemsToSave);
            HttpContext.Session.SetString(sessionKey, cartJson);
        }

        private string GetGuestCartSessionKey()
        {
            var guestID = HttpContext.Session.GetString("GuestID");
            if (string.IsNullOrEmpty(guestID))
            {
                guestID = Guid.NewGuid().ToString();
                HttpContext.Session.SetString("GuestID", guestID);
            }
            return $"GuestCart_{guestID}";
        }

        private string GenerateOTP()
        {
            var random = new Random();
            return random.Next(100000, 999999).ToString();
        }

        private string HashPassword(string password)
        {
            if (string.IsNullOrEmpty(password)) return string.Empty;
            using var sha256 = SHA256.Create();
            byte[] bytes = Encoding.UTF8.GetBytes(password);
            byte[] hash = sha256.ComputeHash(bytes);
            return Convert.ToBase64String(hash);
        }

        private bool VerifyPassword(string password, string storedHash)
        {
            if (string.IsNullOrEmpty(password) || string.IsNullOrEmpty(storedHash)) return false;
            return HashPassword(password) == storedHash;
        }
    }

    public class ChangePasswordViewModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}

--------------------------------------------------------------------------------------------

D:\MyShopProject\Controllers\AdminController.cs


using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;
using Microsoft.AspNetCore.Hosting;

namespace MyShopProject.Controllers
{
    public class AdminController : Controller
    {
        private readonly AppDbContext _context;
        private readonly IWebHostEnvironment _environment;

        public AdminController(AppDbContext context, IWebHostEnvironment environment)
        {
            _context = context;
            _environment = environment;
        }

        // داشبورد مدیریت
        public IActionResult Index()
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به پنل مدیریت ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var stats = new AdminDashboardViewModel
                {
                    TotalProducts = _context.Products.Count(),
                    TotalUsers = _context.Users.Count(),
                    TotalCategories = _context.Categories.Count(),
                    TotalCarts = _context.Carts.Count(),
                    LowStockProducts = _context.Products.Where(p => p.StockQuantity < 10).Count(),
                    RecentProducts = _context.Products
                        .Include(p => p.Category)
                        .OrderByDescending(p => p.ProductID)
                        .Take(5)
                        .ToList()
                };

                return View(stats);
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در بارگذاری داشبورد: {ex.Message}";
                return RedirectToAction("Index", "Products");
            }
        }

        // لیست محصولات
        public IActionResult Products()
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var products = _context.Products
                    .Include(p => p.Category)
                    .OrderBy(p => p.ProductID)
                    .ToList();

                ViewBag.Categories = _context.Categories.ToList();
                return View(products);
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در بارگذاری محصولات: {ex.Message}";
                return RedirectToAction("Index");
            }
        }

        // ایجاد محصول جدید - GET
        [HttpGet]
        public IActionResult CreateProduct()
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                ViewBag.Categories = GetCategoriesSelectList();
                return View();
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در بارگذاری فرم: {ex.Message}";
                return RedirectToAction(nameof(Products));
            }
        }

        // ایجاد محصول جدید - POST
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CreateProduct(Product product, IFormFile imageFile, string categoryInput)
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            // 1. اعتبارسنجی تصویر
            if (imageFile == null || imageFile.Length == 0)
            {
                ModelState.AddModelError("imageFile", "لطفاً تصویر محصول را انتخاب کنید");
            }

            // 2. اعتبارسنجی برند
            if (string.IsNullOrWhiteSpace(product.Brand))
            {
                ModelState.AddModelError("Brand", "برند الزامی است");
            }

            // 3. مدیریت دسته‌بندی
            if (string.IsNullOrWhiteSpace(categoryInput))
            {
                ModelState.AddModelError("CategoryID", "دسته‌بندی الزامی است");
            }
            else
            {
                var trimmed = categoryInput.Trim();

                if (int.TryParse(trimmed, out int catId))
                {
                    var existingCat = await _context.Categories.FindAsync(catId);
                    if (existingCat != null)
                    {
                        product.CategoryID = catId;
                    }
                    else
                    {
                        var newCat = new Category { CategoryName = trimmed };
                        _context.Categories.Add(newCat);
                        await _context.SaveChangesAsync();
                        product.CategoryID = newCat.CategoryID;
                    }
                }
                else
                {
                    var existingCat = await _context.Categories
                        .FirstOrDefaultAsync(c => c.CategoryName == trimmed);

                    if (existingCat != null)
                    {
                        product.CategoryID = existingCat.CategoryID;
                    }
                    else
                    {
                        var newCat = new Category { CategoryName = trimmed };
                        _context.Categories.Add(newCat);
                        await _context.SaveChangesAsync();
                        product.CategoryID = newCat.CategoryID;
                    }
                }
            }

            if (ModelState.IsValid)
            {
                try
                {
                    // آپلود تصویر
                    if (imageFile != null && imageFile.Length > 0)
                    {
                        var imageUrl = await SaveImageAsync(imageFile);
                        if (!string.IsNullOrEmpty(imageUrl))
                        {
                            product.ImageUrl = imageUrl;
                        }
                    }

                    if (string.IsNullOrEmpty(product.ImageUrl))
                    {
                        product.ImageUrl = "/images/default-product.png";
                    }

                    _context.Products.Add(product);
                    await _context.SaveChangesAsync();

                    TempData["SuccessMessage"] = $"محصول '{product.ProductName}' با موفقیت ایجاد شد";
                    return RedirectToAction(nameof(Products));
                }
                catch (DbUpdateException dbEx)
                {
                    ModelState.AddModelError("", $"خطا در ذخیره در دیتابیس: {dbEx.InnerException?.Message ?? dbEx.Message}");
                }
                catch (Exception ex)
                {
                    ModelState.AddModelError("", $"خطا در ایجاد محصول: {ex.Message}");
                }
            }

            // جمع‌آوری خطاهای دقیق برای نمایش در فرم
            var errors = ModelState
                .Where(x => x.Value.Errors.Count > 0)
                .Select(x => $"{x.Key}: {x.Value.Errors[0].ErrorMessage}")
                .ToList();

            if (errors.Any())
            {
                TempData["ValidationErrors"] = string.Join(" | ", errors);
            }

            ViewBag.Categories = GetCategoriesSelectList();
            return View(product);
        }

        // ویرایش محصول - GET
        [HttpGet]
        public async Task<IActionResult> EditProduct(int id)
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var product = await _context.Products
                    .Include(p => p.Category)
                    .FirstOrDefaultAsync(p => p.ProductID == id);

                if (product == null)
                {
                    TempData["ErrorMessage"] = "محصول یافت نشد";
                    return RedirectToAction(nameof(Products));
                }

                ViewBag.Categories = GetCategoriesSelectList();
                return View(product);
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در بارگذاری محصول: {ex.Message}";
                return RedirectToAction(nameof(Products));
            }
        }

        // ویرایش محصول - POST
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> EditProduct(int id, Product product, IFormFile imageFile)
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            if (id != product.ProductID)
            {
                TempData["ErrorMessage"] = "محصول نامعتبر";
                return RedirectToAction(nameof(Products));
            }

            ModelState.Remove("imageFile");

            if (ModelState.IsValid)
            {
                try
                {
                    var existingProduct = await _context.Products
                        .FirstOrDefaultAsync(p => p.ProductID == id);

                    if (existingProduct == null)
                    {
                        TempData["ErrorMessage"] = "محصول یافت نشد";
                        return RedirectToAction(nameof(Products));
                    }

                    if (imageFile != null && imageFile.Length > 0)
                    {
                        var imageUrl = await SaveImageAsync(imageFile);
                        if (!string.IsNullOrEmpty(imageUrl))
                        {
                            if (!string.IsNullOrEmpty(existingProduct.ImageUrl) && existingProduct.ImageUrl != "/images/default-product.png")
                            {
                                DeleteOldImage(existingProduct.ImageUrl);
                            }
                            existingProduct.ImageUrl = imageUrl;
                        }
                    }

                    existingProduct.ProductName = product.ProductName;
                    existingProduct.Brand = product.Brand;
                    existingProduct.Price = product.Price;
                    existingProduct.StockQuantity = product.StockQuantity;
                    existingProduct.CategoryID = product.CategoryID;
                    existingProduct.Description = product.Description;
                    existingProduct.Color = product.Color;

                    await _context.SaveChangesAsync();

                    TempData["SuccessMessage"] = $"محصول '{product.ProductName}' با موفقیت ویرایش شد";
                    ViewBag.Categories = GetCategoriesSelectList();
                    return View(product);
                }
                catch (DbUpdateException dbEx)
                {
                    TempData["ErrorMessage"] = $"خطا در به‌روزرسانی: {dbEx.InnerException?.Message ?? dbEx.Message}";
                }
                catch (Exception ex)
                {
                    TempData["ErrorMessage"] = $"خطا در ویرایش محصول: {ex.Message}";
                }
            }
            else
            {
                var errors = ModelState.Values
                    .SelectMany(v => v.Errors)
                    .Select(e => e.ErrorMessage)
                    .ToList();

                if (errors.Any())
                {
                    TempData["ErrorMessage"] = "لطفا اطلاعات را به درستی وارد کنید";
                    TempData["ValidationErrors"] = string.Join(" | ", errors);
                }
            }

            ViewBag.Categories = GetCategoriesSelectList();
            return View(product);
        }

        // حذف محصول
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> DeleteProduct(int id)
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var product = await _context.Products.FindAsync(id);
                if (product == null)
                {
                    TempData["ErrorMessage"] = "محصول یافت نشد";
                    return RedirectToAction(nameof(Products));
                }

                if (!string.IsNullOrEmpty(product.ImageUrl) && product.ImageUrl != "/images/default-product.png")
                {
                    DeleteOldImage(product.ImageUrl);
                }

                var productName = product.ProductName;
                _context.Products.Remove(product);
                await _context.SaveChangesAsync();

                TempData["SuccessMessage"] = $"محصول '{productName}' با موفقیت حذف شد";
            }
            catch (DbUpdateException dbEx)
            {
                TempData["ErrorMessage"] = $"خطا در حذف محصول: {dbEx.InnerException?.Message ?? dbEx.Message}";
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در حذف محصول: {ex.Message}";
            }

            return RedirectToAction(nameof(Products));
        }

        // مدیریت کاربران
        public IActionResult Users()
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var users = _context.Users
                    .OrderBy(u => u.UserID)
                    .ToList();

                return View(users);
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در بارگذاری کاربران: {ex.Message}";
                return RedirectToAction("Index");
            }
        }

        // مدیریت دسته‌بندی‌ها
        public IActionResult Categories()
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var categories = _context.Categories
                    .Include(c => c.Products)
                    .OrderBy(c => c.CategoryID)
                    .ToList();

                return View(categories);
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در بارگذاری دسته‌بندی‌ها: {ex.Message}";
                return RedirectToAction("Index");
            }
        }

        // ایجاد دسته‌بندی جدید
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CreateCategory(string categoryName)
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            if (!string.IsNullOrEmpty(categoryName))
            {
                try
                {
                    var category = new Category { CategoryName = categoryName.Trim() };
                    _context.Categories.Add(category);
                    await _context.SaveChangesAsync();
                    TempData["SuccessMessage"] = $"دسته‌بندی '{categoryName}' با موفقیت ایجاد شد";
                }
                catch (DbUpdateException dbEx)
                {
                    TempData["ErrorMessage"] = $"خطا در ایجاد دسته‌بندی: {dbEx.InnerException?.Message ?? dbEx.Message}";
                }
                catch (Exception ex)
                {
                    TempData["ErrorMessage"] = $"خطا در ایجاد دسته‌بندی: {ex.Message}";
                }
            }
            else
            {
                TempData["ErrorMessage"] = "نام دسته‌بندی الزامی است";
            }

            return RedirectToAction(nameof(Categories));
        }

        // حذف دسته‌بندی
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> DeleteCategory(int id)
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var category = await _context.Categories
                    .Include(c => c.Products)
                    .FirstOrDefaultAsync(c => c.CategoryID == id);

                if (category == null)
                {
                    TempData["ErrorMessage"] = "دسته‌بندی یافت نشد";
                    return RedirectToAction(nameof(Categories));
                }

                if (category.Products.Any())
                {
                    TempData["ErrorMessage"] = "امکان حذف دسته‌بندی دارای محصول وجود ندارد";
                    return RedirectToAction(nameof(Categories));
                }

                var categoryName = category.CategoryName;
                _context.Categories.Remove(category);
                await _context.SaveChangesAsync();
                TempData["SuccessMessage"] = $"دسته‌بندی '{categoryName}' با موفقیت حذف شد";
            }
            catch (DbUpdateException dbEx)
            {
                TempData["ErrorMessage"] = $"خطا در حذف دسته‌بندی: {dbEx.InnerException?.Message ?? dbEx.Message}";
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در حذف دسته‌بندی: {ex.Message}";
            }

            return RedirectToAction(nameof(Categories));
        }

        // آمار فروشگاه (API برای AJAX)
        [HttpGet]
        public IActionResult GetStats()
        {
            if (!IsAdminUser())
            {
                return Json(new { error = "دسترسی غیرمجاز" });
            }

            try
            {
                var stats = new
                {
                    TotalProducts = _context.Products.Count(),
                    TotalUsers = _context.Users.Count(),
                    TotalCategories = _context.Categories.Count(),
                    LowStockProducts = _context.Products.Where(p => p.StockQuantity < 10).Count(),
                    TotalRevenue = _context.Products.Sum(p => p.Price * p.StockQuantity)
                };

                return Json(stats);
            }
            catch (Exception ex)
            {
                return Json(new { error = ex.Message });
            }
        }

        // بررسی موجودی کم
        public IActionResult LowStock()
        {
            if (!IsAdminUser())
            {
                TempData["ErrorMessage"] = "شما دسترسی به این بخش ندارید";
                return RedirectToAction("Index", "Products");
            }

            try
            {
                var lowStockProducts = _context.Products
                    .Include(p => p.Category)
                    .Where(p => p.StockQuantity < 10)
                    .OrderBy(p => p.StockQuantity)
                    .ToList();

                return View(lowStockProducts);
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"خطا در بارگذاری محصولات کم موجود: {ex.Message}";
                return RedirectToAction("Index");
            }
        }

        // API برای گرفتن دسته‌بندی‌ها (برای Select2)
        [HttpGet]
        public IActionResult GetCategories()
        {
            if (!IsAdminUser())
            {
                return Json(new { error = "دسترسی غیرمجاز" });
            }

            try
            {
                var categories = _context.Categories
                    .OrderBy(c => c.CategoryName)
                    .Select(c => new { id = c.CategoryID, text = c.CategoryName })
                    .ToList();

                return Json(categories);
            }
            catch (Exception ex)
            {
                return Json(new { error = ex.Message });
            }
        }

        // بررسی ادمین
        private bool IsAdminUser()
        {
            try
            {
                var userRole = HttpContext.Session.GetString("Role");
                var userID = HttpContext.Session.GetString("UserID");
                return !string.IsNullOrEmpty(userID) && userRole == "Admin";
            }
            catch
            {
                return false;
            }
        }

        // لیست دسته‌بندی‌ها برای dropdown معمولی
        private List<SelectListItem> GetCategoriesSelectList()
        {
            return _context.Categories
                .OrderBy(c => c.CategoryName)
                .Select(c => new SelectListItem
                {
                    Value = c.CategoryID.ToString(),
                    Text = c.CategoryName
                })
                .ToList();
        }

        // ذخیره تصویر
        private async Task<string> SaveImageAsync(IFormFile imageFile)
        {
            try
            {
                var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp" };
                var fileExtension = Path.GetExtension(imageFile.FileName).ToLower();

                if (!allowedExtensions.Contains(fileExtension))
                {
                    throw new Exception("فرمت فایل تصویر معتبر نیست. فقط فایل‌های JPG, PNG, GIF مجاز هستند.");
                }

                if (imageFile.Length > 5 * 1024 * 1024)
                {
                    throw new Exception("حجم فایل نباید بیشتر از 5 مگابایت باشد");
                }

                var uploadsPath = Path.Combine(_environment.WebRootPath, "uploads", "products");
                if (!Directory.Exists(uploadsPath))
                {
                    Directory.CreateDirectory(uploadsPath);
                }

                var fileName = $"{Guid.NewGuid()}{fileExtension}";
                var filePath = Path.Combine(uploadsPath, fileName);

                using (var stream = new FileStream(filePath, FileMode.Create))
                {
                    await imageFile.CopyToAsync(stream);
                }

                return $"/uploads/products/{fileName}";
            }
            catch (Exception ex)
            {
                throw new Exception($"خطا در آپلود تصویر: {ex.Message}");
            }
        }

        // حذف تصویر قدیمی
        private void DeleteOldImage(string imageUrl)
        {
            try
            {
                if (!string.IsNullOrEmpty(imageUrl) && imageUrl.StartsWith("/uploads/products/"))
                {
                    var oldImagePath = Path.Combine(_environment.WebRootPath, imageUrl.TrimStart('/'));
                    if (System.IO.File.Exists(oldImagePath))
                    {
                        System.IO.File.Delete(oldImagePath);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در حذف تصویر قدیمی: {ex.Message}");
            }
        }
    }

    // ویو مدل داشبورد
    public class AdminDashboardViewModel
    {
        public int TotalProducts { get; set; }
        public int TotalUsers { get; set; }
        public int TotalCategories { get; set; }
        public int TotalCarts { get; set; }
        public int LowStockProducts { get; set; }
        public List<Product> RecentProducts { get; set; } = new List<Product>();
    }
}

------------------------------------------------------------------------------------------

D:\MyShopProject\Controllers\CartController.cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;
using System.Text.Json;
using System.Text.Encodings.Web;
using System.Text.Unicode;

namespace MyShopProject.Controllers
{
    public class CartController : Controller
    {
        private readonly AppDbContext _context;

        // تنظیمات JSON سراسری با پشتیبانی از UTF-8
        private static readonly JsonSerializerOptions JsonOptions = new()
        {
            Encoder = JavaScriptEncoder.Create(UnicodeRanges.BasicLatin, UnicodeRanges.Arabic),
            PropertyNamingPolicy = null,
            WriteIndented = true
        };

        public CartController(AppDbContext context)
        {
            _context = context;
        }

        // GET: Cart/Index - نمایش سبد خرید برای همه کاربران
        public async Task<IActionResult> Index()
        {
            try
            {
                var cartItems = await GetCartItemsAsync();
                ViewBag.TotalItemsCount = cartItems.Sum(item => item.Quantity);
                ViewBag.TotalAmount = cartItems.Sum(item => (item.Product?.Price ?? 0) * item.Quantity);

                // بررسی اینکه کاربر مهمان است یا لاگین شده
                ViewBag.IsGuest = string.IsNullOrEmpty(HttpContext.Session.GetString("UserID"));

                return View(cartItems);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در بارگذاری سبد خرید: {ex.Message}");
                TempData["ErrorMessage"] = "خطا در بارگذاری سبد خرید";
                return View(new List<CartItemViewModel>());
            }
        }

        // POST: Cart/UpdateProductQuantity - به روزرسانی تعداد محصول در سبد خرید
        [HttpPost]
        public async Task<IActionResult> UpdateProductQuantity(int productId, int newQuantity)
        {
            try
            {
                if (newQuantity < 0)
                {
                    return Json(new { success = false, message = "تعداد نمی‌تواند منفی باشد" });
                }

                var product = await _context.Products.FindAsync(productId);
                if (product == null)
                {
                    return Json(new { success = false, message = "محصول یافت نشد" });
                }

                // بررسی موجودی
                if (newQuantity > product.StockQuantity)
                {
                    return Json(new { success = false, message = "تعداد انتخابی بیشتر از موجودی است" });
                }

                var cartItems = await GetCartItemsAsync();
                var existingItem = cartItems.FirstOrDefault(item => item.ProductID == productId);

                if (newQuantity == 0)
                {
                    // حذف از سبد خرید
                    if (existingItem != null)
                    {
                        cartItems.Remove(existingItem);
                    }
                }
                else
                {
                    if (existingItem != null)
                    {
                        existingItem.Quantity = newQuantity;
                    }
                    else
                    {
                        // افزودن جدید به سبد خرید
                        cartItems.Add(new CartItemViewModel
                        {
                            CartItemID = Guid.NewGuid().GetHashCode(),
                            ProductID = productId,
                            Quantity = newQuantity,
                            Product = product
                        });
                    }
                }

                await SaveCartItemsAsync(cartItems);

                var totalItems = cartItems.Sum(item => item.Quantity);
                var newStock = product.StockQuantity - newQuantity;

                return Json(new
                {
                    success = true,
                    message = "سبد خرید با موفقیت به روزرسانی شد",
                    totalItems = totalItems,
                    newStock = newStock
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در به روزرسانی سبد خرید: {ex.Message}");
                return Json(new { success = false, message = "خطا در به روزرسانی سبد خرید" });
            }
        }

        // POST: Cart/UpdateQuantity - به روزرسانی تعداد آیتم در سبد خرید
        [HttpPost]
        public async Task<IActionResult> UpdateQuantity(int cartItemId, int newQuantity)
        {
            try
            {
                if (newQuantity < 1)
                {
                    return Json(new { success = false, message = "تعداد نمی‌تواند کمتر از 1 باشد" });
                }

                var cartItems = await GetCartItemsAsync();
                var cartItem = cartItems.FirstOrDefault(item => item.CartItemID == cartItemId);

                if (cartItem == null)
                {
                    return Json(new { success = false, message = "آیتم سبد خرید یافت نشد" });
                }

                var product = await _context.Products.FindAsync(cartItem.ProductID);
                if (product == null)
                {
                    return Json(new { success = false, message = "محصول یافت نشد" });
                }

                // بررسی موجودی
                if (newQuantity > product.StockQuantity + cartItem.Quantity)
                {
                    return Json(new { success = false, message = "تعداد انتخابی بیشتر از موجودی است" });
                }

                cartItem.Quantity = newQuantity;
                await SaveCartItemsAsync(cartItems);

                var totalAmount = cartItems.Sum(item => (item.Product?.Price ?? 0) * item.Quantity);
                var totalItems = cartItems.Sum(item => item.Quantity);
                var itemTotal = (product.Price * newQuantity);

                return Json(new
                {
                    success = true,
                    totalAmount = totalAmount,
                    totalItems = totalItems,
                    itemTotal = itemTotal
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در به روزرسانی تعداد: {ex.Message}");
                return Json(new { success = false, message = "خطا در به روزرسانی تعداد" });
            }
        }

        // POST: Cart/RemoveFromCart - حذف آیتم از سبد خرید
        [HttpPost]
        public async Task<IActionResult> RemoveFromCart(int cartItemId)
        {
            try
            {
                var cartItems = await GetCartItemsAsync();
                var cartItem = cartItems.FirstOrDefault(item => item.CartItemID == cartItemId);

                if (cartItem != null)
                {
                    cartItems.Remove(cartItem);
                    await SaveCartItemsAsync(cartItems);

                    var totalAmount = cartItems.Sum(item => (item.Product?.Price ?? 0) * item.Quantity);
                    var totalItems = cartItems.Sum(item => item.Quantity);

                    return Json(new
                    {
                        success = true,
                        message = "محصول از سبد خرید حذف شد",
                        totalAmount = totalAmount,
                        totalItems = totalItems
                    });
                }

                return Json(new { success = false, message = "آیتم سبد خرید یافت نشد" });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در حذف از سبد خرید: {ex.Message}");
                return Json(new { success = false, message = "خطا در حذف از سبد خرید" });
            }
        }

        // GET: Cart/GetCartItemCount - دریافت تعداد آیتم‌های سبد خرید
        [HttpGet]
        public async Task<IActionResult> GetCartItemCount()
        {
            try
            {
                var cartItems = await GetCartItemsAsync();
                var count = cartItems.Sum(item => item.Quantity);

                return Json(new { count = count });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در دریافت تعداد سبد خرید: {ex.Message}");
                return Json(new { count = 0 });
            }
        }

        // GET: Cart/GetCartQuantities - دریافت تعدادهای سبد خرید برای محصولات
        [HttpGet]
        public async Task<IActionResult> GetCartQuantities()
        {
            try
            {
                var cartItems = await GetCartItemsAsync();
                var quantities = new Dictionary<int, int>();

                foreach (var item in cartItems)
                {
                    quantities[item.ProductID] = item.Quantity;
                }

                return Json(quantities);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در دریافت تعدادهای سبد خرید: {ex.Message}");
                return Json(new Dictionary<int, int>());
            }
        }

        // انتقال سبد خرید مهمان به کاربر پس از لاگین
        public async Task TransferGuestCartToUser(int userId)
        {
            try
            {
                Console.WriteLine($"شروع انتقال سبد خرید مهمان به کاربر {userId}");

                var guestCartItems = await GetCartItemsAsync();

                if (!guestCartItems.Any())
                {
                    Console.WriteLine("سبد خرید مهمان خالی است - انتقالی انجام نشد");
                    return;
                }

                Console.WriteLine($"تعداد آیتم‌های سبد خرید مهمان: {guestCartItems.Count}");

                var userCart = await _context.Carts
                    .Include(c => c.CartItems)
                    .ThenInclude(ci => ci.Product)
                    .FirstOrDefaultAsync(c => c.UserID == userId && c.IsActive);

                if (userCart == null)
                {
                    userCart = new Cart
                    {
                        UserID = userId,
                        IsActive = true
                    };
                    _context.Carts.Add(userCart);
                    await _context.SaveChangesAsync();
                    Console.WriteLine($"سبد خرید جدید برای کاربر {userId} ایجاد شد");
                }

                foreach (var guestItem in guestCartItems)
                {
                    var existingItem = userCart.CartItems.FirstOrDefault(ci => ci.ProductID == guestItem.ProductID);

                    if (existingItem != null)
                    {
                        existingItem.Quantity += guestItem.Quantity;
                    }
                    else
                    {
                        var newCartItem = new CartItem
                        {
                            CartID = userCart.CartID,
                            ProductID = guestItem.ProductID,
                            Quantity = guestItem.Quantity,
                            AddedAt = DateTime.Now
                        };
                        _context.CartItems.Add(newCartItem);
                    }
                }

                await _context.SaveChangesAsync();
                ClearGuestCart();
                await SaveUserCartToSessionAsync(userId);

                Console.WriteLine($"سبد خرید مهمان با {guestCartItems.Count} آیتم به کاربر {userId} انتقال یافت");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در انتقال سبد خرید مهمان: {ex.Message}");
            }
        }

        // ذخیره سبد خرید کاربر در سشن
        private async Task SaveUserCartToSessionAsync(int userId)
        {
            try
            {
                var userCart = await _context.Carts
                    .Include(c => c.CartItems)
                    .ThenInclude(ci => ci.Product)
                    .FirstOrDefaultAsync(c => c.UserID == userId && c.IsActive);

                if (userCart != null)
                {
                    var cartItemsForSession = userCart.CartItems.Select(ci => new CartItemViewModel
                    {
                        CartItemID = ci.CartItemID,
                        ProductID = ci.ProductID,
                        Quantity = ci.Quantity,
                        Product = ci.Product
                    }).ToList();

                    await SaveCartItemsAsync(cartItemsForSession);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در ذخیره سبد خرید کاربر در سشن: {ex.Message}");
            }
        }

        // توابع کمکی برای مدیریت سبد خرید در سشن
        private async Task<List<CartItemViewModel>> GetCartItemsAsync()
        {
            var sessionKey = GetCartSessionKey();
            var cartJson = HttpContext.Session.GetString(sessionKey);

            if (string.IsNullOrEmpty(cartJson))
            {
                return new List<CartItemViewModel>();
            }

            try
            {
                var cartItems = JsonSerializer.Deserialize<List<CartItemViewModel>>(cartJson, JsonOptions);

                // این قسمت حیاتی است - بارگذاری محصولات از دیتابیس
                if (cartItems != null && cartItems.Any())
                {
                    var productIds = cartItems.Select(item => item.ProductID).Distinct().ToList();

                    // بارگذاری محصولات از دیتابیس
                    var products = await _context.Products
                        .Include(p => p.Category)
                        .Where(p => productIds.Contains(p.ProductID))
                        .ToListAsync();

                    // ایجاد دیکشنری برای دسترسی سریع
                    var productDict = products.ToDictionary(p => p.ProductID, p => p);

                    // تخصیص محصولات به آیتم‌های سبد خرید
                    foreach (var item in cartItems)
                    {
                        if (productDict.TryGetValue(item.ProductID, out var product))
                        {
                            item.Product = product;
                            Console.WriteLine($"محصول بارگذاری شد: {product.ProductName} - برند: {product.Brand} - قیمت: {product.Price:N0}");
                        }
                        else
                        {
                            Console.WriteLine($"محصول با شناسه {item.ProductID} در دیتابیس یافت نشد");
                            // ایجاد محصول موقت برای جلوگیری از خطا
                            item.Product = new Product
                            {
                                ProductID = item.ProductID,
                                ProductName = "محصول یافت نشد",
                                Brand = "نامشخص",
                                Price = 0,
                                StockQuantity = 0
                            };
                        }
                    }

                    Console.WriteLine($"اطلاعات {products.Count} محصول از دیتابیس بارگذاری شد");
                }

                return cartItems ?? new List<CartItemViewModel>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در بارگذاری سبد خرید: {ex.Message}");
                return new List<CartItemViewModel>();
            }
        }

        private async Task SaveCartItemsAsync(List<CartItemViewModel> cartItems)
        {
            var sessionKey = GetCartSessionKey();

            // فقط اطلاعات اصلی را ذخیره کن
            var itemsToSave = cartItems.Select(item => new CartItemViewModel
            {
                CartItemID = item.CartItemID,
                ProductID = item.ProductID,
                Quantity = item.Quantity
            }).ToList();

            var cartJson = JsonSerializer.Serialize(itemsToSave, JsonOptions);
            HttpContext.Session.SetString(sessionKey, cartJson);
            await HttpContext.Session.CommitAsync();
        }

        private void ClearGuestCart()
        {
            var sessionKey = GetCartSessionKey();
            HttpContext.Session.Remove(sessionKey);
            HttpContext.Session.Remove("GuestID");
        }

        private string GetCartSessionKey()
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (!string.IsNullOrEmpty(userID))
            {
                return $"Cart_{userID}";
            }

            var guestID = HttpContext.Session.GetString("GuestID");
            if (string.IsNullOrEmpty(guestID))
            {
                guestID = Guid.NewGuid().ToString();
                HttpContext.Session.SetString("GuestID", guestID);
            }

            return $"GuestCart_{guestID}";
        }
    }

    // ViewModel برای نمایش آیتم‌های سبد خرید
    public class CartItemViewModel
    {
        public int CartItemID { get; set; }
        public int ProductID { get; set; }
        public int Quantity { get; set; }
        public Product? Product { get; set; }
    }
}

-----------------------------------------------------------------------------------------
D:\MyShopProject\Controllers\HomeController.cs

using System.Diagnostics;
using Microsoft.AspNetCore.Mvc;
using MyShopProject.Models;

namespace MyShopProject.Controllers
{
    public class HomeController : Controller
    {
        private readonly ILogger<HomeController> _logger;

        public HomeController(ILogger<HomeController> logger)
        {
            _logger = logger;
        }

        public IActionResult Index()
        {
            return View();
        }

        public IActionResult Privacy()
        {
            return View();
        }

        [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
        public IActionResult Error()
        {
            return View(new DateTimeExtensions { RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier });
        }
    }
}


-----------------------------------------------------------------------------------------
D:\MyShopProject\Controllers\OrderController.cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;
using System.Globalization;
using System.Text.Json;
using System.Text.Encodings.Web;
using System.Text.Unicode;

namespace MyShopProject.Controllers
{
    public class OrderController : Controller
    {
        private readonly AppDbContext _context;
        private static readonly JsonSerializerOptions JsonOptions = new()
        {
            Encoder = JavaScriptEncoder.Create(UnicodeRanges.BasicLatin, UnicodeRanges.Arabic),
            PropertyNamingPolicy = null,
            WriteIndented = true
        };

        public OrderController(AppDbContext context)
        {
            _context = context;
        }

        // GET: Order/Index - صفحه اصلی سفارشات
        public async Task<IActionResult> Index()
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
            {
                TempData["ErrorMessage"] = "لطفاً ابتدا وارد شوید";
                return RedirectToAction("Login", "Account");
            }
            var orders = await _context.Orders
                .Where(o => o.UserID == int.Parse(userID))
                .OrderByDescending(o => o.OrderDate)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .ToListAsync();
            var orderViewModels = orders.Select(o => new OrderViewModel
            {
                OrderID = o.OrderID,
                OrderNumber = o.OrderNumber,
                OrderDate = o.OrderDate,
                TotalAmount = o.TotalAmount,
                Status = GetStatusDisplay(o.Status),
                StatusColor = GetStatusColor(o.Status),
                StatusIcon = GetStatusIcon(o.Status),
                ItemCount = o.OrderItems.Sum(oi => oi.Quantity),
                ShippingAddress = o.ShippingAddress ?? "",
                ShippingPostalCode = o.ShippingPostalCode ?? "",
                ContactPhone = o.ContactPhone ?? "",
                OrderDatePersian = ConvertToPersianDate(o.OrderDate),
                OrderItems = o.OrderItems.Select(oi => new OrderItemViewModel
                {
                    ProductName = oi.Product?.ProductName ?? "محصول حذف شده",
                    Brand = oi.Product?.Brand ?? "",
                    ImageUrl = oi.Product?.ImageUrl,
                    Quantity = oi.Quantity,
                    UnitPrice = oi.UnitPrice,
                    TotalPrice = oi.TotalPrice
                }).ToList()
            }).ToList();
            return View(orderViewModels);
        }

        // GET: Order/Details/5 - جزئیات سفارش
        public async Task<IActionResult> Details(int id)
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
            {
                TempData["ErrorMessage"] = "لطفاً ابتدا وارد شوید";
                return RedirectToAction("Login", "Account");
            }
            var order = await _context.Orders
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .FirstOrDefaultAsync(o => o.OrderID == id && o.UserID == int.Parse(userID));
            if (order == null)
            {
                TempData["ErrorMessage"] = "سفارش یافت نشد";
                return RedirectToAction("Index");
            }
            var orderViewModel = new OrderViewModel
            {
                OrderID = order.OrderID,
                OrderNumber = order.OrderNumber,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                Status = GetStatusDisplay(order.Status),
                StatusColor = GetStatusColor(order.Status),
                StatusIcon = GetStatusIcon(order.Status),
                ItemCount = order.OrderItems.Sum(oi => oi.Quantity),
                ShippingAddress = order.ShippingAddress ?? "",
                ShippingPostalCode = order.ShippingPostalCode ?? "",
                ContactPhone = order.ContactPhone ?? "",
                OrderDatePersian = ConvertToPersianDate(order.OrderDate),
                OrderItems = order.OrderItems.Select(oi => new OrderItemViewModel
                {
                    ProductName = oi.Product?.ProductName ?? "محصول حذف شده",
                    Brand = oi.Product?.Brand ?? "",
                    ImageUrl = oi.Product?.ImageUrl,
                    Quantity = oi.Quantity,
                    UnitPrice = oi.UnitPrice,
                    TotalPrice = oi.TotalPrice
                }).ToList()
            };
            return View(orderViewModel);
        }

        // GET: Order/CreateFromCart - ایجاد سفارش جدید از سبد خرید (از Session)
        public async Task<IActionResult> CreateFromCart()
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
            {
                TempData["ErrorMessage"] = "لطفاً ابتدا وارد شوید";
                return RedirectToAction("Login", "Account", new { returnUrl = Url.Action("CreateFromCart", "Order") });
            }
            var cartItems = await GetCartItemsFromSessionAsync();
            if (!cartItems.Any())
            {
                TempData["ErrorMessage"] = "سبد خرید شما خالی است";
                return RedirectToAction("Index", "Cart");
            }
            var user = await _context.Users.FindAsync(int.Parse(userID));
            var viewModel = new CheckoutViewModel
            {
                ShippingAddress = user?.Address ?? "",
                ShippingPostalCode = user?.PostalCode ?? "",
                ContactPhone = user?.PhoneNumber ?? "",
                CartItems = cartItems,
                TotalAmount = cartItems.Sum(ci => ci.Quantity * (ci.Product?.Price ?? 0)),
                TotalItems = cartItems.Sum(ci => ci.Quantity),
                UserFullName = $"{user?.FirstName} {user?.LastName}".Trim(),
                CurrentDatePersian = ConvertToPersianDate(DateTime.Now)
            };
            return View("Checkout", viewModel);
        }

        // POST: Order/CreateFromCart - ثبت سفارش از سبد خرید (از Session)
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CreateFromCart(CheckoutViewModel model)
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
            {
                TempData["ErrorMessage"] = "لطفاً ابتدا وارد شوید";
                return RedirectToAction("Login", "Account");
            }

            if (!ModelState.IsValid)
            {
                await ReloadCartAndUser(model, userID);
                return View("Checkout", model);
            }

            // شبیه‌سازی پرداخت
            if (!SimulatePayment(model))
            {
                ModelState.AddModelError("", "اطلاعات کارت اشتباه است. لطفاً دوباره تلاش کنید.");
                await ReloadCartAndUser(model, userID);
                return View("Checkout", model);
            }

            try
            {
                var cartItems = await GetCartItemsFromSessionAsync();
                if (!cartItems.Any())
                {
                    TempData["ErrorMessage"] = "سبد خرید شما خالی است";
                    return RedirectToAction("Index", "Cart");
                }

                // بررسی موجودی
                foreach (var item in cartItems)
                {
                    if (item.Product == null || item.Product.StockQuantity < item.Quantity)
                    {
                        TempData["ErrorMessage"] = $"موجودی محصول {item.Product?.ProductName ?? "نامشخص"} کافی نیست.";
                        await ReloadCartAndUser(model, userID);
                        return View("Checkout", model);
                    }
                }

                // ایجاد سفارش
                var order = new Order
                {
                    UserID = int.Parse(userID),
                    OrderDate = DateTime.Now,
                    TotalAmount = cartItems.Sum(ci => ci.Quantity * ci.Product.Price),
                    Status = OrderStatus.Pending,
                    ShippingAddress = model.ShippingAddress,
                    ShippingPostalCode = model.ShippingPostalCode,
                    ContactPhone = model.ContactPhone,
                    OrderNote = model.OrderNote
                };

                foreach (var item in cartItems)
                {
                    var orderItem = new OrderItem
                    {
                        ProductID = item.ProductID,
                        Quantity = item.Quantity,
                        UnitPrice = item.Product.Price,
                        TotalPrice = item.Quantity * item.Product.Price
                    };
                    order.OrderItems.Add(orderItem);
                    item.Product.StockQuantity -= item.Quantity;
                }

                _context.Orders.Add(order);
                await _context.SaveChangesAsync();

                var customTrackingId = GenerateCustomTrackingId(order.OrderID);
                order.Status = OrderStatus.Paid;
                order.OrderNumber = customTrackingId;
                await _context.SaveChangesAsync();

                ClearCartFromSession();

                return RedirectToAction("Success", new { orderId = order.OrderID, trackingId = customTrackingId });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در ایجاد سفارش: {ex.Message}");
                TempData["ErrorMessage"] = "خطا در ثبت سفارش. لطفاً دوباره تلاش کنید.";
                await ReloadCartAndUser(model, userID);
                return View("Checkout", model);
            }
        }

        // GET: Order/Success - صفحه موفقیت پرداخت
        public async Task<IActionResult> Success(int orderId, string trackingId)
        {
            var order = await _context.Orders
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .FirstOrDefaultAsync(o => o.OrderID == orderId);
            if (order == null)
            {
                TempData["ErrorMessage"] = "سفارش یافت نشد";
                return RedirectToAction("Index", "Cart");
            }
            ViewBag.TrackingId = trackingId;
            ViewBag.TotalAmount = order.TotalAmount.ToString("N0");
            ViewBag.OrderDatePersian = ConvertToPersianDate(order.OrderDate);
            return View();
        }

        // POST: Order/Cancel/5 - لغو سفارش
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Cancel(int id)
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (string.IsNullOrEmpty(userID))
            {
                TempData["ErrorMessage"] = "لطفاً ابتدا وارد شوید";
                return RedirectToAction("Login", "Account");
            }
            try
            {
                var order = await _context.Orders
                    .Include(o => o.OrderItems)
                    .ThenInclude(oi => oi.Product)
                    .FirstOrDefaultAsync(o => o.OrderID == id && o.UserID == int.Parse(userID));
                if (order == null)
                {
                    TempData["ErrorMessage"] = "سفارش یافت نشد";
                    return RedirectToAction("Index");
                }
                if (order.Status != OrderStatus.Pending && order.Status != OrderStatus.Paid)
                {
                    TempData["ErrorMessage"] = "امکان لغو این سفارش وجود ندارد";
                    return RedirectToAction("Details", new { id = id });
                }
                foreach (var orderItem in order.OrderItems)
                {
                    if (orderItem.Product != null)
                    {
                        orderItem.Product.StockQuantity += orderItem.Quantity;
                    }
                }
                order.Status = OrderStatus.Cancelled;
                order.UpdatedAt = DateTime.Now;
                await _context.SaveChangesAsync();
                TempData["SuccessMessage"] = "سفارش با موفقیت لغو شد";
                return RedirectToAction("Details", new { id = id });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در لغو سفارش: {ex.Message}");
                TempData["ErrorMessage"] = "خطا در لغو سفارش. لطفاً دوباره تلاش کنید.";
                return RedirectToAction("Details", new { id = id });
            }
        }

        // --- توابع کمکی ---
        private string GetStatusDisplay(OrderStatus status) => status switch
        {
            OrderStatus.Pending => "در انتظار پرداخت",
            OrderStatus.Paid => "پرداخت شده",
            OrderStatus.Processing => "در حال پردازش",
            OrderStatus.Shipped => "ارسال شده",
            OrderStatus.Delivered => "تحویل شده",
            OrderStatus.Cancelled => "لغو شده",
            _ => "نامشخص"
        };

        private string GetStatusColor(OrderStatus status) => status switch
        {
            OrderStatus.Pending => "warning",
            OrderStatus.Paid => "info",
            OrderStatus.Processing => "primary",
            OrderStatus.Shipped => "success",
            OrderStatus.Delivered => "dark",
            OrderStatus.Cancelled => "danger",
            _ => "secondary"
        };

        private string GetStatusIcon(OrderStatus status) => status switch
        {
            OrderStatus.Pending => "bi-clock",
            OrderStatus.Paid => "bi-credit-card",
            OrderStatus.Processing => "bi-gear",
            OrderStatus.Shipped => "bi-truck",
            OrderStatus.Delivered => "bi-check-circle",
            OrderStatus.Cancelled => "bi-x-circle",
            _ => "bi-question-circle"
        };

        private string ConvertToPersianDate(DateTime date)
        {
            try
            {
                var persianCalendar = new PersianCalendar();
                return $"{persianCalendar.GetYear(date)}/{persianCalendar.GetMonth(date):00}/{persianCalendar.GetDayOfMonth(date):00}";
            }
            catch
            {
                return date.ToString("yyyy/MM/dd");
            }
        }

        private string GenerateCustomTrackingId(int orderId)
        {
            var date = DateTime.Now.ToString("yyyyMMdd");
            var counter = _context.Orders.Count(o => o.OrderDate.Date == DateTime.Today) + 1;
            return $"MYSHOP-ORD-{date}-{counter:D3}";
        }

        // --- توابع جدید برای کار با Session ---
        private async Task<List<CartItemViewModel>> GetCartItemsFromSessionAsync()
        {
            var sessionKey = GetCartSessionKey();
            var cartJson = HttpContext.Session.GetString(sessionKey);
            if (string.IsNullOrEmpty(cartJson))
            {
                return new List<CartItemViewModel>();
            }
            try
            {
                var cartItems = JsonSerializer.Deserialize<List<CartItemViewModel>>(cartJson, JsonOptions);
                if (cartItems != null && cartItems.Any())
                {
                    var productIds = cartItems.Select(item => item.ProductID).Distinct().ToList();
                    var products = await _context.Products
                        .Include(p => p.Category)
                        .Where(p => productIds.Contains(p.ProductID))
                        .ToListAsync();
                    var productDict = products.ToDictionary(p => p.ProductID, p => p);
                    foreach (var item in cartItems)
                    {
                        if (productDict.TryGetValue(item.ProductID, out var product))
                        {
                            item.Product = product;
                        }
                        else
                        {
                            item.Product = new Product
                            {
                                ProductID = item.ProductID,
                                ProductName = "محصول یافت نشد",
                                Brand = "نامشخص",
                                Price = 0,
                                StockQuantity = 0
                            };
                        }
                    }
                }
                return cartItems ?? new List<CartItemViewModel>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در بارگذاری سبد خرید از سشن: {ex.Message}");
                return new List<CartItemViewModel>();
            }
        }

        private void ClearCartFromSession()
        {
            var sessionKey = GetCartSessionKey();
            HttpContext.Session.Remove(sessionKey);
        }

        private string GetCartSessionKey()
        {
            var userID = HttpContext.Session.GetString("UserID");
            if (!string.IsNullOrEmpty(userID))
            {
                return $"Cart_{userID}";
            }
            var guestID = HttpContext.Session.GetString("GuestID");
            if (string.IsNullOrEmpty(guestID))
            {
                guestID = Guid.NewGuid().ToString();
                HttpContext.Session.SetString("GuestID", guestID);
            }
            return $"GuestCart_{guestID}";
        }

        // --- متد جدید: شبیه‌سازی پرداخت ---
        private bool SimulatePayment(CheckoutViewModel model)
        {
            return model.CardNumber == "6037997012345678" &&
                   model.Password == "1234" &&
                   model.CVV2 == "123" &&
                   model.ExpiryDate == "12/28";
        }

        // --- متد کمکی برای بارگذاری مجدد سبد و کاربر ---
        private async Task ReloadCartAndUser(CheckoutViewModel model, string userID)
        {
            var cartItems = await GetCartItemsFromSessionAsync();
            var user = await _context.Users.FindAsync(int.Parse(userID));

            model.CartItems = cartItems;
            model.TotalAmount = cartItems.Sum(ci => ci.Quantity * (ci.Product?.Price ?? 0));
            model.TotalItems = cartItems.Sum(ci => ci.Quantity);
            model.UserFullName = $"{user?.FirstName} {user?.LastName}".Trim();
            model.CurrentDatePersian = ConvertToPersianDate(DateTime.Now);
        }
    }
}
--------------------------------------------------------------------------------------------

D:\MyShopProject\Controllers\ProductsController.cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;

namespace MyShopProject.Controllers
{
    public class ProductsController : Controller
    {
        private readonly AppDbContext _context;

        public ProductsController(AppDbContext context)
        {
            _context = context;
        }

        // --- متد نرمال‌سازی قوی ---
        private static string NormalizePersian(string input)
        {
            if (string.IsNullOrEmpty(input))
                return input;

            return input
                .Replace('\u064A', '\u06CC') // ي → ی
                .Replace('\u0643', '\u06A9') // ك → ک
                .Replace('\u200C', ' ')     // ZWNJ → فاصله
                .Replace('\u200D', ' ')     // ZWJ → فاصله
                .Replace('\u2060', ' ')     // Word Joiner → فاصله
                .Replace('\u00AD', ' ')     // Soft Hyphen → فاصله
                .Replace("  ", " ")
                .Trim();
        }

        // GET: Products/Index
        public async Task<IActionResult> Index()
        {
            try
            {
                var products = await _context.Products
                    .Include(p => p.Category)
                    .Where(p => p.StockQuantity > 0)
                    .ToListAsync();

                var userID = HttpContext.Session.GetString("UserID");
                if (!string.IsNullOrEmpty(userID))
                {
                    ViewBag.UserName = HttpContext.Session.GetString("Name");
                    ViewBag.UserRole = HttpContext.Session.GetString("Role");
                    ViewBag.IsLoggedIn = true;
                }
                else
                {
                    ViewBag.IsLoggedIn = false;
                }

                if (TempData["SuccessMessage"] != null)
                {
                    ViewBag.SuccessMessage = TempData["SuccessMessage"];
                }

                return View(products);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در بارگذاری محصولات: {ex.Message}");
                TempData["ErrorMessage"] = "خطا در بارگذاری محصولات";
                return View(new List<Product>());
            }
        }

        // GET: Products/Details/5
        public async Task<IActionResult> Details(int? id)
        {
            if (id == null) return NotFound();

            var product = await _context.Products
                .Include(p => p.Category)
                .FirstOrDefaultAsync(m => m.ProductID == id);

            if (product == null) return NotFound();

            var userID = HttpContext.Session.GetString("UserID");
            if (!string.IsNullOrEmpty(userID))
            {
                ViewBag.UserName = HttpContext.Session.GetString("Name");
                ViewBag.IsLoggedIn = true;
            }
            else
            {
                ViewBag.IsLoggedIn = false;
            }

            return View(product);
        }

        // GET: /Products/Search?query=...
        [HttpGet]
        public async Task<IActionResult> Search(string query)
        {
            if (string.IsNullOrWhiteSpace(query) || query.Length < 2)
                return Json(new List<object>());

            var normalizedQuery = NormalizePersian(query).ToLower();

            try
            {
                // تمام محصولات موجود رو بکش
                var allProducts = await _context.Products
                    .Where(p => p.StockQuantity > 0)
                    .Select(p => new
                    {
                        p.ProductID,
                        ProductName = NormalizePersian(p.ProductName ?? "").ToLower(),
                        Brand = NormalizePersian(p.Brand ?? "").ToLower(),
                        Description = NormalizePersian(p.Description ?? "").ToLower(),
                        p.Price,
                        p.ImageUrl,
                        OriginalName = p.ProductName,
                        OriginalBrand = p.Brand,
                        OriginalDescription = p.Description
                    })
                    .ToListAsync();

                var results = new List<object>();
                var seenIds = new HashSet<int>();

                foreach (var p in allProducts)
                {
                    if (seenIds.Contains(p.ProductID)) continue;

                    string matchText = "";
                    string matchField = "";

                    if (p.ProductName.Contains(normalizedQuery))
                    {
                        matchText = ExtractMatch(p.OriginalName, query);
                        matchField = "نام محصول";
                    }
                    else if (p.Brand.Contains(normalizedQuery))
                    {
                        matchText = ExtractMatch(p.OriginalBrand, query);
                        matchField = "برند";
                    }
                    else if (p.Description.Contains(normalizedQuery))
                    {
                        matchText = ExtractMatch(p.OriginalDescription, query);
                        matchField = "توضیحات";
                    }

                    if (!string.IsNullOrEmpty(matchText) && seenIds.Add(p.ProductID) && results.Count < 10)
                    {
                        results.Add(new
                        {
                            id = p.ProductID,
                            productName = p.OriginalName,
                            price = p.Price,
                            imageUrl = p.ImageUrl ?? "/images/no-image.png",
                            matchText,
                            matchField
                        });
                    }

                    if (results.Count >= 10) break;
                }

                return Json(results);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"خطا در جستجو: {ex.Message}");
                return Json(new List<object>());
            }
        }

        // --- استخراج متن اطراف مچ ---
        private static string ExtractMatch(string text, string query)
        {
            if (string.IsNullOrEmpty(text)) return "";

            var normalizedText = NormalizePersian(text).ToLower();
            var normalizedQuery = NormalizePersian(query).ToLower();

            int index = normalizedText.IndexOf(normalizedQuery);
            if (index == -1) return "";

            int start = Math.Max(0, index - 15);
            int end = Math.Min(text.Length, index + normalizedQuery.Length + 15);

            string before = start > 0 ? "..." : "";
            string after = end < text.Length ? "..." : "";

            return before + text.Substring(start, end - start) + after;
        }
    }
}
-------------------------------------------------------------------------------------------------
D:\MyShopProject\Extensions\DateTimeExtensions.cs

using System;
using System.Globalization;

namespace MyShopProject.Extensions
{
    public static class DateTimeExtensions
    {
        public static string ToPersianDate(this DateTime date)
        {
            try
            {
                PersianCalendar pc = new PersianCalendar();
                return $"{pc.GetYear(date)}/{pc.GetMonth(date):D2}/{pc.GetDayOfMonth(date):D2}";
            }
            catch
            {
                return date.ToString("yyyy/MM/dd");
            }
        }
    }
}

--------------------------------------------------------------------------------------------------

D:\MyShopProject\Models\ViewModels\ProfileViewModel.cs

using System.ComponentModel.DataAnnotations;

namespace MyShopProject.Models
{
    public class ProfileViewModel
    {
        public int UserID { get; set; }

        [Required(ErrorMessage = "ایمیل الزامی است")]
        [EmailAddress(ErrorMessage = "فرمت ایمیل نامعتبر است")]
        public string? Email { get; set; }

        [Required(ErrorMessage = "نام الزامی است")]
        [Display(Name = "نام")]
        public string? FirstName { get; set; }

        [Required(ErrorMessage = "نام خانوادگی الزامی است")]
        [Display(Name = "نام خانوادگی")]
        public string? LastName { get; set; }

        [Display(Name = "شماره تلفن")]
        public string? PhoneNumber { get; set; }

        [Required(ErrorMessage = "کد پستی الزامی است")]
        [Display(Name = "کد پستی")]
        public string? PostalCode { get; set; }

        [Required(ErrorMessage = "استان الزامی است")]
        [Display(Name = "استان")]
        public string? Province { get; set; } = string.Empty;

        [Required(ErrorMessage = "ادامه آدرس الزامی است")]
        [Display(Name = "ادامه آدرس")]
        public string? DetailedAddress { get; set; } = string.Empty;

        [Required(ErrorMessage = "آدرس الزامی است")]
        [Display(Name = "آدرس")]
        public string? Address { get; set; }

        [Display(Name = "تاریخ عضویت")]
        public DateTime CreatedAt { get; set; }

        [Display(Name = "نقش کاربری")]
        public string? Role { get; set; }
    }

    public class ChangePasswordViewModel
    {
        [Required(ErrorMessage = "رمز عبور فعلی الزامی است")]
        [DataType(DataType.Password)]
        [Display(Name = "رمز عبور فعلی")]
        public string? CurrentPassword { get; set; }

        [Required(ErrorMessage = "رمز عبور جدید الزامی است")]
        [StringLength(100, ErrorMessage = "رمز عبور باید حداقل 6 کاراکتر باشد", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "رمز عبور جدید")]
        public string? NewPassword { get; set; }

        [DataType(DataType.Password)]
        [Display(Name = "تکرار رمز عبور جدید")]
        [Compare("NewPassword", ErrorMessage = "رمز عبور و تکرار آن مطابقت ندارند")]
        public string? ConfirmPassword { get; set; }
    }
}

--------------------------------------------------------------------------------------

D:\MyShopProject\Models\AppDbContext.cs

using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;

namespace MyShopProject.Models
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options)
        {
        }

        public DbSet<Product> Products { get; set; } = null!;
        public DbSet<Category> Categories { get; set; } = null!;
        public DbSet<User> Users { get; set; } = null!;
        public DbSet<Cart> Carts { get; set; } = null!;
        public DbSet<CartItem> CartItems { get; set; } = null!;
        public DbSet<Order> Orders { get; set; } = null!;
        public DbSet<OrderItem> OrderItems { get; set; } = null!;

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            // تنظیم دقیق نوع دیتابیس برای فیلد Price
            modelBuilder.Entity<Product>()
                .Property(p => p.Price)
                .HasColumnType("decimal(18,2)");

            modelBuilder.Entity<Order>()
                .Property(o => o.TotalAmount)
                .HasColumnType("decimal(18,2)");

            modelBuilder.Entity<OrderItem>()
                .Property(oi => oi.UnitPrice)
                .HasColumnType("decimal(18,2)");

            modelBuilder.Entity<OrderItem>()
                .Property(oi => oi.TotalPrice)
                .HasColumnType("decimal(18,2)");

            // تنظیم رابطه بین Product و Category
            modelBuilder.Entity<Product>()
                .HasOne(p => p.Category)
                .WithMany(c => c.Products)
                .HasForeignKey(p => p.CategoryID)
                .OnDelete(DeleteBehavior.Restrict);

            // تنظیم رابطه بین Cart و User
            modelBuilder.Entity<Cart>()
                .HasOne(c => c.User)
                .WithMany()
                .HasForeignKey(c => c.UserID)
                .OnDelete(DeleteBehavior.Cascade);

            // تنظیم رابطه بین CartItem و Cart
            modelBuilder.Entity<CartItem>()
                .HasOne(ci => ci.Cart)
                .WithMany(c => c.CartItems)
                .HasForeignKey(ci => ci.CartID)
                .OnDelete(DeleteBehavior.Cascade);

            // تنظیم رابطه بین CartItem و Product
            modelBuilder.Entity<CartItem>()
                .HasOne(ci => ci.Product)
                .WithMany()
                .HasForeignKey(ci => ci.ProductID)
                .OnDelete(DeleteBehavior.Restrict);

            // تنظیم رابطه بین Order و User
            modelBuilder.Entity<Order>()
                .HasOne(o => o.User)
                .WithMany()
                .HasForeignKey(o => o.UserID)
                .OnDelete(DeleteBehavior.Cascade);

            // تنظیم رابطه بین OrderItem و Order
            modelBuilder.Entity<OrderItem>()
                .HasOne(oi => oi.Order)
                .WithMany(o => o.OrderItems)
                .HasForeignKey(oi => oi.OrderID)
                .OnDelete(DeleteBehavior.Cascade);

            // تنظیم رابطه بین OrderItem و Product
            modelBuilder.Entity<OrderItem>()
                .HasOne(oi => oi.Product)
                .WithMany()
                .HasForeignKey(oi => oi.ProductID)
                .OnDelete(DeleteBehavior.Restrict);

            // تنظیم مقدار پیش‌فرض برای موجودی
            modelBuilder.Entity<Product>()
                .Property(p => p.StockQuantity)
                .HasDefaultValue(0);

            base.OnModelCreating(modelBuilder);
        }
    }
}

---------------------------------------------------------------------------------------

D:\MyShopProject\Models\Cart.cs

namespace MyShopProject.Models
{
    public class Cart
    {
        public int CartID { get; set; }
        public int UserID { get; set; }
        public bool IsActive { get; set; } = true;

        public User User { get; set; } = null!;
        public ICollection<CartItem> CartItems { get; set; } = new List<CartItem>(); // اینجا درست شد
    }
}
----------------------------------------------------------------------------------------

D:\MyShopProject\Models\CartItem.cs

namespace MyShopProject.Models
{
    public class CartItem
    {
        public int CartItemID { get; set; }
        public int CartID { get; set; }
        public int ProductID { get; set; }
        public int Quantity { get; set; }
        public DateTime AddedAt { get; set; } = DateTime.Now;

        public Cart Cart { get; set; } = null!;
        public Product Product { get; set; } = null!;
    }
}
-----------------------------------------------------------------------------------------------

D:\MyShopProject\Models\Category.cs

using System.ComponentModel.DataAnnotations;

namespace MyShopProject.Models
{
    public class Category
    {
        public int CategoryID { get; set; }

        [Required(ErrorMessage = "نام دسته‌بندی الزامی است")]
        public string? CategoryName { get; set; }

        public ICollection<Product> Products { get; set; } = new List<Product>();
    }
}

------------------------------------------------------------------------------------------------------

D:\MyShopProject\Models\CheckoutViewModel.cs

using MyShopProject.Controllers;
using MyShopProject.Models;
using System.ComponentModel.DataAnnotations;

namespace MyShopProject.Models
{
    public class CheckoutViewModel
    {
        [Required(ErrorMessage = "آدرس ارسال الزامی است")]
        [Display(Name = "آدرس ارسال")]
        public string ShippingAddress { get; set; } = string.Empty;

        [Required(ErrorMessage = "کد پستی الزامی است")]
        [RegularExpression(@"^\d{10}$", ErrorMessage = "کد پستی باید ۱۰ رقم باشد")]
        [Display(Name = "کد پستی")]
        public string ShippingPostalCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "شماره تماس الزامی است")]
        [Phone(ErrorMessage = "شماره تماس معتبر نیست")]
        [Display(Name = "شماره تماس")]
        public string ContactPhone { get; set; } = string.Empty;

        [Display(Name = "یادداشت سفارش")]
        public string OrderNote { get; set; } = string.Empty;

        // --- فیلدهای پرداخت ---
        [Required(ErrorMessage = "شماره کارت الزامی است")]
        [RegularExpression(@"^\d{16}$", ErrorMessage = "شماره کارت باید ۱۶ رقم باشد")]
        [Display(Name = "شماره کارت (۱۶ رقم)")]
        public string CardNumber { get; set; } = string.Empty;

        [Required(ErrorMessage = "رمز دوم الزامی است")]
        [StringLength(4, MinimumLength = 4, ErrorMessage = "رمز دوم باید ۴ رقم باشد")]
        [RegularExpression(@"^\d{4}$", ErrorMessage = "رمز دوم باید ۴ رقم عددی باشد")]
        [Display(Name = "رمز دوم (۴ رقم)")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "CVV2 الزامی است")]
        [StringLength(3, MinimumLength = 3, ErrorMessage = "CVV2 باید ۳ رقم باشد")]
        [RegularExpression(@"^\d{3}$", ErrorMessage = "CVV2 باید ۳ رقم عددی باشد")]
        [Display(Name = "CVV2 (۳ رقم)")]
        public string CVV2 { get; set; } = string.Empty;

        [Required(ErrorMessage = "تاریخ انقضا الزامی است")]
        [RegularExpression(@"^(0[1-9]|1[0-2])\/[2-9]\d$", ErrorMessage = "تاریخ انقضا باید به فرمت MM/YY و معتبر باشد")]
        [Display(Name = "تاریخ انقضا (MM/YY)")]
        public string ExpiryDate { get; set; } = string.Empty;

        // --- اطلاعات سبد ---
        public List<CartItemViewModel> CartItems { get; set; } = new();
        public decimal TotalAmount { get; set; }
        public int TotalItems { get; set; }
        public string UserFullName { get; set; } = string.Empty;
        public string CurrentDatePersian { get; set; } = string.Empty;
    }
}

-------------------------------------------------------------------------------------------

D:\MyShopProject\Models\ErrorViewModel.cs

namespace MyShopProject.Models
{
    public class DateTimeExtensions
    {
        public string? RequestId { get; set; }

        public bool ShowRequestId => !string.IsNullOrEmpty(RequestId);
    }
}

-------------------------------------------------------------------------------------------------

D:\MyShopProject\Models\Order.cs

using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace MyShopProject.Models
{
    public class Order
    {
        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public int OrderID { get; set; }

        [Required]
        public int UserID { get; set; }

        [Required]
        [Display(Name = "شماره سفارش")]
        public string OrderNumber { get; set; } = GenerateOrderNumber();

        [Required]
        [Display(Name = "تاریخ سفارش")]
        public DateTime OrderDate { get; set; } = DateTime.Now;

        [Required]
        [Display(Name = "مبلغ کل")]
        [Column(TypeName = "decimal(18,2)")]
        public decimal TotalAmount { get; set; }

        [Required]
        [Display(Name = "وضعیت سفارش")]
        public OrderStatus Status { get; set; } = OrderStatus.Pending;

        [Display(Name = "تاریخ به روزرسانی")]
        public DateTime? UpdatedAt { get; set; }

        [Display(Name = "آدرس ارسال")]
        public string? ShippingAddress { get; set; }

        [Display(Name = "کد پستی")]
        public string? ShippingPostalCode { get; set; }

        [Display(Name = "شماره تماس")]
        public string? ContactPhone { get; set; }

        [Display(Name = "یادداشت سفارش")]
        [StringLength(500)]
        public string? OrderNote { get; set; }

        // Navigation Properties
        public User? User { get; set; }
        public List<OrderItem> OrderItems { get; set; } = new List<OrderItem>();

        private static string GenerateOrderNumber()
        {
            return "ORD-" + DateTime.Now.ToString("yyyyMMdd-HHmmss-fff");
        }
    }

    public enum OrderStatus
    {
        [Display(Name = "در انتظار پرداخت")]
        Pending,

        [Display(Name = "پرداخت شده")]
        Paid,

        [Display(Name = "در حال پردازش")]
        Processing,

        [Display(Name = "ارسال شده")]
        Shipped,

        [Display(Name = "تحویل شده")]
        Delivered,

        [Display(Name = "لغو شده")]
        Cancelled
    }
}

-------------------------------------------------------------------------------------------

D:\MyShopProject\Models\OrderItem.cs

using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace MyShopProject.Models
{
    public class OrderItem
    {
        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public int OrderItemID { get; set; }

        [Required]
        public int OrderID { get; set; }

        [Required]
        public int ProductID { get; set; }

        [Required]
        [Display(Name = "تعداد")]
        public int Quantity { get; set; }

        [Required]
        [Display(Name = "قیمت واحد")]
        [Column(TypeName = "decimal(18,2)")]
        public decimal UnitPrice { get; set; }

        [Required]
        [Display(Name = "قیمت کل")]
        [Column(TypeName = "decimal(18,2)")]
        public decimal TotalPrice { get; set; }

        // Navigation Properties
        public Order? Order { get; set; }
        public Product? Product { get; set; }
    }
}---------------------------------------------------------------------------------------------

D:\MyShopProject\Models\OrderViewModel.cs

using System.ComponentModel.DataAnnotations;

namespace MyShopProject.Models
{
    public class OrderViewModel
    {
        public int OrderID { get; set; }

        [Display(Name = "شماره سفارش")]
        public string OrderNumber { get; set; } = string.Empty;

        [Display(Name = "تاریخ سفارش")]
        public DateTime OrderDate { get; set; }

        [Display(Name = "مبلغ کل")]
        public decimal TotalAmount { get; set; }

        [Display(Name = "وضعیت سفارش")]
        public string Status { get; set; } = string.Empty;

        [Display(Name = "رنگ وضعیت")]
        public string StatusColor { get; set; } = string.Empty;

        [Display(Name = "آیکن وضعیت")]
        public string StatusIcon { get; set; } = string.Empty;

        [Display(Name = "تعداد آیتم‌ها")]
        public int ItemCount { get; set; }

        [Display(Name = "آدرس ارسال")]
        public string ShippingAddress { get; set; } = string.Empty;

        [Display(Name = "کد پستی")]
        public string ShippingPostalCode { get; set; } = string.Empty;

        [Display(Name = "شماره تماس")]
        public string ContactPhone { get; set; } = string.Empty;

        public List<OrderItemViewModel> OrderItems { get; set; } = new List<OrderItemViewModel>();

        // تاریخ شمسی
        public string OrderDatePersian { get; set; } = string.Empty;
    }

    public class OrderItemViewModel
    {
        public string ProductName { get; set; } = string.Empty;
        public string Brand { get; set; } = string.Empty;
        public string? ImageUrl { get; set; }
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal TotalPrice { get; set; }
    }

    public class CreateOrderViewModel
    {
        [Required(ErrorMessage = "آدرس ارسال الزامی است")]
        [Display(Name = "آدرس ارسال")]
        public string ShippingAddress { get; set; } = string.Empty;

        [Required(ErrorMessage = "کد پستی الزامی است")]
        [RegularExpression(@"^\d{10}$", ErrorMessage = "کد پستی باید 10 رقم باشد")]
        [Display(Name = "کد پستی")]
        public string ShippingPostalCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "شماره تماس الزامی است")]
        [RegularExpression(@"^09\d{9}$", ErrorMessage = "شماره تماس باید با 09 شروع شده و 11 رقم باشد")]
        [Display(Name = "شماره تماس")]
        public string ContactPhone { get; set; } = string.Empty;

        [Display(Name = "یادداشت سفارش")]
        [StringLength(500, ErrorMessage = "یادداشت نمی‌تواند بیش از 500 کاراکتر باشد")]
        public string? OrderNote { get; set; }
    }
}

------------------------------------------------------------------------------------------------------

D:\MyShopProject\Models\Product.cs

using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace MyShopProject.Models
{
    public class Product
    {
        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public int ProductID { get; set; }

        [Required(ErrorMessage = "نام محصول الزامی است")]
        [StringLength(100, ErrorMessage = "نام محصول نمی‌تواند بیش از 100 کاراکتر باشد")]
        [Display(Name = "نام محصول")]
        public string ProductName { get; set; } = string.Empty;

        [Required(ErrorMessage = "برند محصول الزامی است")]
        [StringLength(50, ErrorMessage = "برند نمی‌تواند بیش از 50 کاراکتر باشد")]
        [Display(Name = "برند")]
        public string Brand { get; set; } = string.Empty;

        [Required(ErrorMessage = "قیمت محصول الزامی است")]
        [Range(0.01, double.MaxValue, ErrorMessage = "قیمت باید بیشتر از صفر باشد")]
        [Display(Name = "قیمت")]
        [Column(TypeName = "decimal(18,2)")]
        public decimal Price { get; set; }

        [StringLength(30, ErrorMessage = "رنگ نمی‌تواند بیش از 30 کاراکتر باشد")]
        [Display(Name = "رنگ")]
        public string? Color { get; set; }

        // فقط ImageUrl نگه داشته می‌شه (ImagePath حذف شد)
        [Display(Name = "مسیر تصویر")]
        public string? ImageUrl { get; set; }

        [StringLength(500, ErrorMessage = "توضیحات نمی‌تواند بیش از 500 کاراکتر باشد")]
        [Display(Name = "توضیحات")]
        public string? Description { get; set; }

        [Required(ErrorMessage = "تعداد موجودی الزامی است")]
        [Range(0, int.MaxValue, ErrorMessage = "تعداد موجودی نمی‌تواند منفی باشد")]
        [Display(Name = "موجودی")]
        public int StockQuantity { get; set; }

        [Required(ErrorMessage = "دسته‌بندی الزامی است")]
        [Display(Name = "دسته‌بندی")]
        public int CategoryID { get; set; }

        [Display(Name = "دسته‌بندی")]
        public Category? Category { get; set; }
    }
}

-----------------------------------------------------------------------------------

D:\MyShopProject\Models\User.cs

using System.ComponentModel.DataAnnotations;

namespace MyShopProject.Models
{
    public class User
    {
        public int UserID { get; set; }

        [Required(ErrorMessage = "ایمیل الزامی است")]
        [EmailAddress(ErrorMessage = "فرمت ایمیل نامعتبر است")]
        public string? Email { get; set; }

        [Required(ErrorMessage = "نام الزامی است")]
        public string? FirstName { get; set; }

        [Required(ErrorMessage = "نام خانوادگی الزامی است")]
        public string? LastName { get; set; }

        public string? PhoneNumber { get; set; }

        [Required(ErrorMessage = "کد پستی الزامی است")]
        public string? PostalCode { get; set; }

        // فیلدهای جدید
        public string? Province { get; set; } = string.Empty;

        public string? DetailedAddress { get; set; } = string.Empty;

        // آدرس ترکیبی (اختیاری — برای نمایش)
        public string? Address { get; set; } = string.Empty;

        public string? PasswordHash { get; set; }

        public DateTime CreatedAt { get; set; }

        public bool IsAdmin { get; set; } = false;
    }
}
-----------------------------------------------------------------------------------------

D:\MyShopProject\Views\Account\ForgotPassword.cshtml

@{
    ViewData["Title"] = "بازیابی رمز عبور";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">بازیابی رمز عبور</h3>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success">
                            @Html.Raw(TempData["SuccessMessage"])
                            <p class="mt-2"><strong>اکنون به صفحه ورود هدایت می‌شوید.</strong></p>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                    }

                    <form asp-action="ForgotPassword" method="post">
                        <div class="form-group mb-3">
                            <label for="email" class="control-label">ایمیل خود را وارد کنید</label>
                            <input name="email" type="email" class="form-control" required
                                   placeholder="example@email.com" />
                            <small class="form-text text-muted">رمز یکبارمصرف به این ایمیل ارسال می‌شود</small>
                        </div>

                        <div class="form-group mb-3">
                            <button type="submit" class="btn btn-primary w-100">ارسال رمز یکبارمصرف</button>
                        </div>
                    </form>

                    <div class="text-center">
                        <a asp-action="Login" class="btn btn-outline-secondary">بازگشت به صفحه ورود</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

-----------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Account\Login.cshtml

@{
    ViewData["Title"] = "ورود";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card shadow-lg border-0" style="border-radius: 20px; overflow: hidden;">
                <!-- هدر نارنجی براق -->
                <div class="card-header bg-gradient-orange text-white text-center py-4" style="border-bottom: none;">
                    <h3 class="mb-0 fw-bold" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        ورود به فروشگاه
                    </h3>
                </div>

                <div class="card-body p-4" style="background: linear-gradient(145deg, #f8f9fa, #e9ecef);">
                    <!-- پیام موفقیت -->
                    @if (ViewBag.SuccessMessage != null)
                    {
                        <div class="alert alert-success alert-modern mb-4">
                            @ViewBag.SuccessMessage
                        </div>
                    }

                    <!-- راهنمای OTP -->
                    @if (ViewBag.OTPLoginHint != null)
                    {
                        <div class="alert alert-info alert-modern mb-4">
                            @Html.Raw(ViewBag.OTPLoginHint)
                            <small class="d-block mt-1 text-muted">از این رمز در فیلد زیر استفاده کنید.</small>
                        </div>
                    }

                    <form asp-action="Login" class="metallic-form">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <!-- فیلد ایمیل -->
                        <div class="form-group-modern mb-4">
                            <label class="form-label-modern text-dark fw-semibold">
                                ایمیل
                            </label>
                            <div class="metallic-input-wrapper">
                                <input name="email" type="email" class="metallic-input" required placeholder="example@email.com" />
                                <span class="input-icon metallic">
                                    <i class="bi bi-envelope"></i>
                                </span>
                            </div>
                        </div>

                        <!-- فیلد رمز عبور -->
                        <div class="form-group-modern mb-4">
                            <label class="form-label-modern text-dark fw-semibold">
                                رمز عبور (یا رمز یکبارمصرف)
                            </label>
                            <div class="metallic-input-wrapper">
                                <input name="password" type="text" class="metallic-input" required placeholder="رمز عبور یا کد ۶ رقمی" />
                                <span class="toggle-password metallic">
                                    <i class="bi bi-eye-slash"></i>
                                </span>
                            </div>
                        </div>

                        <!-- دکمه ورود فلزی براق -->
                        <div class="form-group mb-4">
                            <button type="submit" class="metallic-btn w-100">
                                <span class="btn-shine"></span>
                                <span class="btn-text">
                                    ورود
                                </span>
                            </button>
                        </div>
                    </form>

                    <!-- لینک‌های پایین -->
                    <div class="text-center mt-4">
                        <p class="mb-2">
                            حساب کاربری ندارید؟
                            <a asp-action="Register" class="text-primary fw-semibold text-decoration-none hover-underline">
                                ثبت نام کنید
                            </a>
                        </p>
                        <p>
                            <a asp-action="ForgotPassword" class="text-decoration-none text-muted hover-primary">
                                رمز عبور خود را فراموش کرده‌اید؟
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* گرادیان نارنجی لوکس */
        .bg-gradient-orange {
            background: linear-gradient(135deg, #ff8c00, #ffb347, #ffcc80);
            position: relative;
            overflow: hidden;
        }

            .bg-gradient-orange::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255,255,255,0.2), transparent, rgba(255,255,255,0.1));
                pointer-events: none;
            }

        .metallic-form {
            position: relative;
        }

        .form-group-modern {
            margin-bottom: 1.5rem;
        }

        .form-label-modern {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .metallic-input-wrapper {
            position: relative;
            margin-top: 8px;
        }

        .metallic-input {
            width: 100%;
            padding: 14px 18px 14px 45px;
            border: 2px solid transparent;
            border-radius: 16px;
            font-size: 1rem;
            background: linear-gradient(145deg, #ffffff, #f1f3f5);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            outline: none;
        }

            .metallic-input:focus {
                border-color: #4a90e2;
                box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2), inset 0 2px 6px rgba(0,0,0,0.1);
                background: #ffffff;
            }

        .input-icon.metallic,
        .toggle-password.metallic {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }

        .input-icon.metallic {
            left: 16px;
            pointer-events: none;
        }

        .toggle-password.metallic {
            left: 14px;
            cursor: pointer;
            pointer-events: all;
        }

            .toggle-password.metallic:hover {
                color: #4a90e2;
            }

        .metallic-btn {
            position: relative;
            padding: 16px 24px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #43cea2, #185a9d);
            border: none;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 20px rgba(24, 90, 157, 0.3), 0 4px 8px rgba(0,0,0,0.2);
        }

            .metallic-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 28px rgba(24, 90, 157, 0.4), 0 6px 12px rgba(0,0,0,0.25);
            }

        .btn-shine {
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.6s;
            transform: skewX(-25deg);
        }

        .metallic-btn:hover .btn-shine {
            left: 100%;
        }

        .btn-text {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-text::before {
                content: 'login';
                font-family: 'Bootstrap Icons';
                font-size: 1.2rem;
            }

        .alert-modern {
            border: none;
            border-radius: 14px;
            padding: 14px 18px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
        }

        .hover-underline:hover {
            text-decoration: underline !important;
        }

        .hover-primary:hover {
            color: #4a90e2 !important;
        }

        /* ریسپانسیو — بدون خطا و بدون media اشتباه */
        @@media (max-width: 576px) {
            .card {
                margin: 10px;
            }

            .metallic-input {
                padding: 12px 16px 12px 42px;
                font-size: 0.95rem;
            }

            .metallic-btn {
                padding: 14px 20px;
                font-size: 1rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.toggle-password').on('click', function () {
                const $wrapper = $(this).closest('.metallic-input-wrapper');
                const $input = $wrapper.find('input');
                const $icon = $(this).find('i');
                const isPassword = $input.attr('type') === 'password';
                $input.attr('type', isPassword ? 'text' : 'password');
                $icon.toggleClass('bi-eye-slash bi-eye');
            });

            setTimeout(function () {
                $('.alert').fadeOut(500);
            }, 6000);
        });
    </script>
}

------------------------------------------------------------------------------------------------
D:\MyShopProject\Views\Account\Profile.cshtml

@model MyShopProject.Models.ProfileViewModel

@{
    ViewData["Title"] = "پروفایل من";
    bool forcePasswordChange = ViewBag.ForcePasswordChange == true;
}

<div class="profile-container">
    <div class="container-fluid">
        <!-- هدر شیک و مدرن -->
        <div class="profile-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="bi bi-person-badge"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">پروفایل من</h1>
                    <p class="header-subtitle">مدیریت اطلاعات شخصی و امنیتی</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="user-status">
                    <span class="status-badge @(Model.Role == "مدیر" ? "status-admin" : "status-user")">
                        <i class="bi bi-shield-check"></i>
                        @Model.Role
                    </span>
                </div>
                <button type="button" class="btn-close-modern" onclick="closeProfile()" title="بستن پروفایل">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- نمایش پیام‌ها -->
        <div class="alerts-container">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-check-circle-fill alert-icon"></i>
                        <span>@TempData["SuccessMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                        <span>@TempData["ErrorMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>

        <div class="profile-content">
            @if (forcePasswordChange)
            {
                <!-- فقط فرم تغییر رمز اجباری -->
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="profile-card password-card">
                            <div class="card-header-modern bg-warning text-dark">
                                <div class="header-title-section">
                                    <i class="bi bi-key header-icon"></i>
                                    <h3 class="card-title">تغییر رمز عبور اجباری</h3>
                                </div>
                            </div>
                            <div class="card-body-modern">
                                <div class="alert alert-warning">
                                    <strong>برای امنیت بیشتر، لطفاً رمز عبور دائمی خود را تنظیم کنید.</strong>
                                </div>

                                <form asp-action="ForceChangePassword" method="post" class="password-form">
                                    @Html.AntiForgeryToken()

                                    <div class="form-group-modern">
                                        <label class="form-label-modern">
                                            <i class="bi bi-key input-icon"></i>
                                            رمز عبور جدید
                                        </label>
                                        <div class="input-group-modern password-input">
                                            <input type="password" name="newPassword" class="form-control-modern" required minlength="6" placeholder="حداقل ۶ کاراکتر" />
                                            <span class="input-status">
                                                <i class="bi bi-eye-slash toggle-password"></i>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="form-group-modern">
                                        <label class="form-label-modern">
                                            <i class="bi bi-key-fill input-icon"></i>
                                            تکرار رمز عبور جدید
                                        </label>
                                        <div class="input-group-modern password-input">
                                            <input type="password" name="confirmPassword" class="form-control-modern" required placeholder="تکرار رمز عبور جدید" />
                                            <span class="input-status">
                                                <i class="bi bi-eye-slash toggle-password"></i>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-success-modern w-100">
                                            <i class="bi bi-check-lg btn-icon"></i>
                                            تنظیم رمز و ورود
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- حالت عادی پروفایل -->
                <div class="row g-4">
                    <!-- کارت اطلاعات شخصی -->
                    <div class="col-xl-6 col-lg-12">
                        <div class="profile-card personal-info-card">
                            <div class="card-header-modern">
                                <div class="header-title-section">
                                    <i class="bi bi-person-gear header-icon"></i>
                                    <h3 class="card-title">اطلاعات شخصی</h3>
                                </div>
                                <div class="header-badge">
                                    <span class="badge bg-primary">ویرایش</span>
                                </div>
                            </div>

                            <div class="card-body-modern">
                                <form asp-action="Profile" method="post" class="profile-form">
                                    @Html.AntiForgeryToken()
                                    <div asp-validation-summary="ModelOnly" class="validation-summary"></div>
                                    <input type="hidden" asp-for="UserID" />

                                    <!-- ایمیل -->
                                    <div class="form-group-modern">
                                        <label asp-for="Email" class="form-label-modern">
                                            <i class="bi bi-envelope input-icon"></i>
                                            آدرس ایمیل
                                        </label>
                                        <div class="input-group-modern">
                                            <input asp-for="Email" class="form-control-modern" readonly />
                                            <span class="input-status readonly">
                                                <i class="bi bi-lock"></i>
                                            </span>
                                        </div>
                                        <span asp-validation-for="Email" class="validation-message"></span>
                                    </div>

                                    <!-- نام و نام خانوادگی -->
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-group-modern">
                                                <label asp-for="FirstName" class="form-label-modern">
                                                    <i class="bi bi-person input-icon"></i>
                                                    نام
                                                </label>
                                                <input asp-for="FirstName" class="form-control-modern" placeholder="نام خود را وارد کنید" />
                                                <span asp-validation-for="FirstName" class="validation-message"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group-modern">
                                                <label asp-for="LastName" class="form-label-modern">
                                                    <i class="bi bi-person-plus input-icon"></i>
                                                    نام خانوادگی
                                                </label>
                                                <input asp-for="LastName" class="form-control-modern" placeholder="نام خانوادگی خود را وارد کنید" />
                                                <span asp-validation-for="LastName" class="validation-message"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- شماره تلفن -->
                                    <div class="form-group-modern">
                                        <label asp-for="PhoneNumber" class="form-label-modern">
                                            <i class="bi bi-telephone input-icon"></i>
                                            شماره تلفن
                                        </label>
                                        <input asp-for="PhoneNumber" class="form-control-modern" placeholder="09xxxxxxxxx" />
                                        <span asp-validation-for="PhoneNumber" class="validation-message"></span>
                                    </div>

                                    <!-- کد پستی -->
                                    <div class="form-group-modern">
                                        <label asp-for="PostalCode" class="form-label-modern">
                                            <i class="bi bi-mailbox input-icon"></i>
                                            کد پستی
                                        </label>
                                        <input asp-for="PostalCode" class="form-control-modern" placeholder="۱۰ رقمی" />
                                        <span asp-validation-for="PostalCode" class="validation-message"></span>
                                    </div>

                                    <!-- آدرس -->
                                    <div class="form-group-modern">
                                        <label asp-for="Address" class="form-label-modern">
                                            <i class="bi bi-geo-alt input-icon"></i>
                                            آدرس کامل
                                        </label>
                                        <textarea asp-for="Address" class="form-control-modern textarea-modern" rows="3" placeholder="آدرس کامل خود را وارد کنید"></textarea>
                                        <span asp-validation-for="Address" class="validation-message"></span>
                                    </div>

                                    <!-- دکمه ذخیره -->
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary-modern w-100">
                                            <i class="bi bi-check-lg btn-icon"></i>
                                            ذخیره تغییرات
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- ستون سمت چپ -->
                    <div class="col-xl-6 col-lg-12">
                        <div class="row g-4">
                            <!-- کارت اطلاعات حساب -->
                            <div class="col-12">
                                <div class="profile-card account-info-card">
                                    <div class="card-header-modern">
                                        <div class="header-title-section">
                                            <i class="bi bi-info-circle header-icon"></i>
                                            <h3 class="card-title">اطلاعات حساب</h3>
                                        </div>
                                        <div class="header-badge">
                                            <span class="badge bg-success">فعال</span>
                                        </div>
                                    </div>

                                    <div class="card-body-modern">
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="bi bi-person-badge info-icon"></i>
                                                    نقش کاربری
                                                </div>
                                                <div class="info-value">
                                                    <span class="role-badge @(Model.Role == "مدیر" ? "role-admin" : "role-user")">
                                                        @Model.Role
                                                    </span>
                                                </div>
                                            </div>

                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="bi bi-calendar-check info-icon"></i>
                                                    تاریخ عضویت
                                                </div>
                                                <div class="info-value">
                                                    <span class="date-display">
                                                        <span class="persian-date">@ViewBag.CreatedAtPersian</span>
                                                        <small class="miladi-date">(@ViewBag.CreatedAtMiladi)</small>
                                                    </span>
                                                </div>
                                            </div>

                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="bi bi-shield-check info-icon"></i>
                                                    وضعیت حساب
                                                </div>
                                                <div class="info-value">
                                                    <span class="status-active">
                                                        <i class="bi bi-check-circle-fill"></i>
                                                        فعال
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- کارت تغییر رمز عبور -->
                            <div class="col-12">
                                <div class="profile-card password-card">
                                    <div class="card-header-modern">
                                        <div class="header-title-section">
                                            <i class="bi bi-key header-icon"></i>
                                            <h3 class="card-title">تغییر رمز عبور</h3>
                                        </div>
                                        <div class="header-badge">
                                            <span class="badge bg-warning">امنیتی</span>
                                        </div>
                                    </div>

                                    <div class="card-body-modern">
                                        <form asp-action="ChangePassword" method="post" id="changePasswordForm" class="password-form">
                                            @Html.AntiForgeryToken()

                                            <div class="form-group-modern">
                                                <label for="CurrentPassword" class="form-label-modern">
                                                    <i class="bi bi-lock input-icon"></i>
                                                    رمز عبور فعلی
                                                </label>
                                                <div class="input-group-modern password-input">
                                                    <input type="password" name="CurrentPassword" class="form-control-modern" required
                                                           placeholder="رمز عبور فعلی خود را وارد کنید" />
                                                    <span class="input-status">
                                                        <i class="bi bi-eye-slash toggle-password"></i>
                                                    </span>
                                                </div>
                                            </div>

                                            <div class="form-group-modern">
                                                <label for="NewPassword" class="form-label-modern">
                                                    <i class="bi bi-key input-icon"></i>
                                                    رمز عبور جدید
                                                </label>
                                                <div class="input-group-modern password-input">
                                                    <input type="password" name="NewPassword" class="form-control-modern" required
                                                           placeholder="حداقل ۶ کاراکتر" />
                                                    <span class="input-status">
                                                        <i class="bi bi-eye-slash toggle-password"></i>
                                                    </span>
                                                </div>
                                            </div>

                                            <div class="form-group-modern">
                                                <label for="ConfirmPassword" class="form-label-modern">
                                                    <i class="bi bi-key-fill input-icon"></i>
                                                    تکرار رمز عبور جدید
                                                </label>
                                                <div class="input-group-modern password-input">
                                                    <input type="password" name="ConfirmPassword" class="form-control-modern" required
                                                           placeholder="تکرار رمز عبور جدید" />
                                                    <span class="input-status">
                                                        <i class="bi bi-eye-slash toggle-password"></i>
                                                    </span>
                                                </div>
                                            </div>

                                            <div class="form-actions">
                                                <button type="submit" class="btn btn-warning-modern w-100">
                                                    <i class="bi bi-arrow-repeat btn-icon"></i>
                                                    تغییر رمز عبور
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* استایل‌های کامل شما بدون تغییر */
        .profile-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .profile-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            font-size: 3rem;
            color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #2d3748;
        }

        .header-subtitle {
            color: #718096;
            margin: 5px 0 0 0;
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-admin {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .status-user {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-close-modern {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

            .btn-close-modern:hover {
                background: rgba(239, 68, 68, 0.2);
                border-color: rgba(239, 68, 68, 0.5);
                transform: scale(1.1);
                color: #dc2626;
            }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

            .profile-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            }

        .personal-info-card {
            min-height: 650px;
        }

        .password-card {
            min-height: 380px;
        }

        .card-header-modern {
            padding: 25px 25px 0;
            border-bottom: none;
            background: transparent;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 1.5rem;
            color: #667eea;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
        }

        .header-badge .badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .card-body-modern {
            padding: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .profile-form, .password-form {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group-modern {
            margin-bottom: 1.5rem;
        }

        .form-label-modern {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .input-icon {
            color: #667eea;
            font-size: 1rem;
        }

        .input-group-modern {
            position: relative;
        }

        .form-control-modern {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

            .form-control-modern:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                background: white;
            }

            .form-control-modern:read-only {
                background-color: #f7fafc;
                border-color: #cbd5e0;
                color: #718096;
            }

        .textarea-modern {
            resize: vertical;
            min-height: 100px;
        }

        .input-status {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            cursor: pointer;
        }

            .input-status.readonly {
                cursor: not-allowed;
            }

        .form-actions {
            margin-top: auto;
            padding-top: 20px;
        }

        .btn-primary-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

            .btn-primary-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
                color: white;
            }

        .btn-warning-modern {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

            .btn-warning-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
                background: linear-gradient(135deg, #ee7af4 0%, #f34158 100%);
                color: white;
            }

        .btn-success-modern {
            background: linear-gradient(135deg, #48bb78, #38a169);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

            .btn-success-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
            }

        .btn-icon {
            margin-left: 8px;
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .info-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .info-icon {
            color: #667eea;
        }

        .info-value {
            font-weight: 600;
        }

        .role-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .role-admin {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .role-user {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .date-display {
            text-align: left;
        }

        .persian-date {
            font-weight: 700;
            color: #2d3748;
        }

        .miladi-date {
            color: #718096;
            font-size: 0.85rem;
        }

        .status-active {
            color: #38a169;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .alert-modern {
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        .validation-summary {
            background: rgba(254, 215, 215, 0.1);
            border: 1px solid rgba(229, 62, 62, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            color: #e53e3e;
            font-size: 0.9rem;
        }

        .validation-message {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        @@media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .header-title {
                font-size: 1.6rem;
            }

            .profile-container {
                padding: 10px 0;
            }

            .card-header-modern {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .info-item {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .header-actions {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }

            .btn-close-modern {
                align-self: flex-end;
                margin-top: -50px;
            }
        }

        @@media (max-width: 576px) {
            .btn-close-modern {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .header-title {
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 1rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#changePasswordForm').on('submit', function (e) {
                var currentPassword = $('input[name="CurrentPassword"]').val();
                var newPassword = $('input[name="NewPassword"]').val();
                var confirmPassword = $('input[name="ConfirmPassword"]').val();

                if (!currentPassword) { showToast('خطا', 'لطفاً رمز عبور فعلی را وارد کنید', 'error'); e.preventDefault(); return false; }
                if (newPassword.length < 6) { showToast('خطا', 'رمز عبور باید حداقل 6 کاراکتر باشد', 'error'); e.preventDefault(); return false; }
                if (newPassword !== confirmPassword) { showToast('خطا', 'رمز عبور و تکرار آن مطابقت ندارند', 'error'); e.preventDefault(); return false; }
                return true;
            });

            $('.toggle-password').on('click', function () {
                var input = $(this).closest('.password-input').find('input');
                var icon = $(this);
                if (input.attr('type') === 'password') { input.attr('type', 'text'); icon.removeClass('bi-eye-slash').addClass('bi-eye'); }
                else { input.attr('type', 'password'); icon.removeClass('bi-eye').addClass('bi-eye-slash'); }
            });

            $('input[name="PostalCode"]').on('blur', function () {
                var postalCode = $(this).val();
                if (postalCode && !/^\d{10}$/.test(postalCode)) { showToast('خطا', 'کد پستی باید 10 رقم باشد', 'error'); $(this).focus(); }
            });

            $('input[name="PhoneNumber"]').on('blur', function () {
                var phone = $(this).val();
                if (phone && !/^09\d{9}$/.test(phone)) { showToast('خطا', 'شماره تلفن باید با 09 شروع شده و 11 رقم باشد', 'error'); $(this).focus(); }
            });

            setTimeout(function () { $('.alert').alert('close'); }, 5000);

            function showToast(title, message, type) { alert(title + ': ' + message); }

            $('.profile-card').hover(function() { $(this).css('transform', 'translateY(-5px)'); }, function() { $(this).css('transform', 'translateY(0)'); });
        });

        function closeProfile() {
            if (confirm('آیا می‌خواهید از پروفایل خارج شوید؟ تغییرات ذخیره نشده از بین خواهند رفت.')) {
                window.location.href = '@Url.Action("Index", "Products")';
            }
        }

        $(document).on('keydown', function (e) {
            if (e.key === 'Escape') { closeProfile(); }
        });
    </script>
}

---------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Account\Register.cshtml

@model MyShopProject.Models.User
@{
    ViewData["Title"] = "ثبت نام";
}

@{
    var provinces = new List<string>
    {
        "آذربایجان شرقی", "آذربایجان غربی", "اردبیل", "اصفهان", "البرز", "ایلام", "بوشهر",
        "تهران", "چهارمحال و بختیاری", "خراسان جنوبی", "خراسان رضوی", "خراسان شمالی",
        "خوزستان", "زنجان", "سمنان", "سیستان و بلوچستان", "فارس", "قزوین", "قم",
        "کردستان", "کرمان", "کرمانشاه", "کهگیلویه و بویراحمد", "گلستان", "گیلان",
        "لرستان", "مازندران", "مرکزی", "هرمزگان", "همدان", "یزد"
    };
    provinces.Sort();
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">ثبت نام در فروشگاه</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Register">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="form-group mb-3">
                            <label asp-for="Email" class="control-label">ایمیل *</label>
                            <input asp-for="Email" class="form-control" type="email" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label for="password" class="control-label">رمز عبور *</label>
                            <input name="password" type="password" class="form-control" required />
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="FirstName" class="control-label">نام *</label>
                                    <input asp-for="FirstName" class="form-control" />
                                    <span asp-validation-for="FirstName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="LastName" class="control-label">نام خانوادگی *</label>
                                    <input asp-for="LastName" class="form-control" />
                                    <span asp-validation-for="LastName" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="PhoneNumber" class="control-label">شماره موبایل</label>
                            <input asp-for="PhoneNumber" class="form-control" />
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="PostalCode" class="control-label">کد پستی *</label>
                            <input asp-for="PostalCode" class="form-control" />
                            <span asp-validation-for="PostalCode" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label class="control-label">استان *</label>
                            <select asp-for="Province" class="form-control" required>
                                <option value="">-- انتخاب استان --</option>
                                @foreach (var province in provinces)
                                {
                                    <option value="@province">@province</option>
                                }
                            </select>
                            <span asp-validation-for="Province" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label class="control-label">ادامه آدرس *</label>
                            <textarea asp-for="DetailedAddress" class="form-control" rows="3" placeholder=""></textarea>
                            <span asp-validation-for="DetailedAddress" class="text-danger"></span>
                        </div>

                        <!-- فیلد مخفی برای آدرس ترکیبی -->
                        <input asp-for="Address" type="hidden" />

                        <div class="form-group mb-3">
                            <button type="submit" class="btn btn-primary w-100">ثبت نام</button>
                        </div>
                    </form>

                    <div class="text-center">
                        <p>قبلاً ثبت نام کرده‌اید؟ <a asp-action="Login">وارد شوید</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ترکیب آدرس قبل از ارسال فرم
        document.querySelector('form').addEventListener('submit', function () {
            const province = document.querySelector('[name="Province"]').value.trim();
            const detailed = document.querySelector('[name="DetailedAddress"]').value.trim();
            const address = province && detailed ? province + " - " + detailed : '';
            document.querySelector('[name="Address"]').value = address;
        });
    </script>
}

-------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Account\ResetPassword.cshtml

@{
    ViewData["Title"] = "تنظیم رمز عبور جدید";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">تنظیم رمز عبور جدید</h3>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                    }

                    <form asp-action="ResetPassword" method="post">
                        <input type="hidden" name="token" value="@ViewBag.Token" />
                        <input type="hidden" name="email" value="@ViewBag.Email" />

                        <div class="form-group mb-3">
                            <label for="newPassword" class="control-label">رمز عبور جدید</label>
                            <input name="newPassword" type="password" class="form-control" required
                                   minlength="6" placeholder="حداقل 6 کاراکتر" />
                        </div>

                        <div class="form-group mb-3">
                            <label for="confirmPassword" class="control-label">تکرار رمز عبور</label>
                            <input name="confirmPassword" type="password" class="form-control" required
                                   placeholder="رمز عبور را تکرار کنید" />
                        </div>

                        <div class="form-group mb-3">
                            <button type="submit" class="btn btn-primary w-100">تغییر رمز عبور</button>
                        </div>
                    </form>

                    <div class="text-center">
                        <a asp-action="Login" class="btn btn-outline-secondary">بازگشت به صفحه ورود</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

------------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Account\VerifyOTP.cshtml

@{
    ViewData["Title"] = "تایید رمز یکبارمصرف";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">تایید رمز یکبارمصرف</h3>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success">
                            @TempData["SuccessMessage"]
                            @if (ViewBag.OTPCode != null)
                            {
                                <div class="mt-2 p-2 bg-light rounded">
                                    <small>رمز یکبارمصرف (برای تست):</small><br>
                                    <strong class="text-primary" style="font-size: 1.5rem;">@ViewBag.OTPCode</strong>
                                </div>
                            }
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                    }

                    <form asp-action="VerifyOTP" method="post">
                        <input type="hidden" name="email" value="@ViewBag.Email" />

                        <div class="form-group mb-3">
                            <label for="otp" class="control-label">رمز یکبارمصرف 6 رقمی</label>
                            <input name="otp" type="text" class="form-control text-center" required
                                   maxlength="6" minlength="6" pattern="[0-9]{6}"
                                   placeholder="123456" style="font-size: 1.2rem; letter-spacing: 5px;" />
                            <small class="form-text text-muted">رمز ارسال شده به ایمیل @ViewBag.Email را وارد کنید</small>
                        </div>

                        <div class="form-group mb-3">
                            <button type="submit" class="btn btn-primary w-100">تایید رمز</button>
                        </div>
                    </form>

                    <div class="text-center">
                        <a asp-action="ForgotPassword" class="btn btn-outline-secondary">بازگشت</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // محدود کردن ورودی به اعداد
            $('input[name="otp"]').on('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
            });

            // فوکوس خودکار روی فیلد OTP
            $('input[name="otp"]').focus();
        });
    </script>
}

--------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\AddProduct.cshtml

@model MyShopProject.Models.Product
@{
    ViewData["Title"] = "افزودن محصول جدید";
}

<div class="container-fluid py-4">
    <!-- هدر صفحه -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="h3 mb-0 text-primary">
                                افزودن محصول جدید
                            </h1>
                            <p class="text-muted mb-0">اطلاعات محصول جدید را وارد کنید</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="/Admin/Products" class="btn btn-outline-secondary">
                                بازگشت به لیست محصولات
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فرم ایجاد محصول -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-white">
                    <h5 class="mb-0">اطلاعات محصول</h5>
                </div>
                <div class="card-body">
                    <form asp-action="CreateProduct" method="post" enctype="multipart/form-data" id="createProductForm">
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <!-- نام محصول -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="ProductName" class="form-label">نام محصول *</label>
                                <input asp-for="ProductName" class="form-control" placeholder="نام محصول را وارد کنید">
                                <span asp-validation-for="ProductName" class="text-danger small"></span>
                            </div>

                            <!-- برند -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="Brand" class="form-label">برند *</label>
                                <input asp-for="Brand" class="form-control" placeholder="نام برند را وارد کنید">
                                <span asp-validation-for="Brand" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- قیمت -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="Price" class="form-label">قیمت (تومان) *</label>
                                <input asp-for="Price" type="number" class="form-control" placeholder="قیمت محصول" min="0" step="1000">
                                <span asp-validation-for="Price" class="text-danger small"></span>
                            </div>

                            <!-- موجودی -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="StockQuantity" class="form-label">تعداد موجودی *</label>
                                <input asp-for="StockQuantity" type="number" class="form-control" placeholder="تعداد موجودی" min="0">
                                <span asp-validation-for="StockQuantity" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- رنگ -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="Color" class="form-label">رنگ</label>
                                <input asp-for="Color" class="form-control" placeholder="رنگ محصول (اختیاری)">
                                <span asp-validation-for="Color" class="text-danger small"></span>
                            </div>

                            <!-- دسته‌بندی -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoryID" class="form-label">دسته‌بندی *</label>
                                <select asp-for="CategoryID" class="form-select" asp-items="ViewBag.Categories">
                                    <option value="">-- انتخاب دسته‌بندی --</option>
                                </select>
                                <span asp-validation-for="CategoryID" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- مسیر تصویر -->
                        <div class="mb-3">
                            <label asp-for="ImageUrl" class="form-label">مسیر تصویر</label>
                            <input asp-for="ImageUrl" class="form-control" placeholder="آدرس تصویر محصول (اختیاری)">
                            <div class="form-text">می‌توانید آدرس تصویر از اینترنت وارد کنید</div>
                            <span asp-validation-for="ImageUrl" class="text-danger small"></span>
                        </div>

                        <!-- توضیحات -->
                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">توضیحات محصول</label>
                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="توضیحات کامل محصول (اختیاری)"></textarea>
                            <span asp-validation-for="Description" class="text-danger small"></span>
                        </div>

                        <!-- دکمه‌های action -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="submit" class="btn btn-primary">
                                        ایجاد محصول
                                    </button>
                                    <a href="/Admin/Products" class="btn btn-outline-secondary">
                                        انصراف
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .card {
            border: none;
            border-radius: 10px;
        }

        .card-header {
            border-bottom: 1px solid #e3e6f0;
            background-color: #f8f9fc;
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // نمایش پیام‌های TempData
            showTempMessages();

            // اعتبارسنجی فرم
            $('#createProductForm').on('submit', function (e) {
                const form = $(this);
                if (!form[0].checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                form.addClass('was-validated');
            });

            // فرمت قیمت هنگام تایپ
            $('#Price').on('input', function () {
                let value = $(this).val().replace(/,/g, '');
                if (value) {
                    $(this).val(parseInt(value).toLocaleString('fa-IR'));
                }
            });

            // فرمت قیمت هنگام از دست دادن فوکوس
            $('#Price').on('blur', function () {
                let value = $(this).val().replace(/,/g, '');
                if (value) {
                    $(this).val(parseInt(value).toLocaleString('fa-IR'));
                }
            });
        });

        function showTempMessages() {
            const successMessage = '@TempData["SuccessMessage"]';
            const errorMessage = '@TempData["ErrorMessage"]';

            if (successMessage) {
                showToast('success', successMessage);
            }

            if (errorMessage) {
                showToast('error', errorMessage);
            }
        }

        function showToast(type, message) {
            // ایجاد toast داینامیک
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // حذف toast بعد از پنهان شدن
            toast.addEventListener('hidden.bs.toast', function () {
                toastContainer.remove();
            });
        }
    </script>
}

---------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\Categories.cshtml

@model List<MyShopProject.Models.Category>
@{
    ViewData["Title"] = "مدیریت دسته‌بندی‌ها";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h1 class="h3 mb-0 text-primary">
                        <i class="bi bi-tags"></i>
                        مدیریت دسته‌بندی‌ها
                    </h1>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <p>صفحه مدیریت دسته‌بندی‌ها - به زودی...</p>
            <a href="/Admin" class="btn btn-secondary">بازگشت به داشبورد</a>
        </div>
    </div>
</div>

-------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\CreateProduct.cshtml

@model MyShopProject.Models.Product
@using System
@{
    ViewData["Title"] = "ایجاد محصول جدید";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">ایجاد محصول جدید</h4>
                </div>
                <div class="card-body">
                    <!-- نمایش خطاهای اعتبارسنجی -->
                    @if (TempData["ValidationErrors"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>خطاهای فرم:</strong>
                            <ul class="mb-0">
                                @foreach (var error in ((string)TempData["ValidationErrors"]).Split('|', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <li>@error.Trim()</li>
                                }
                            </ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-action="CreateProduct" method="post" enctype="multipart/form-data" id="createProductForm">
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="ProductName" class="form-label text-dark fw-bold">نام محصول *</label>
                                    <input asp-for="ProductName" class="form-control text-primary" id="productNameInput" placeholder="نام محصول را وارد کنید" />
                                    <span asp-validation-for="ProductName" class="text-danger small"></span>
                                </div>
                            </div>

                            <!-- برند با سرچ لایو + فارسی + لاتین -->
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label text-dark fw-bold">برند *</label>
                                    <select id="brandSelect" class="form-control text-primary" name="Brand">
                                        <option value="">-- انتخاب یا تایپ برند --</option>
                                    </select>
                                    <span class="text-danger small" id="brandError"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- قیمت با جداکننده 3 رقمی -->
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label text-dark fw-bold">قیمت (تومان) *</label>
                                    <input type="text" class="form-control text-success fw-bold" id="priceInput" placeholder="مثلاً 1,000,000,000" />
                                    <input type="hidden" id="priceHidden" name="Price" />
                                    <span class="text-danger small" id="priceError"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="StockQuantity" class="form-label text-dark fw-bold">موجودی *</label>
                                    <input asp-for="StockQuantity" class="form-control text-info fw-bold" type="number" placeholder="تعداد موجودی" />
                                    <span asp-validation-for="StockQuantity" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- دسته‌بندی با سرچ لایو + پیشنهاد هوشمند -->
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label text-dark fw-bold">دسته‌بندی *</label>
                                    <select id="categorySelect" class="form-control text-primary" name="categoryInput">
                                        <option value="">-- انتخاب یا تایپ دسته‌بندی --</option>
                                    </select>
                                    <span class="text-danger small" id="categoryError"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Color" class="form-label text-dark fw-bold">رنگ</label>
                                    <input asp-for="Color" class="form-control text-primary" placeholder="رنگ محصول" />
                                    <span asp-validation-for="Color" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- آپلود تصویر -->
                        <div class="form-group mb-4">
                            <label class="form-label text-dark fw-bold">آپلود تصویر محصول</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="imageUpload" name="imageFile" accept="image/*" />
                                <button type="button" class="btn btn-outline-secondary" id="browseImageBtn">انتخاب فایل</button>
                            </div>
                            <small class="form-text text-muted">فرمت‌های مجاز: JPG, PNG, GIF - حداکثر سایز: 5MB</small>
                            <div id="imagePreview" class="mt-2 text-center"></div>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="ImageUrl" class="form-label text-dark fw-bold">آدرس تصویر (اختیاری)</label>
                            <input asp-for="ImageUrl" class="form-control text-muted" placeholder="یا آدرس تصویر را وارد کنید" />
                            <span asp-validation-for="ImageUrl" class="text-danger small"></span>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="Description" class="form-label text-dark fw-bold">توضیحات</label>
                            <textarea asp-for="Description" class="form-control text-primary" rows="4" placeholder="توضیحات کامل محصول"></textarea>
                            <span asp-validation-for="Description" class="text-danger small"></span>
                        </div>

                        <div class="d-flex gap-2 justify-content-end">
                            <button type="submit" class="btn btn-success">ایجاد محصول</button>
                            <a href="@Url.Action("Products")" class="btn btn-secondary">لغو</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        .form-label {
            color: #2c3e50 !important;
            font-weight: 600 !important;
        }

        .form-control {
            border: 2px solid #e9ecef;
            color: #3498db !important;
            font-weight: 500;
        }

            .form-control:focus {
                border-color: #3498db;
                box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            }

        .text-success.form-control {
            color: #27ae60 !important;
        }

        .text-info.form-control {
            color: #2980b9 !important;
        }

        #imagePreview img {
            max-width: 200px;
            max-height: 150px;
            border: 2px solid #3498db;
            border-radius: 8px;
        }

        .select2-container--bootstrap-5 .select2-selection {
            border: 2px solid #e9ecef;
            border-radius: 0.375rem;
            height: 38px;
            padding: 0.375rem 0.75rem;
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/fa.js"></script>

    <script>
        // لیست دسته‌بندی‌ها از سرور + دسته‌بندی‌های جدید
        let allCategories = [];
        let categoryMap = {};

        // لیست برندها با نام فارسی + لاتین
        const allBrands = [
            { en: "Nike", fa: "نایک" },
            { en: "Adidas", fa: "آدیداس" },
            { en: "Puma", fa: "پوما" },
            { en: "Reebok", fa: "ریباک" },
            { en: "New Balance", fa: "نیو بالانس" },
            { en: "Vans", fa: "ونز" },
            { en: "Converse", fa: "کانورس" },
            { en: "Under Armour", fa: "آندر آرمور" },
            { en: "Asics", fa: "اسیکس" },
            { en: "Skechers", fa: "اسکچرز" },
            { en: "Apple", fa: "اپل" },
            { en: "Samsung", fa: "سامسونگ" },
            { en: "Xiaomi", fa: "شیائومی" },
            { en: "Huawei", fa: "هواوی" },
            { en: "Oppo", fa: "اوپو" },
            { en: "Vivo", fa: "ویوو" },
            { en: "OnePlus", fa: "وان پلاس" },
            { en: "Sony", fa: "سونی" },
            { en: "LG", fa: "ال جی" },
            { en: "Nokia", fa: "نوکیا" },
            { en: "Dell", fa: "دل" },
            { en: "HP", fa: "اچ پی" },
            { en: "Lenovo", fa: "لنوو" },
            { en: "Asus", fa: "ایسوس" },
            { en: "Acer", fa: "ایسر" },
            { en: "MSI", fa: "ام اس آی" },
            { en: "Microsoft", fa: "مایکروسافت" },
            { en: "Razer", fa: "ریزر" },
            { en: "Alienware", fa: "الیِن ویر" },
            { en: "Toshiba", fa: "توشیبا" },
            { en: "Zara", fa: "زارا" },
            { en: "H&M", fa: "اچ اند ام" },
            { en: "Mango", fa: "مانگو" },
            { en: "Pull&Bear", fa: "پول اند بیر" },
            { en: "Bershka", fa: "برشکا" },
            { en: "Stradivarius", fa: "استرادیواریوس" },
            { en: "Uniqlo", fa: "یونیکلو" },
            { en: "Gucci", fa: "گوچی" },
            { en: "Prada", fa: "پرادا" },
            { en: "Louis Vuitton", fa: "لویی ویتون" },
            { en: "Bosch", fa: "بوش" },
            { en: "Siemens", fa: "زیمنس" },
            { en: "Electrolux", fa: "الکترولوکس" },
            { en: "Whirlpool", fa: "ویرپول" },
            { en: "Panasonic", fa: "پاناسونیک" },
            { en: "Sharp", fa: "شارپ" },
            { en: "Hitachi", fa: "هیتاچی" },
            { en: "Mitsubishi", fa: "میتسوبیشی" },
            { en: "Daikin", fa: "دایکین" },
            { en: "Gree", fa: "گری" },
            { en: "Philips", fa: "فیلیپس" },
            { en: "TCL", fa: "تی سی ال" },
            { en: "Hisense", fa: "هایسنس" },
            { en: "Skyworth", fa: "اسکای ورث" },
            { en: "Haier", fa: "هایر" },
            { en: "Midea", fa: "میدیا" },
            { en: "Changhong", fa: "چانگ هونگ" },
            { en: "Konka", fa: "کونکا" },
            { en: "GE", fa: "جی ای" },
            { en: "Frigidaire", fa: "فریجیدر" },
            { en: "Maytag", fa: "میتگ" },
            { en: "KitchenAid", fa: "کیچن اید" },
            { en: "Amana", fa: "آمانا" },
            { en: "Chanel", fa: "شنل" },
            { en: "Dior", fa: "دیور" },
            { en: "Hermès", fa: "هرمس" },
            { en: "Burberry", fa: "بربری" },
            { en: "Versace", fa: "ورساچه" },
            { en: "Fendi", fa: "فندی" },
            { en: "Balenciaga", fa: "بالنسیاگا" },
            { en: "Givenchy", fa: "جیوانشی" },
            { en: "Yves Saint Laurent", fa: "ایو سن لوران" },
            { en: "Rolex", fa: "رولکس" },
            { en: "Omega", fa: "امگا" },
            { en: "Tag Heuer", fa: "تگ هویر" },
            { en: "Cartier", fa: "کارتیر" },
            { en: "Patek Philippe", fa: "پاتک فیلیپ" },
            { en: "Audemars Piguet", fa: "اودمار پیگه" },
            { en: "IWC", fa: "آی دبلیو سی" },
            { en: "Breitling", fa: "برایتلینگ" },
            { en: "Tissot", fa: "تیسوت" },
            { en: "Seiko", fa: "سیکو" },
            { en: "Levi's", fa: "لِویز" },
            { en: "Tommy Hilfiger", fa: "تامی هیلفیگر" },
            { en: "Calvin Klein", fa: "کالوین کلین" },
            { en: "Ralph Lauren", fa: "رالف لورن" },
            { en: "Lacoste", fa: "لاکوست" },
            { en: "Nautica", fa: "ناتیکا" },
            { en: "Guess", fa: "گس" },
            { en: "Diesel", fa: "دیزل" },
            { en: "Armani", fa: "آرمانی" },
            { en: "Hugo Boss", fa: "هوگو باس" },
            { en: "Canon", fa: "کنون" },
            { en: "Nikon", fa: "نیکون" },
            { en: "Fujifilm", fa: "فوجی فیلم" },
            { en: "Olympus", fa: "المپوس" },
            { en: "Leica", fa: "لایکا" },
            { en: "GoPro", fa: "گو پرو" },
            { en: "DJI", fa: "دی جی آی" },
            { en: "Insta360", fa: "اینستا 360" },
            { en: "IKEA", fa: "ایکیا" },
            { en: "Wayfair", fa: "وی فیر" },
            { en: "Ashley", fa: "اشلی" },
            { en: "La-Z-Boy", fa: "لا زی بوی" },
            { en: "West Elm", fa: "وست الم" },
            { en: "Crate & Barrel", fa: "کریت اند برل" },
            { en: "Pottery Barn", fa: "پاتری بارن" },
            { en: "Williams-Sonoma", fa: "ویلیامز سونوما" },
            { en: "RH", fa: "آر اچ" },
            { en: "Arhaus", fa: "آرهاوس" }
        ];

        $(document).ready(function () {
            // بارگذاری دسته‌بندی‌ها از سرور
            $.getJSON('/Admin/GetCategories', function (data) {
                allCategories = data;
                categoryMap = {};
                data.forEach(c => categoryMap[c.text.toLowerCase()] = c.id);

                const extraCategories = ["لوازم خانگی", "کیف و کفش", "لوازم ورزشی", "الکترونیک", "پوشاک", "ساعت"];
                extraCategories.forEach(cat => {
                    if (!Object.values(categoryMap).some(id => data.some(d => d.id === id && d.text === cat))) {
                        allCategories.push({ id: cat, text: cat });
                        categoryMap[cat.toLowerCase()] = cat;
                    }
                });

                $('#categorySelect').select2({
                    theme: 'bootstrap-5',
                    language: 'fa',
                    tags: true,
                    data: allCategories.map(c => ({ id: c.id, text: c.text })),
                    createTag: function (params) {
                        return { id: params.term, text: params.term + ' (جدید)' };
                    }
                }).on('select2:select', function () {
                    $('#categoryError').text('');
                });
            });

            // تبدیل برند به فرمت نمایش
            function formatBrand(brand) {
                return `${brand.en} ${brand.fa}`;
            }

            // به‌روزرسانی برندها
            function updateBrandOptions(brandsList) {
                const filtered = allBrands.filter(b => brandsList.includes(b.en) || brandsList.length === 0);
                $('#brandSelect').empty().select2({
                    theme: 'bootstrap-5',
                    language: 'fa',
                    tags: true,
                    data: filtered.map(b => ({ id: b.en, text: formatBrand(b) })),
                    createTag: function (params) {
                        return { id: params.term, text: params.term + ' (جدید)' };
                    }
                }).on('select2:select', function () {
                    $('#brandError').text('');
                });
            }

            // نقشه برندها
            const brandMap = {
                "گوشی موبایل": ["Apple", "Samsung", "Xiaomi", "Huawei", "Oppo", "Vivo", "OnePlus", "Sony", "LG", "Nokia"],
                "لپ‌تاپ": ["Dell", "HP", "Lenovo", "Asus", "Acer", "MSI", "Apple", "Microsoft", "Razer", "Alienware"],
                "کفش": ["Nike", "Adidas", "Puma", "Reebok", "New Balance", "Vans", "Converse", "Under Armour", "Asics", "Skechers"],
                "پوشاک": ["Zara", "H&M", "Mango", "Pull&Bear", "Bershka", "Uniqlo", "Gucci", "Prada", "Levi's", "Tommy Hilfiger"],
                "تلویزیون": ["Samsung", "LG", "Sony", "TCL", "Hisense", "Philips", "Panasonic", "Sharp"],
                "یخچال فریزر": ["Samsung", "LG", "Bosch", "Electrolux", "Whirlpool", "GE", "Frigidaire", "Maytag"],
                "لوازم خانگی": ["Bosch", "Siemens", "Electrolux", "Whirlpool", "Panasonic", "IKEA", "Philips", "Midea"],
                "کیف و کفش": ["Gucci", "Chanel", "Dior", "Hermès", "Burberry", "Versace", "Fendi", "Balenciaga"],
                "لوازم ورزشی": ["Nike", "Adidas", "Puma", "Under Armour", "Asics", "New Balance", "Reebok", "Skechers"],
                "ساعت": ["Rolex", "Omega", "Tag Heuer", "Cartier", "Patek Philippe", "Audemars Piguet", "IWC", "Breitling"],
                "default": allBrands.map(b => b.en)
            };

            const categoryKeywords = {
                "کفش": "کفش", "کفشی": "کفش", "ورزشی": "لوازم ورزشی",
                "کیف": "کیف و کفش", "زنانه": "کیف و کفش", "مردانه": "کیف و کفش",
                "گوشی": "گوشی موبایل", "موبایل": "گوشی موبایل",
                "لپتاپ": "لپ‌تاپ", "نوت بوک": "لپ‌تاپ",
                "تلویزیون": "تلویزیون", "یخچال": "یخچال فریزر", "لوازم خانگی": "لوازم خانگی",
                "ساعت": "ساعت"
            };

            $('#productNameInput').on('input', function () {
                const name = $(this).val().trim().toLowerCase();
                let suggestedCategory = null;
                let suggestedBrands = brandMap["default"];

                for (const [keyword, category] of Object.entries(categoryKeywords)) {
                    if (name.includes(keyword)) {
                        suggestedCategory = category;
                        break;
                    }
                }

                if (suggestedCategory) {
                    const key = suggestedCategory.toLowerCase();
                    if (categoryMap[key]) {
                        $('#categorySelect').val(categoryMap[key]).trigger('change');
                    } else {
                        const newOption = new Option(suggestedCategory + ' (جدید)', suggestedCategory, true, true);
                        $('#categorySelect').append(newOption).trigger('change');
                        categoryMap[key] = suggestedCategory;
                    }
                    suggestedBrands = brandMap[suggestedCategory] || brandMap["default"];
                }

                updateBrandOptions(suggestedBrands);
            });

            // فرمت قیمت
            $('#priceInput').on('input', function () {
                let value = $(this).val().replace(/[^\d]/g, '');
                if (value) {
                    const num = parseInt(value);
                    if (num > 0) {
                        $(this).val(num.toLocaleString('en-US'));
                        $('#priceHidden').val(num);
                        $('#priceError').text('');
                    } else {
                        $('#priceHidden').val('');
                        $('#priceError').text('قیمت باید بیشتر از صفر باشد');
                    }
                } else {
                    $('#priceHidden').val('');
                    $('#priceError').text('قیمت الزامی است');
                }
            });

            // اعتبارسنجی نهایی
            $('#createProductForm').on('submit', function (e) {
                let isValid = true;
                if (!$('#brandSelect').val()) { $('#brandError').text('برند الزامی است'); isValid = false; }
                if (!$('#categorySelect').val()) { $('#categoryError').text('دسته‌بندی الزامی است'); isValid = false; }
                if (!$('#priceHidden').val()) { $('#priceError').text('قیمت الزامی است'); isValid = false; }
                if (!isValid) e.preventDefault();
            });

            // پیش‌نمایش تصویر
            $('#browseImageBtn').click(() => $('#imageUpload').click());
            $('#imageUpload').change(function (e) {
                const file = e.target.files[0];
                if (file) {
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(file.type)) {
                        alert('لطفاً یک فایل تصویر معتبر انتخاب کنید (JPG, PNG, GIF)');
                        $(this).val('');
                        return;
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        alert('حجم فایل نباید بیشتر از 5 مگابایت باشد');
                        $(this).val('');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = e => $('#imagePreview').html(`
                        <img src="${e.target.result}" alt="پیش‌نمایش" class="mt-2" />
                        <div class="mt-1"><small class="text-muted">${file.name}</small></div>
                    `);
                    reader.readAsDataURL(file);
                }
            });

            // مقدار اولیه
            updateBrandOptions(brandMap["default"]);
        });
    </script>
}

--------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\EditProduct.cshtml

@model MyShopProject.Models.Product
@{
    ViewData["Title"] = "ویرایش محصول";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        ویرایش محصول
                    </h4>
                </div>
                <div class="card-body">
                    <!-- نمایش پیام موفقیت -->
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <!-- نمایش پیام‌های خطا -->
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (TempData["ValidationErrors"] != null)
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            @TempData["ValidationErrors"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <form asp-action="EditProduct" method="post" enctype="multipart/form-data" id="editProductForm">
                        <input type="hidden" asp-for="ProductID" />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="ProductName" class="form-label text-dark fw-bold">نام محصول *</label>
                                    <input asp-for="ProductName" class="form-control text-primary" placeholder="نام محصول را وارد کنید" />
                                    <span asp-validation-for="ProductName" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Brand" class="form-label text-dark fw-bold">برند *</label>
                                    <input asp-for="Brand" class="form-control text-primary" placeholder="برند محصول را وارد کنید" />
                                    <span asp-validation-for="Brand" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Price" class="form-label text-dark fw-bold">قیمت (تومان) *</label>
                                    <input asp-for="Price" class="form-control text-success fw-bold" type="number" step="0.01" placeholder="قیمت به تومان" />
                                    <span asp-validation-for="Price" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="StockQuantity" class="form-label text-dark fw-bold">موجودی *</label>
                                    <input asp-for="StockQuantity" class="form-control text-info fw-bold" type="number" placeholder="تعداد موجودی" />
                                    <span asp-validation-for="StockQuantity" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="CategoryID" class="form-label text-dark fw-bold">دسته‌بندی *</label>
                                    <select asp-for="CategoryID" class="form-control text-primary" asp-items="ViewBag.Categories">
                                        <option value="">-- انتخاب دسته‌بندی --</option>
                                    </select>
                                    <span asp-validation-for="CategoryID" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Color" class="form-label text-dark fw-bold">رنگ</label>
                                    <input asp-for="Color" class="form-control text-primary" placeholder="رنگ محصول" />
                                    <span asp-validation-for="Color" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- بخش آپلود تصویر جدید -->
                        <div class="form-group mb-4">
                            <label class="form-label text-dark fw-bold">آپلود تصویر جدید (اختیاری)</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="imageUpload" name="imageFile" accept="image/*" />
                                <button type="button" class="btn btn-outline-secondary" id="browseImageBtn">
                                    انتخاب فایل
                                </button>
                            </div>
                            <small class="form-text text-muted">فرمت‌های مجاز: JPG, PNG, GIF - حداکثر سایز: 5MB</small>
                            <div id="imagePreview" class="mt-2 text-center"></div>
                        </div>

                        <!-- فیلد آدرس تصویر -->
                        <div class="form-group mb-3">
                            <label asp-for="ImageUrl" class="form-label text-dark fw-bold">آدرس تصویر فعلی</label>
                            <input asp-for="ImageUrl" class="form-control text-muted" placeholder="آدرس تصویر محصول" readonly />
                            <span asp-validation-for="ImageUrl" class="text-danger small"></span>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="Description" class="form-label text-dark fw-bold">توضیحات</label>
                            <textarea asp-for="Description" class="form-control text-primary" rows="4" placeholder="توضیحات کامل محصول"></textarea>
                            <span asp-validation-for="Description" class="text-danger small"></span>
                        </div>

                        <div class="form-group mb-4">
                            <label class="form-label text-dark fw-bold">تصویر فعلی</label>
                            <div class="text-center">
                                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                                {
                                    <img src="@Url.Content(Model.ImageUrl)" alt="@Model.ProductName" class="img-thumbnail shadow" style="max-height: 200px; max-width: 200px;" id="currentImage" />
                                    <div class="mt-2">
                                        <small class="text-muted">@Model.ImageUrl</small>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning text-center py-3">
                                        <p class="mb-0">تصویری برای این محصول موجود نیست</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="d-flex gap-2 justify-content-end">
                            <button type="submit" class="btn btn-success" id="saveButton">
                                ذخیره تغییرات
                            </button>
                            <a href="@Url.Action("Products")" class="btn btn-secondary">
                                بازگشت
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .form-label {
            color: #2c3e50 !important;
            font-weight: 600 !important;
            margin-bottom: 8px;
        }

        .form-control {
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            color: #3498db !important;
            font-weight: 500;
        }

            .form-control:focus {
                border-color: #3498db;
                box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
                color: #2980b9 !important;
            }

        .text-success.form-control {
            color: #27ae60 !important;
            font-weight: 600;
        }

        .text-info.form-control {
            color: #2980b9 !important;
            font-weight: 600;
        }

        #browseImageBtn {
            border: 2px solid #6c757d;
            color: #6c757d;
            font-weight: 500;
        }

            #browseImageBtn:hover {
                background-color: #6c757d;
                color: white;
            }

        #imagePreview img {
            max-width: 200px;
            max-height: 150px;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 5px;
            background: white;
        }

        #currentImage {
            border: 3px solid #2ecc71;
            padding: 5px;
            background: white;
        }

        .form-control[readonly] {
            background-color: #f8f9fa;
            color: #6c757d !important;
            cursor: not-allowed;
        }

        .alert-success {
            border-left: 5px solid #28a745;
        }

        .alert-danger {
            border-left: 5px solid #dc3545;
        }

        .alert-warning {
            border-left: 5px solid #ffc107;
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            // مدیریت آپلود تصویر
            $('#browseImageBtn').click(function () {
                $('#imageUpload').click();
            });

            $('#imageUpload').change(function (e) {
                const file = e.target.files[0];
                if (file) {
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(file.type)) {
                        alert('لطفاً یک فایل تصویر معتبر انتخاب کنید (JPG, PNG, GIF)');
                        $(this).val('');
                        return;
                    }

                    if (file.size > 5 * 1024 * 1024) {
                        alert('حجم فایل نباید بیشتر از 5 مگابایت باشد');
                        $(this).val('');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#imagePreview').html(`
                            <div class="alert alert-info">
                                تصویر جدید انتخاب شد
                                <button type="button" class="btn-close float-start" onclick="$('#imagePreview').empty(); $('#imageUpload').val('');"></button>
                            </div>
                            <img src="${e.target.result}" alt="پیش‌نمایش تصویر" class="mt-2" />
                            <div class="mt-1">
                                <small class="text-muted">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                            </div>
                        `);

                        $('#currentImage').hide();
                        $('.alert.alert-warning').hide();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // تأیید فرم قبل از ارسال
            $('#editProductForm').submit(function (e) {
                const price = $('#Price').val();
                const stock = $('#StockQuantity').val();

                if (price && price <= 0) {
                    alert('قیمت باید بیشتر از صفر باشد');
                    e.preventDefault();
                    return;
                }

                if (stock && stock < 0) {
                    alert('موجودی نمی‌تواند منفی باشد');
                    e.preventDefault();
                    return;
                }

                // نمایش پیام ذخیره‌سازی
                $('#saveButton').html('در حال ذخیره...').prop('disabled', true);
            });

            // مخفی کردن خودکار پیام‌ها بعد از 5 ثانیه
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
        });
    </script>
}

--------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\Index.cshtml

@model MyShopProject.Controllers.AdminDashboardViewModel
@{
    ViewData["Title"] = "داشبورد مدیریت";
}
<div class="container-fluid py-4">
    <!-- هدر صفحه -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h3 mb-0 text-primary">
                                داشبورد مدیریت
                            </h1>
                            <p class="text-muted mb-0">مدیریت کامل فروشگاه آنلاین</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <a href="/Admin/Products" class="btn btn-outline-primary">
                                    مدیریت محصولات
                                </a>
                                <a href="/Products" class="btn btn-outline-secondary">
                                    مشاهده فروشگاه
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- کارت‌های آمار -->
    <div class="row mb-4">
        <!-- کل محصولات -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                کل محصولات
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalProducts</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-box-seam fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- کل کاربران -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                کل کاربران
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalUsers</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- دسته‌بندی‌ها -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                دسته‌بندی‌ها
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalCategories</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-tags fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- محصولات کم موجود -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                محصولات کم موجود
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.LowStockProducts</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- محصولات اخیر و منوی سریع -->
    <div class="row">
        <!-- محصولات اخیرا اضافه شده -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        محصولات اخیرا اضافه شده
                    </h6>
                </div>
                <div class="card-body">
                    @if (Model.RecentProducts.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="recentProductsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>تصویر</th>
                                        <th>نام محصول</th>
                                        <th>برند</th>
                                        <th>قیمت</th>
                                        <th>موجودی</th>
                                        <th>دسته‌بندی</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var product in Model.RecentProducts)
                                    {
                                        <tr>
                                            <td>
                                                @if (!string.IsNullOrEmpty(product.ImageUrl))
                                                {
                                                    <img src="@Url.Content(product.ImageUrl)" alt="@product.ProductName"
                                                         class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                                                }
                                                else
                                                {
                                                    <div class="bg-light d-flex align-items-center justify-content-center"
                                                         style="width: 50px; height: 50px;">
                                                        <i class="bi bi-image text-muted"></i>
                                                    </div>
                                                }
                                            </td>
                                            <td>@product.ProductName</td>
                                            <td>@product.Brand</td>
                                            <td>@product.Price.ToString("N0") تومان</td>
                                            <td>
                                                <span class="badge @(product.StockQuantity < 10 ? "bg-warning" : "bg-success")">
                                                    @product.StockQuantity
                                                </span>
                                            </td>
                                            <td>@product.Category?.CategoryName</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="text-muted mt-3">هنوز محصولی اضافه نشده است</p>
                            <a href="/Admin/CreateProduct" class="btn btn-primary mt-2">
                                افزودن محصول جدید
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
        <!-- منوی سریع -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h6 class="m-0 font-weight-bold">
                        دسترسی سریع
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/Admin/Products" class="btn btn-outline-primary btn-lg text-start">
                            مدیریت محصولات
                            <span class="badge bg-primary float-end">@Model.TotalProducts</span>
                        </a>
                        <a href="/Admin/Categories" class="btn btn-outline-info btn-lg text-start">
                            مدیریت دسته‌بندی‌ها
                            <span class="badge bg-info float-end">@Model.TotalCategories</span>
                        </a>
                        <a asp-area="Admin" asp-controller="Users" asp-action="Index" class="btn btn-success btn-lg text-start">
                            مدیریت کاربران
                            <span class="badge bg-light text-success float-end">@Model.TotalUsers</span>
                        </a>
                        <a href="/Admin/LowStock" class="btn btn-outline-warning btn-lg text-start">
                            محصولات کم موجود
                            <span class="badge bg-warning float-end">@Model.LowStockProducts</span>
                        </a>
                        <hr class="my-3">
                        <a href="/Admin/CreateProduct" class="btn btn-primary btn-lg text-start">
                            افزودن محصول جدید
                        </a>
                    </div>
                </div>
            </div>
            <!-- کارت اطلاعات سیستم -->
            <div class="card shadow mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        اطلاعات سیستم
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">کاربر فعلی:</small>
                        <div class="fw-bold">@Context.Session.GetString("Name")</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">نقش:</small>
                        <div>
                            <span class="badge bg-success">@Context.Session.GetString("Role")</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">زمان ورود:</small>
                        <div class="fw-bold">@DateTime.Now.ToString("yyyy/MM/dd HH:mm")</div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <a href="/Account/Logout" class="btn btn-outline-danger btn-sm">
                            خروج از سیستم
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- استایل‌های داخلی -->
<style>
    .card {
        border: none;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }

    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }

    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }

    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }

    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }

    .btn-lg {
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

        .btn-lg:hover {
            transform: translateX(-5px);
        }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #6c757d;
    }

    #recentProductsTable img {
        border-radius: 8px;
    }

    .badge {
        font-size: 0.75em;
    }
</style>
<!-- اسکریپت‌های داخلی -->
<script>
    // فعال کردن tooltip‌ها
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        // به‌روزرسانی خودکار هر 30 ثانیه
        setInterval(function() {
            console.log('به‌روزرسانی آمار...');
        }, 30000);
        // نمایش پیام‌های TempData
        showTempMessages();
    });
    // نمایش پیام‌های TempData
    function showTempMessages() {
        const successMessage = '@TempData["SuccessMessage"]';
        const errorMessage = '@TempData["ErrorMessage"]';
        if (successMessage) {
            showToast('success', successMessage);
        }
        if (errorMessage) {
            showToast('error', errorMessage);
        }
    }
    // تابع نمایش toast
    function showToast(type, message) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0 position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" style="z-index: 9999">
                <div class="d-flex">
                    <div class="toast-body">
                        ${type === 'success' ? 'success' : 'error'} ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        const toastElement = document.createElement('div');
        toastElement.innerHTML = toastHtml;
        document.body.appendChild(toastElement.firstElementChild);
        const toast = new bootstrap.Toast(toastElement.firstElementChild);
        toast.show();
        toastElement.firstElementChild.addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    }
</script>

-------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\LowStock.cshtml

@model List<MyShopProject.Models.Product>
@{
    ViewData["Title"] = "محصولات کم موجود";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h1 class="h3 mb-0 text-primary">
                        <i class="bi bi-exclamation-triangle"></i>
                        محصولات کم موجود
                    </h1>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <p>صفحه محصولات کم موجود - به زودی...</p>
            <a href="/Admin" class="btn btn-secondary">بازگشت به داشبورد</a>
        </div>
    </div>
</div>

--------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\Products.cshtml

@model List<MyShopProject.Models.Product>
@{
    ViewData["Title"] = "مدیریت محصولات";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid py-4">
    <!-- هدر صفحه -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="h3 mb-0 text-primary">
                                مدیریت محصولات
                            </h1>
                            <p class="text-muted mb-0">مدیریت و ویرایش محصولات فروشگاه</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="@Url.Action("CreateProduct")" class="btn btn-primary">
                                افزودن محصول جدید
                            </a>
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                بازگشت به داشبورد
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- کارت محصولات -->
    <div class="card shadow">
        <div class="card-header bg-white">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">لیست محصولات (@Model.Count)</h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="جستجو در محصولات...">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">
                            جستجو
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped" id="productsTable">
                        <thead class="table-dark">
                            <tr>
                                <th width="80">تصویر</th>
                                <th>نام محصول</th>
                                <th>برند</th>
                                <th>قیمت</th>
                                <th>موجودی</th>
                                <th>دسته‌بندی</th>
                                <th width="200">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in Model)
                            {
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(product.ImageUrl))
                                        {
                                            <img src="@Url.Content(product.ImageUrl)" alt="@product.ProductName"
                                                 class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="bg-light d-flex align-items-center justify-content-center rounded"
                                                 style="width: 60px; height: 60px;">
                                                <i class="fas fa-image text-muted fs-4"></i>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <div class="fw-bold">@product.ProductName</div>
                                        @if (!string.IsNullOrEmpty(product.Color))
                                        {
                                            <small class="text-muted">رنگ: @product.Color</small>
                                        }
                                    </td>
                                    <td>@product.Brand</td>
                                    <td>
                                        <span class="fw-bold text-success">@product.Price.ToString("N0")</span>
                                        <small class="text-muted">تومان</small>
                                    </td>
                                    <td>
                                        <span class="badge @GetStockBadgeClass(product.StockQuantity)">
                                            @product.StockQuantity
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@product.Category?.CategoryName</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- دکمه ویرایش -->
                                            <a href="@Url.Action("EditProduct", new { id = product.ProductID })"
                                               class="btn btn-warning btn-sm"
                                               data-bs-toggle="tooltip"
                                               title="ویرایش محصول">
                                                ویرایش
                                            </a>

                                            <!-- دکمه حذف -->
                                            <button type="button"
                                                    class="btn btn-danger btn-sm delete-product"
                                                    data-product-id="@product.ProductID"
                                                    data-product-name="@product.ProductName"
                                                    data-bs-toggle="tooltip"
                                                    title="حذف محصول">
                                                حذف
                                            </button>

                                            <!-- دکمه مشاهده -->
                                            <a href="@Url.Action("Details", "Products", new { id = product.ProductID })"
                                               class="btn btn-info btn-sm"
                                               target="_blank"
                                               data-bs-toggle="tooltip"
                                               title="مشاهده در فروشگاه">
                                                مشاهده
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-inbox display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">هنوز محصولی وجود ندارد</h4>
                    <p class="text-muted">اولین محصول خود را اضافه کنید</p>
                    <a href="@Url.Action("CreateProduct")" class="btn btn-primary btn-lg mt-3">
                        افزودن محصول جدید
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- مودال حذف محصول -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">حذف محصول</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>آیا از حذف محصول "<span id="productNameToDelete"></span>" مطمئن هستید؟</p>
                <p class="text-danger small">این عمل غیرقابل بازگشت است!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <form id="deleteForm" method="post" action="@Url.Action("DeleteProduct")">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="deleteProductId" value="" />
                    <button type="submit" class="btn btn-danger">حذف محصول</button>
                </form>
            </div>
        </div>
    </div>
</div>

@functions {
    public string GetStockBadgeClass(int stockQuantity)
    {
        return stockQuantity switch
        {
            0 => "bg-danger",
            < 10 => "bg-warning",
            _ => "bg-success"
        };
    }
}

@section Styles {
    <style>
        .table th {
            font-weight: 600;
            background-color: #f8f9fa;
            text-align: center;
        }

        .table td {
            text-align: center;
            vertical-align: middle;
        }

        .img-thumbnail {
            border-radius: 8px;
        }

        .btn-group-sm .btn {
            padding: 0.4rem 0.6rem;
            margin: 0 2px;
        }

        .btn-warning {
            color: white;
            background-color: #ffc107;
            border-color: #ffc107;
        }

            .btn-warning:hover {
                background-color: #e0a800;
                border-color: #d39e00;
                color: white;
            }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // فعال کردن tooltip‌ها
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // جستجو در جدول
            $('#searchButton').click(function() {
                filterTable();
            });

            $('#searchInput').on('keyup', function() {
                filterTable();
            });

            function filterTable() {
                const searchText = $('#searchInput').val().toLowerCase();
                $('#productsTable tbody tr').each(function() {
                    const rowText = $(this).text().toLowerCase();
                    $(this).toggle(rowText.includes(searchText));
                });
            }

            // مدیریت حذف محصول
            $('.delete-product').click(function() {
                const productId = $(this).data('product-id');
                const productName = $(this).data('product-name');

                $('#productNameToDelete').text(productName);
                $('#deleteProductId').val(productId);

                var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            });

            // نمایش پیام‌های TempData
            showTempMessages();
        });

        function showTempMessages() {
            const successMessage = '@TempData["SuccessMessage"]';
            const errorMessage = '@TempData["ErrorMessage"]';

            if (successMessage) {
                showToast('success', successMessage);
            }

            if (errorMessage) {
                showToast('error', errorMessage);
            }
        }

        function showToast(type, message) {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', function () {
                toastContainer.remove();
            });
        }
    </script>
}

----------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Admin\Users.cshtml

@model List<MyShopProject.Models.User>
@{
    ViewData["Title"] = "مدیریت کاربران";

    // مقدار فعلی فیلترها
    var currentSearch = Context.Request.Query["search"].ToString();
    var currentProvince = Context.Request.Query["province"].ToString();
    var currentRole = Context.Request.Query["role"].ToString();
}

<div class="container-fluid py-4" dir="rtl">
    <!-- هدر -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-0 text-primary">
                                مدیریت کاربران
                            </h1>
                            <p class="text-muted mb-0">مدیریت کامل کاربران فروشگاه</p>
                        </div>
                        <a href="/Admin" class="btn btn-outline-secondary">
                            بازگشت به داشبورد
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فیلتر و جستجو -->
    <div class="card shadow border-0 mb-4">
        <div class="card-body">
            <form asp-action="Index" method="get" class="row g-3">
                <div class="col-md-3">
                    <input type="text" name="search" class="form-control" placeholder="جستجو در نام، ایمیل یا تلفن..."
                           value="@currentSearch" />
                </div>
                <div class="col-md-3">
                    <select name="province" class="form-select province-autocomplete">
                        <option value="">همه استان‌ها</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="role" class="form-select">
                        <option value="">همه نقش‌ها</option>
                        <option value="Admin" selected="@(currentRole == "Admin")">مدیر</option>
                        <option value="User" selected="@(currentRole == "User")">کاربر</option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-primary">
                        فیلتر
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- جدول کاربران -->
    <div class="card shadow border-0">
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="text-center">
                                    <input type="checkbox" class="form-check-input" id="selectAll" />
                                </th>
                                <th>نام</th>
                                <th>ایمیل</th>
                                <th>تلفن</th>
                                <th>استان</th>
                                <th>نقش</th>
                                <th>تاریخ ثبت</th>
                                <th class="text-center">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model)
                            {
                                <tr>
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input user-checkbox" value="@user.UserID" />
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-3 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                @(string.IsNullOrEmpty(user.FirstName) ? "?" : user.FirstName.Substring(0, 1).ToUpper())
                                            </div>
                                            <div>
                                                <div class="fw-bold">@(user.FirstName ?? "") @(user.LastName ?? "")</div>
                                                <small class="text-muted">@user.UserID</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="mailto:@user.Email" class="text-decoration-none">@user.Email</a>
                                    </td>
                                    <td dir="ltr" class="text-start">@user.PhoneNumber</td>
                                    <td>
                                        <span class="badge bg-info text-dark">
                                            @(string.IsNullOrEmpty(user.Province) ? "نامشخص" : user.Province)
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge @(user.IsAdmin ? "bg-success" : "bg-secondary")">
                                            @(user.IsAdmin ? "مدیر" : "کاربر")
                                        </span>
                                    </td>
                                    <td>
                                        @user.CreatedAt.ToString("yyyy/MM/dd")
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="/Admin/Users/Edit/@user.UserID" class="btn btn-sm btn-warning text-white" title="ویرایش">
                                                ویرایش
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger" title="حذف"
                                                    onclick="confirmDelete(@user.UserID, '@(user.FirstName ?? "کاربر")')">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-people display-1 text-muted"></i>
                    <p class="mt-3 text-muted">کاربری یافت نشد</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- لیست استان‌های ایران + Select2 -->
@section Scripts {
    <script>
        const provinces = [
            "آذربایجان شرقی", "آذربایجان غربی", "اردبیل", "اصفهان", "البرز", "ایلام", "بوشهر",
            "تهران", "چهارمحال و بختیاری", "خراسان جنوبی", "خراسان رضوی", "خراسان شمالی",
            "خوزستان", "زنجان", "سمنان", "سیستان و بلوچستان", "فارس", "قزوین", "قم",
            "کردستان", "کرمان", "کرمانشاه", "کهگیلویه و بویراحمد", "گلستان", "گیلان",
            "لرستان", "مازندران", "مرکزی", "هرمزگان", "همدان", "یزد"
        ];

        document.addEventListener('DOMContentLoaded', function () {
            const select = document.querySelector('.province-autocomplete');
            const currentValue = '@currentProvince';

            provinces.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.text = p;
                if (p === currentValue) option.selected = true;
                select.appendChild(option);
            });

            $(select).select2({
                placeholder: "استان را جستجو کنید...",
                allowClear: true,
                dir: "rtl",
                language: { noResults: () => "استان یافت نشد" }
            });

            document.getElementById('selectAll').addEventListener('change', function () {
                document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = this.checked);
            });
        });

        function confirmDelete(userId, name) {
            if (confirm(`آیا از حذف کاربر "${name}" اطمینان دارید؟`)) {
                const form = document.createElement('form');
                form.method = 'post';
                form.action = `/Admin/Users/Delete/${userId}`;
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}

<!-- استایل‌های داخلی -->
<style>
    .avatar-sm {
        font-size: 0.9rem;
        font-weight: bold;
    }

    .table th, .table td {
        vertical-align: middle;
    }

    .btn-sm {
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }

        .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

    .select2-container--default .select2-selection--single {
        height: 38px;
        border-radius: 8px;
        border: 1px solid #ced4da;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            padding-right: 30px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
            right: 8px;
        }
</style>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

--------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Cart\Index.cshtml

@model IEnumerable<MyShopProject.Controllers.CartItemViewModel>

@{
    ViewData["Title"] = "سبد خرید شما";
    var isGuest = ViewBag.IsGuest as bool? ?? false;
}

<div class="container mt-4 cart-page-container">
    <h1 class="text-center mb-4">@ViewData["Title"]</h1>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            <h4>سبد خرید شما خالی است</h4>
            <p>می‌توانید از <a href="@Url.Action("Index", "Products")">صفحه محصولات</a> خرید کنید.</p>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-4 order-md-2 mb-4">
                <div class="card order-summary-card sticky-summary">
                    <div class="card-header bg-primary text-white" style="padding: 0.5rem 1rem;">
                        <h5 class="mb-0" style="font-size: 1rem;">خلاصه سفارش</h5>
                    </div>
                    <div class="card-body d-flex flex-column" style="padding: 1rem;">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between mb-2">
                                <span style="font-size: 0.9rem;">تعداد کالاها:</span>
                                <span class="fw-bold" id="summaryItemCount" style="font-size: 0.9rem;">@ViewBag.TotalItemsCount عدد</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <strong style="font-size: 0.9rem;">جمع کل:</strong>
                                <strong class="text-success" id="summaryTotalAmount" style="font-size: 1rem;">@ViewBag.TotalAmount.ToString("N0") تومان</strong>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <a href="@Url.Action("Index", "Products")" class="btn btn-primary w-100 mb-2" id="continueShopping" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                ادامه خرید
                            </a>

                            @if (isGuest)
                            {
                                <a href="@Url.Action("Login", "Account", new { returnUrl = Url.Action("Index", "Cart") })"
                                   class="btn btn-success w-100" id="checkoutBtn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                    صدور فاکتور (ورود required)
                                </a>
                                <div class="alert alert-warning mt-2" style="font-size: 0.8rem;">
                                    برای صدور فاکتور لطفاً وارد حساب کاربری خود شوید. سبد خرید شما حفظ خواهد شد.
                                </div>
                            }
                            else
                            {
                                <a href="@Url.Action("CreateFromCart", "Order")" class="btn btn-success w-100" id="checkoutBtn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                    صدور فاکتور
                                </a>
                            }

                            <div class="mt-2 pt-2 border-top">
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    امکان تغییر تعداد و حذف محصولات در همین صفحه وجود دارد.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8 order-md-1">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">محصولات انتخابی شما</h5>
                    </div>
                    <div class="card-body" id="cartItemsContainer">
                        @foreach (var item in Model)
                        {
                            var productName = item.Product?.ProductName ?? "محصول";
                            var brandName = item.Product?.Brand ?? "نامشخص";

                            <div class="cart-item border-bottom pb-3 mb-3" data-cart-item-id="@item.CartItemID" data-product-price="@item.Product?.Price ?? 0">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                                        {
                                            <img src="@Url.Content(item.Product.ImageUrl)"
                                                 class="img-fluid rounded"
                                                 alt="@productName"
                                                 style="max-height: 80px; object-fit: cover;"
                                                 onerror="this.src='/images/placeholder.jpg'">
                                        }
                                        else
                                        {
                                            <img src="/images/placeholder.jpg"
                                                 class="img-fluid rounded"
                                                 alt="بدون تصویر"
                                                 style="max-height: 80px; object-fit: cover;">
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="product-name">@Html.Raw(productName)</h6>
                                        <p class="text-muted mb-1 brand-name">@Html.Raw(brandName)</p>
                                        <p class="text-success mb-0">
                                            <span class="product-price">@((item.Product?.Price ?? 0).ToString("N0"))</span> تومان
                                            <br>
                                            <small class="text-muted">(قیمت واحد)</small>
                                        </p>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group" style="max-width: 140px;">
                                            <button class="btn btn-outline-secondary decrease-btn" type="button">-</button>
                                            <input type="number" class="form-control text-center quantity-input"
                                                   value="@item.Quantity" min="1" max="@((item.Product?.StockQuantity ?? 0) + item.Quantity)">
                                            <button class="btn btn-outline-secondary increase-btn" type="button">+</button>
                                        </div>
                                        <small class="text-muted d-block mt-1">موجودی: @((item.Product?.StockQuantity ?? 0) + item.Quantity) عدد</small>
                                    </div>
                                    <div class="col-md-2">
                                        <h6 class="item-total text-success">@(((item.Product?.Price ?? 0) * item.Quantity).ToString("N0")) تومان</h6>
                                        <small class="text-muted">قیمت کل</small>
                                    </div>
                                    <div class="col-md-1">
                                        <button class="btn btn-outline-danger btn-sm remove-btn" title="حذف از سبد خرید">
                                            حذف
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Styles {
    <style>
        .sticky-summary {
            position: sticky;
            left: 14rem !important;
            z-index: 100;
            transition: all 0.3s ease;
            width: 100%;
            height: 273px !important;
            max-height: 273px !important;
            overflow-y: auto;
            margin-top: -0.70rem !important;
        }

        .order-summary-card {
            border: 2px solid #3498db;
            box-shadow: 0 4px 15px RGBA(52, 152, 219, 0.2);
            transition: all 0.3s ease;
            height: 273px !important;
            min-height: 273px !important;
            transform: translateY(-0.8rem);
        }

            .order-summary-card .card-body {
                min-height: 200px !important;
                height: 200px !important;
                padding: 1rem !important;
                display: flex !important;
                flex-direction: column !important;
            }

        .cart-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .cart-page-container {
            min-height: calc(100vh - 200px);
            padding-bottom: 2rem;
        }

        @@media (max-width: 768px) {
            .sticky-summary {
                position: relative;
                top: 0 !important;
                margin-top: 1rem !important;
                height: auto !important;
                max-height: none !important;
                transform: none !important;
            }

            .order-summary-card {
                height: auto !important;
                min-height: auto !important;
                transform: none !important;
            }

                .order-summary-card .card-body {
                    min-height: auto !important;
                    height: auto !important;
                }

            .cart-page-container {
                min-height: auto;
                padding-bottom: 1rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        function initializeCartSummaryPosition() {
            const summary = $('.sticky-summary');
            if (!summary.length) return;
            if ($(window).width() <= 768) {
                summary.css({
                    'position': 'relative',
                    'top': 'auto',
                    'height': 'auto',
                    'max-height': 'none',
                    'margin-top': '1rem',
                    'transform': 'none'
                });
                $('.order-summary-card').css({ 'transform': 'none' });
                return;
            }
            summary.css({
                'position': 'sticky',
                'top': '4rem',
                'height': '273px',
                'max-height': '273px',
                'margin-top': '-0.70rem'
            });
            $('.order-summary-card').css({ 'transform': 'translateY(-0.8rem)' });
        }

        $(document).on('click', '.increase-btn', function () {
            var input = $(this).siblings('.quantity-input');
            var currentVal = parseInt(input.val());
            var maxVal = parseInt(input.attr('max'));
            if (currentVal < maxVal) {
                input.val(currentVal + 1);
                updateQuantity(input);
            } else {
                showToast('warning', 'تعداد انتخابی بیشتر از موجودی است');
            }
        });

        $(document).on('click', '.decrease-btn', function () {
            var input = $(this).siblings('.quantity-input');
            var currentVal = parseInt(input.val());
            if (currentVal > 1) {
                input.val(currentVal - 1);
                updateQuantity(input);
            }
        });

        $(document).on('change', '.quantity-input', function () {
            var input = $(this);
            var currentVal = parseInt(input.val());
            var maxVal = parseInt(input.attr('max'));
            var minVal = parseInt(input.attr('min'));
            if (currentVal < minVal) {
                input.val(minVal);
                showToast('warning', 'تعداد نمی‌تواند کمتر از 1 باشد');
                return;
            }
            if (currentVal > maxVal) {
                input.val(maxVal);
                showToast('warning', 'تعداد انتخابی بیشتر از موجودی است');
                return;
            }
            updateQuantity(input);
        });

        $(document).on('click', '.remove-btn', function () {
            var cartItemId = $(this).closest('.cart-item').data('cart-item-id');
            var productName = $(this).closest('.cart-item').find('.product-name').text();
            removeFromCart(cartItemId, productName);
        });

        function updateQuantity(input) {
            var cartItem = input.closest('.cart-item');
            var cartItemId = cartItem.data('cart-item-id');
            var newQuantity = parseInt(input.val());
            var productPrice = parseFloat(cartItem.data('product-price'));
            var itemTotalElement = cartItem.find('.item-total');
            var originalText = itemTotalElement.text();
            itemTotalElement.html('<span class="spinner-border spinner-border-sm"></span> در حال به روزرسانی...');
            var tempTotal = (productPrice * newQuantity).toLocaleString();
            itemTotalElement.text(tempTotal + ' تومان');

            $.ajax({
                url: '/Cart/UpdateQuantity',
                type: 'POST',
                data: { cartItemId: cartItemId, newQuantity: newQuantity },
                success: function (response) {
                    if (response.success) {
                        itemTotalElement.text(response.itemTotal.toLocaleString() + ' تومان');
                        $('#summaryTotalAmount').text(response.totalAmount.toLocaleString() + ' تومان');
                        $('#summaryItemCount').text(response.totalItems + ' عدد');
                        updateCartCount();
                        showToast('success', 'تعداد محصول با موفقیت به روزرسانی شد');
                    } else {
                        itemTotalElement.text(originalText);
                        showToast('error', response.message);
                        setTimeout(() => location.reload(), 2000);
                    }
                },
                error: function () {
                    itemTotalElement.text(originalText);
                    showToast('error', 'خطا در بروزرسانی تعداد');
                }
            });
        }

        function removeFromCart(cartItemId, productName) {
            if (!confirm(`آیا از حذف "${productName}" از سبد خرید اطمینان دارید؟`)) return;
            var cartItem = $('.cart-item[data-cart-item-id="' + cartItemId + '"]');
            cartItem.find('.remove-btn').html('<span class="spinner-border spinner-border-sm"></span>');
            cartItem.find('.remove-btn').prop('disabled', true);

            $.ajax({
                url: '/Cart/RemoveFromCart',
                type: 'POST',
                data: { cartItemId: cartItemId },
                success: function (response) {
                    if (response.success) {
                        cartItem.fadeOut(300, function() {
                            $(this).remove();
                            $('#summaryTotalAmount').text(response.totalAmount.toLocaleString() + ' تومان');
                            $('#summaryItemCount').text(response.totalItems + ' عدد');
                            updateCartCount();
                            showToast('success', response.message);
                            if ($('.cart-item').length === 0) setTimeout(() => location.reload(), 1500);
                        });
                    } else {
                        cartItem.find('.remove-btn').html('حذف');
                        cartItem.find('.remove-btn').prop('disabled', false);
                        showToast('error', response.message);
                    }
                },
                error: function () {
                    cartItem.find('.remove-btn').html('حذف');
                    cartItem.find('.remove-btn').prop('disabled', false);
                    showToast('error', 'خطا در حذف محصول از سبد خرید');
                }
            });
        }

        $('#continueShopping').click(function (e) { e.preventDefault(); window.location.href = '@Url.Action("Index", "Products")'; });

        $('#checkoutBtn').click(function (e) {
        @if (isGuest)
        {
            @:e.preventDefault();
            @:var returnUrl = '@Url.Action("Index", "Cart")';
            @:window.location.href = '@Url.Action("Login", "Account")' + '?returnUrl=' + encodeURIComponent(returnUrl);
        }
        else
        {
            @:var totalAmount = @ViewBag.TotalAmount;
            @:if (totalAmount <= 0) {
            @:    e.preventDefault();
            @:    showToast('warning', 'سبد خرید شما خالی است');
            @:}
        }
        });

        function updateCartCount() {
            $.ajax({
                url: '/Cart/GetCartItemCount',
                type: 'GET',
                success: function (response) {
                    $('#cartCount').text(response.count);
                    $('#floatingCartCount').text(response.count);
                },
                error: function () {
                    console.log('خطا در به روزرسانی تعداد سبد خرید');
                    $('#cartCount').text('0');
                    $('#floatingCartCount').text('0');
                    setTimeout(updateCartCount, 2000);
                }
            });
        }

        function showToast(type, message) {
            var toastClass = '', icon = '';
            switch(type) {
                case 'success': toastClass = 'alert-success'; icon = 'success'; break;
                case 'error': toastClass = 'alert-danger'; icon = 'error'; break;
                case 'warning': toastClass = 'alert-warning'; icon = 'warning'; break;
                case 'info': toastClass = 'alert-info'; icon = 'info'; break;
                default: toastClass = 'alert-info'; icon = 'idea';
            }
            var toastId = 'toast-' + Date.now();
            var toastHtml = `
                <div id="${toastId}" class="alert ${toastClass} alert-dismissible fade show position-fixed"
                     style="top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;">
                    <strong>${icon}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').append(toastHtml);
            setTimeout(() => $('#' + toastId).alert('close'), 4000);
        }

        $(document).ready(function () {
            setTimeout(() => initializeCartSummaryPosition(), 100);
            $(window).resize(() => setTimeout(() => initializeCartSummaryPosition(), 100));
            updateCartCount();
        });
    </script>
}

------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Home\Index.cshtml

@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
</div>



-------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Home\Privacy.cshtml

@{
    ViewData["Title"] = "Privacy Policy";
}
<h1>@ViewData["Title"]</h1>

<p>Use this page to detail your site's privacy policy.</p>

--------------------------------------------------------------------------------------

D:\MyShopProject\Views\Order\Checkout.cshtml
@model MyShopProject.Models.CheckoutViewModel
@{
    ViewData["Title"] = "فاکتور نهایی و پرداخت";
}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h4 class="mb-0 fw-bold">فاکتور نهایی</h4>
                </div>
                <div class="card-body p-0">
                    <form asp-action="CreateFromCart" method="post" id="checkoutForm">
                        @Html.AntiForgeryToken()
                        <div class="row g-0">
                            <!-- اطلاعات ارسال + پرداخت -->
                            <div class="col-lg-6 p-4 print-hide">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-secondary text-white">
                                        <h5 class="mb-0">اطلاعات ارسال</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="ShippingAddress" class="form-label fw-bold"></label>
                                            <textarea asp-for="ShippingAddress" class="form-control" rows="3"
                                                      placeholder="آدرس کامل خود را وارد کنید..."></textarea>
                                            <span asp-validation-for="ShippingAddress" class="text-danger small"></span>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label asp-for="ShippingPostalCode" class="form-label fw-bold"></label>
                                                <input asp-for="ShippingPostalCode" class="form-control"
                                                       placeholder="1234567890" maxlength="10">
                                                <span asp-validation-for="ShippingPostalCode" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label asp-for="ContactPhone" class="form-label fw-bold"></label>
                                                <input asp-for="ContactPhone" class="form-control"
                                                       placeholder="09123456789">
                                                <span asp-validation-for="ContactPhone" class="text-danger small"></span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">یادداشت سفارش (اختیاری)</label>
                                            <textarea asp-for="OrderNote" class="form-control" rows="2"
                                                      placeholder="یادداشت‌های اضافی (اختیاری)...">@Model.OrderNote</textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- فرم پرداخت -->
                                <div class="card border-0 bg-light mt-3">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">پرداخت آنلاین (کارت به کارت)</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info small mb-3">
                                            <strong>شماره حساب دریافت وجه:</strong><br>
                                            <code class="text-dark">6037-9970-1234-5678</code><br>
                                            <small>به نام: <strong>آقای احمدی</strong> — بانک ملت</small>
                                        </div>
                                        <div class="mb-3">
                                            <label asp-for="CardNumber" class="form-label fw-bold"></label>
                                            <input asp-for="CardNumber" class="form-control text-center"
                                                   placeholder="6037997012345678" maxlength="16">
                                            <span asp-validation-for="CardNumber" class="text-danger small"></span>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label asp-for="Password" class="form-label fw-bold"></label>
                                                <input asp-for="Password" type="password" class="form-control text-center"
                                                       placeholder="1234" maxlength="4">
                                                <span asp-validation-for="Password" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label asp-for="CVV2" class="form-label fw-bold"></label>
                                                <input asp-for="CVV2" type="password" class="form-control text-center"
                                                       placeholder="123" maxlength="3">
                                                <span asp-validation-for="CVV2" class="text-danger small"></span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label asp-for="ExpiryDate" class="form-label fw-bold"></label>
                                            <input asp-for="ExpiryDate" class="form-control text-center"
                                                   placeholder="12/28" maxlength="5">
                                            <span asp-validation-for="ExpiryDate" class="text-danger small"></span>
                                        </div>
                                        <div class="alert alert-warning small">
                                            <strong>تست پرداخت:</strong><br>
                                            شماره کارت: <code>6037997012345678</code><br>
                                            رمز دوم: <code>1234</code> | CVV2: <code>123</code> | تاریخ: <code>12/28</code>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- فاکتور نهایی -->
                            <div class="col-lg-6 bg-white p-4">
                                <div class="invoice-container">
                                    <!-- هدر فاکتور -->
                                    <div class="invoice-header border-bottom pb-3 mb-4 print-header">
                                        <div class="row align-items-center">
                                            <div class="col-8">
                                                <h4 class="fw-bold text-dark mb-1">فروشگاه MyShop</h4>
                                                <small class="text-muted">سامانه فروش آنلاین</small>
                                            </div>
                                            <div class="col-4 text-end">
                                                <!-- لوگوی ثابت — بدون media -->
                                                <img src="/images/logo.png" alt="MyShop Logo" class="img-fluid" style="max-height: 60px;">
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 text-end">
                                                <small class="text-muted">تاریخ: @Model.CurrentDatePersian</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- اطلاعات مشتری -->
                                    <div class="customer-info mb-4 print-customer-info">
                                        <div class="customer-info-horizontal small text-muted">
                                            <div class="info-row">
                                                <span class="info-item">نام: <span class="text-dark fw-bold">@Model.UserFullName</span></span>
                                                <span class="info-item">تلفن: <span class="text-dark fw-bold">@Model.ContactPhone</span></span>
                                                <span class="info-item">کد پستی: <span class="text-dark fw-bold">@Model.ShippingPostalCode</span></span>
                                            </div>
                                            <div class="address-row">آدرس: <span class="text-dark fw-bold">@Model.ShippingAddress</span></div>
                                        </div>
                                    </div>

                                    <!-- جدول محصولات -->
                                    <div class="invoice-table mb-4">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-sm mb-0">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th class="text-center py-2" style="width: 40%">مدل و مشخصات کالا</th>
                                                        <th class="text-center py-2" style="width: 15%">قیمت واحد (ریال)</th>
                                                        <th class="text-center py-2" style="width: 15%">تعداد</th>
                                                        <th class="text-center py-2" style="width: 30%">قیمت کل (ریال)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.CartItems)
                                                    {
                                                        var unitPriceRial = item.Product.Price * 10;
                                                        var totalPriceRial = (item.Quantity * item.Product.Price) * 10;
                                                        <tr class="invoice-item">
                                                            <td class="py-2">
                                                                <div class="fw-bold">@item.Product.ProductName</div>
                                                                <small class="text-muted">@item.Product.Brand</small>
                                                                @if (!string.IsNullOrEmpty(item.Product.ImageUrl))
                                                                {
                                                                    <!-- تصویر محصول — بدون media -->
                                                                    <div class="mt-1">
                                                                        <img src="@item.Product.ImageUrl" alt="@item.Product.ProductName"
                                                                             class="img-fluid" style="max-height: 40px; border-radius: 4px;">
                                                                    </div>
                                                                }
                                                            </td>
                                                            <td class="text-center py-2 fw-bold">@unitPriceRial.ToString("N0")</td>
                                                            <td class="text-center py-2">@item.Quantity</td>
                                                            <td class="text-center py-2 fw-bold">@totalPriceRial.ToString("N0")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                                <tfoot class="table-active">
                                                    @{
                                                        var totalAmountRial = Model.TotalAmount * 10;
                                                    }
                                                    <tr>
                                                        <td colspan="3" class="text-end fw-bold py-2">جمع کل فاکتور:</td>
                                                        <td class="text-center fw-bold fs-6 py-2">
                                                            @totalAmountRial.ToString("N0") <strong>ریال</strong>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="3" class="text-end fw-bold py-2">تعداد کل کالاها:</td>
                                                        <td class="text-center fw-bold py-2">@Model.TotalItems عدد</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- دکمه‌های اقدام -->
                                    <div class="action-buttons mt-4 no-print">
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <button type="button" class="btn btn-outline-dark w-100" onclick="window.print()">چاپ فاکتور</button>
                                            </div>
                                            <div class="col-md-4">
                                                <button type="submit" class="btn btn-success w-100" id="confirmOrderBtn">پرداخت نهایی</button>
                                            </div>
                                            <div class="col-md-4">
                                                <a href="@Url.Action("Index", "Cart")" class="btn btn-outline-secondary w-100">بازگشت به سبد خرید</a>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- اطلاعات اضافی -->
                                    <div class="mt-4 pt-3 border-top no-print">
                                        <small class="text-muted">
                                            این فاکتور به منزله رسید خرید بوده و پس از پرداخت نهایی، شماره پیگیری برای شما ارسال خواهد شد.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .invoice-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .invoice-header {
            border-bottom: 2px solid #dee2e6 !important;
        }

        .invoice-table {
            font-size: 0.9rem;
        }

            .invoice-table th {
                font-weight: 600;
                font-size: 0.85rem;
            }

            .invoice-table td {
                vertical-align: middle;
            }

        .invoice-item:hover {
            background-color: #f8f9fa !important;
        }

        .table-bordered {
            border: 1px solid #000 !important;
        }

            .table-bordered th, .table-bordered td {
                border: 1px solid #dee2e6 !important;
            }

        .customer-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .customer-info-horizontal {
            display: flex;
            flex-direction: column;
        }

        .info-row {
            display: flex;
            flex-wrap: nowrap;
            justify-content: space-between;
            gap: 15px;
            align-items: center;
            margin-bottom: 8px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 0;
        }

        .address-row {
            font-size: 0.85rem;
        }

        .print-hide {
            display: block;
        }

        @@media print {
            .no-print, .btn, .action-buttons, .card-header.bg-secondary, .bg-light, .floating-cart, .navbar, .footer, .sticky-summary, .order-summary-card, .form-control, .form-label, .text-danger, .validation-summary-errors, .print-hide {
                display: none !important;
            }

            body {
                background: white !important;
                font-size: 11px !important;
                line-height: 1.1 !important;
                margin: 0 !important;
                padding: 5px !important;
                color: #000 !important;
                width: 100% !important;
            }

            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }

            .invoice-container {
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            .print-header {
                margin-top: 1cm !important;
                margin-bottom: 1px !important;
                padding-bottom: 1px !important;
                border-bottom: 2px solid #000 !important;
            }

                .print-header h4 {
                    font-size: 14px !important;
                    margin-bottom: 0 !important;
                    color: #000 !important;
                    font-weight: bold !important;
                }

                .print-header small {
                    font-size: 10px !important;
                    color: #000 !important;
                    font-weight: bold !important;
                }

            .print-customer-info {
                margin-top: 0 !important;
                margin-bottom: 2px !important;
                padding: 3px 4px !important;
                background: #f8f9fa !important;
                border: 1px solid #000 !important;
                border-radius: 1px !important;
            }

            .info-row {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                justify-content: space-between !important;
                gap: 8px !important;
                font-size: 9px !important;
                margin-bottom: 1px !important;
            }

            .info-item {
                flex: 1 !important;
                display: flex !important;
                align-items: center !important;
                gap: 2px !important;
                min-width: 0 !important;
                text-align: center !important;
            }

            .address-row {
                font-size: 9px !important;
                text-align: right !important;
            }

            .invoice-table {
                margin-top: 2cm !important;
                margin-bottom: 4px !important;
            }

            .table {
                font-size: 9px !important;
                width: 100% !important;
                border-collapse: collapse !important;
            }

                .table th, .table td {
                    padding: 2px 3px !important;
                    border: 1px solid #000 !important;
                    text-align: center !important;
                }

                .table th {
                    background: #f8f9fa !important;
                    font-weight: bold !important;
                    color: #000 !important;
                }

                .table tfoot td {
                    background: #e9ecef !important;
                    font-weight: bold !important;
                    color: #000 !important;
                }

            .card, .card-body, .p-4, .mt-4, .mb-4, .row, .col-lg-6 {
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                width: 100% !important;
            }

            @@page {
                margin: 0.2cm !important;
                size: auto;
            }

            .table tbody tr {
                page-break-inside: avoid;
            }

            .fw-bold {
                font-weight: bold !important;
                color: #000 !important;
            }

            strong {
                font-weight: bold !important;
                color: #000 !important;
            }
        }

        @@media (max-width: 768px) {
            .invoice-table {
                font-size: 0.8rem;
            }

            .action-buttons .btn {
                margin-bottom: 0.5rem;
            }

            .info-row {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .info-item {
                width: 100%;
            }
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            $('#checkoutForm').on('submit', function (e) {
                var submitBtn = $('#confirmOrderBtn');
                var originalText = submitBtn.html();
                submitBtn.prop('disabled', true);
                submitBtn.html(`
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    در حال پردازش پرداخت...
                `);
                if ($(this).valid()) {
                    return true;
                } else {
                    setTimeout(function () {
                        submitBtn.prop('disabled', false);
                        submitBtn.html(originalText);
                    }, 1000);
                    return false;
                }
            });
            $('input, textarea').on('blur', function () {
                $(this).valid();
            });
        });
    </script>
}
-----------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Order\Create.cshtml
@model MyShopProject.Models.CreateOrderViewModel
@{
    ViewData["Title"] = "ثبت سفارش جدید";
    var cartTotal = ViewBag.CartTotal as decimal? ?? 0;
    var cartItems = ViewBag.CartItems as List<MyShopProject.Models.CartItem> ?? new List<MyShopProject.Models.CartItem>();
}

<div class="create-order-container">
    <div class="container-fluid">
        <!-- هدر صفحه -->
        <div class="create-order-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="bi bi-cart-check"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">ثبت سفارش جدید</h1>
                    <p class="header-subtitle">تکمیل اطلاعات و نهایی کردن خرید</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="@Url.Action("Index", "Cart")" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-right btn-icon"></i>
                    بازگشت به سبد خرید
                </a>
            </div>
        </div>

        <!-- نمایش پیام‌ها -->
        <div class="alerts-container">
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                        <span>@TempData["ErrorMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>

        <div class="create-order-content">
            <div class="row g-4">
                <!-- فرم اطلاعات ارسال -->
                <div class="col-lg-8">
                    <div class="shipping-form-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-truck header-icon"></i>
                                <h3 class="card-title">اطلاعات ارسال</h3>
                            </div>
                            <div class="header-badge">
                                <span class="badge bg-primary">الزامی</span>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <form asp-action="Create" method="post" class="shipping-form">
                                @Html.AntiForgeryToken()
                                <div asp-validation-summary="ModelOnly" class="validation-summary"></div>

                                <!-- آدرس ارسال -->
                                <div class="form-group-modern">
                                    <label asp-for="ShippingAddress" class="form-label-modern">
                                        <i class="bi bi-geo-alt input-icon"></i>
                                        آدرس کامل ارسال
                                    </label>
                                    <textarea asp-for="ShippingAddress" class="form-control-modern textarea-modern"
                                              rows="4" placeholder="آدرس کامل خود را وارد کنید"></textarea>
                                    <span asp-validation-for="ShippingAddress" class="validation-message"></span>
                                </div>

                                <!-- کد پستی و شماره تماس -->
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group-modern">
                                            <label asp-for="ShippingPostalCode" class="form-label-modern">
                                                <i class="bi bi-mailbox input-icon"></i>
                                                کد پستی
                                            </label>
                                            <input asp-for="ShippingPostalCode" class="form-control-modern"
                                                   placeholder="۱۰ رقمی" />
                                            <span asp-validation-for="ShippingPostalCode" class="validation-message"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group-modern">
                                            <label asp-for="ContactPhone" class="form-label-modern">
                                                <i class="bi bi-telephone input-icon"></i>
                                                شماره تماس
                                            </label>
                                            <input asp-for="ContactPhone" class="form-control-modern"
                                                   placeholder="09xxxxxxxxx" />
                                            <span asp-validation-for="ContactPhone" class="validation-message"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- یادداشت سفارش -->
                                <div class="form-group-modern">
                                    <label asp-for="OrderNote" class="form-label-modern">
                                        <i class="bi bi-chat-left-text input-icon"></i>
                                        یادداشت سفارش (اختیاری)
                                    </label>
                                    <textarea asp-for="OrderNote" class="form-control-modern textarea-modern"
                                              rows="3" placeholder="یادداشت یا توضیحاتی درباره سفارش..."></textarea>
                                    <span asp-validation-for="OrderNote" class="validation-message"></span>
                                </div>

                                <!-- دکمه‌های اقدام -->
                                <div class="form-actions">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <button type="submit" class="btn btn-success-modern w-100">
                                                <i class="bi bi-check-lg btn-icon"></i>
                                                ثبت نهایی سفارش
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <a href="@Url.Action("Index", "Cart")" class="btn btn-outline-secondary w-100">
                                                <i class="bi bi-arrow-right btn-icon"></i>
                                                بازگشت به سبد خرید
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- خلاصه سفارش -->
                <div class="col-lg-4">
                    <!-- خلاصه محصولات -->
                    <div class="order-summary-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-cart header-icon"></i>
                                <h3 class="card-title">خلاصه سفارش</h3>
                            </div>
                            <div class="header-badge">
                                <span class="badge bg-info">@cartItems.Count مورد</span>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="order-items-summary">
                                @foreach (var item in cartItems)
                                {
                                    <div class="summary-item">
                                        <div class="item-image">
                                            @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                                            {
                                                <img src="@Url.Content(item.Product.ImageUrl)" alt="@item.Product.ProductName" class="img-fluid">
                                            }
                                            else
                                            {
                                                <div class="no-image">
                                                    <i class="bi bi-image"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="item-info">
                                            <div class="item-name">@item.Product?.ProductName</div>
                                            <div class="item-details">
                                                <span class="quantity">@item.Quantity عدد</span>
                                                <span class="price">@((item.Quantity * item.Product?.Price ?? 0).ToString("N0")) تومان</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- خلاصه مالی -->
                            <div class="financial-summary">
                                <div class="summary-row">
                                    <span class="label">جمع کل:</span>
                                    <span class="value">@cartTotal.ToString("N0") تومان</span>
                                </div>
                                <div class="summary-row">
                                    <span class="label">تخفیف:</span>
                                    <span class="value">۰ تومان</span>
                                </div>
                                <div class="summary-row">
                                    <span class="label">هزینه ارسال:</span>
                                    <span class="value">۰ تومان</span>
                                </div>
                                <div class="summary-row total">
                                    <span class="label">مبلغ قابل پرداخت:</span>
                                    <span class="value">@cartTotal.ToString("N0") تومان</span>
                                </div>
                            </div>

                            <!-- اطلاعات اضافی -->
                            <div class="additional-info">
                                <div class="info-item">
                                    <i class="bi bi-shield-check"></i>
                                    <span>خرید امن و مطمئن</span>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-clock"></i>
                                    <span>تحویل ۲۴ تا ۴۸ ساعته</span>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-arrow-left-right"></i>
                                    <span>۷ روز ضمانت بازگشت</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- اطلاعات تماس -->
                    <div class="contact-info-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-headset header-icon"></i>
                                <h3 class="card-title">پشتیبانی</h3>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="contact-info">
                                <div class="contact-item">
                                    <i class="bi bi-telephone"></i>
                                    <div class="contact-details">
                                        <div class="label">تلفن پشتیبانی</div>
                                        <div class="value">۰۲۱-۱۲۳۴۵۶۷۸</div>
                                    </div>
                                </div>
                                <div class="contact-item">
                                    <i class="bi bi-envelope"></i>
                                    <div class="contact-details">
                                        <div class="label">ایمیل</div>
                                        <div class="value">support@myshop.com</div>
                                    </div>
                                </div>
                                <div class="contact-item">
                                    <i class="bi bi-clock"></i>
                                    <div class="contact-details">
                                        <div class="label">ساعات کاری</div>
                                        <div class="value">۹ صبح تا ۶ عصر</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* استایل‌های ایجاد سفارش */
        .create-order-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        /* هدر صفحه */
        .create-order-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            font-size: 3rem;
            color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #2d3748;
        }

        .header-subtitle {
            color: #718096;
            margin: 5px 0 0 0;
            font-size: 1.1rem;
        }

        /* کارت‌ها */
        .shipping-form-card,
        .order-summary-card,
        .contact-info-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

            .shipping-form-card:hover,
            .order-summary-card:hover,
            .contact-info-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            }

        /* هدر کارت */
        .card-header-modern {
            padding: 25px 25px 0;
            border-bottom: none;
            background: transparent;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 1.5rem;
            color: #667eea;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
        }

        .header-badge .badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* بدنه کارت */
        .card-body-modern {
            padding: 25px;
        }

        /* فرم */
        .shipping-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group-modern {
            margin-bottom: 1.5rem;
        }

        .form-label-modern {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .input-icon {
            color: #667eea;
            font-size: 1rem;
        }

        .form-control-modern {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

            .form-control-modern:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                background: white;
            }

        .textarea-modern {
            resize: vertical;
            min-height: 100px;
        }

        /* خلاصه محصولات */
        .order-items-summary {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

            .item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .no-image {
            color: #a0aec0;
            font-size: 1.2rem;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .item-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .quantity {
            color: #718096;
        }

        .price {
            color: #38a169;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        /* خلاصه مالی */
        .financial-summary {
            border-top: 2px solid #e2e8f0;
            padding-top: 20px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

            .summary-row.total {
                border-bottom: none;
                border-top: 2px solid #667eea;
                padding-top: 12px;
                margin-top: 8px;
            }

                .summary-row.total .label {
                    font-weight: 700;
                    color: #2d3748;
                }

                .summary-row.total .value {
                    font-weight: 700;
                    color: #38a169;
                    font-size: 1.1rem;
                }

            .summary-row .label {
                color: #718096;
            }

            .summary-row .value {
                color: #4a5568;
                font-weight: 600;
            }

        /* اطلاعات اضافی */
        .additional-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #4a5568;
        }

            .info-item i {
                color: #667eea;
            }

        /* اطلاعات تماس */
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
        }

            .contact-item i {
                font-size: 1.2rem;
                color: #667eea;
                width: 24px;
                text-align: center;
            }

        .contact-details {
            flex: 1;
        }

            .contact-details .label {
                font-size: 0.8rem;
                color: #718096;
                margin-bottom: 2px;
            }

            .contact-details .value {
                font-size: 0.9rem;
                color: #2d3748;
                font-weight: 600;
            }

        /* دکمه‌ها */
        .btn-success-modern {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-success-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
                background: linear-gradient(135deg, #3d9e6d 0%, #2f855a 100%);
                color: white;
            }

        .btn-outline-secondary {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            color: #718096;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-outline-secondary:hover {
                border-color: #cbd5e0;
                background: #f7fafc;
                color: #4a5568;
            }

        /* اعتبارسنجی */
        .validation-summary {
            background: rgba(254, 215, 215, 0.1);
            border: 1px solid rgba(229, 62, 62, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            color: #e53e3e;
            font-size: 0.9rem;
        }

        .validation-message {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        /* آلرت مدرن */
        .alert-modern {
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        /* ریسپانسیو */
        @@media (max-width: 768px) {
            .create-order-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .header-title {
                font-size: 1.6rem;
            }

            .card-header-modern {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .form-actions .row {
                flex-direction: column;
            }
        }

        @@media (max-width: 576px) {
            .header-title {
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 1rem;
            }

            .summary-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: right;
            }

            .item-details {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // بسته شدن خودکار alert ها بعد از 5 ثانیه
            setTimeout(function () {
                $('.alert').alert('close');
            }, 5000);

            // اعتبارسنجی کد پستی
            $('input[name="ShippingPostalCode"]').on('blur', function () {
                var postalCode = $(this).val();
                if (postalCode && !/^\d{10}$/.test(postalCode)) {
                    showToast('خطا', 'کد پستی باید 10 رقم باشد', 'error');
                    $(this).focus();
                }
            });

            // اعتبارسنجی شماره تلفن
            $('input[name="ContactPhone"]').on('blur', function () {
                var phone = $(this).val();
                if (phone && !/^09\d{9}$/.test(phone)) {
                    showToast('خطا', 'شماره تلفن باید با 09 شروع شده و 11 رقم باشد', 'error');
                    $(this).focus();
                }
            });

            // افکت hover روی کارت‌ها
            $('.shipping-form-card, .order-summary-card, .contact-info-card').hover(
                function() {
                    $(this).css('transform', 'translateY(-2px)');
                },
                function() {
                    $(this).css('transform', 'translateY(0)');
                }
            );

            // تابع نمایش toast
            function showToast(title, message, type) {
                // ایجاد یک alert ساده در صورت عدم وجود toast library
                alert(title + ': ' + message);
            }
        });
    </script>
}-----------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Order\Details.cshtml

@model MyShopProject.Models.OrderViewModel

@{
    ViewData["Title"] = "جزئیات سفارش";
}

<div class="order-details-container">
    <div class="container-fluid">
        <!-- هدر صفحه -->
        <div class="order-details-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="bi bi-receipt"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">جزئیات سفارش</h1>
                    <p class="header-subtitle">شماره سفارش: @Model.OrderNumber</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-right btn-icon"></i>
                    بازگشت به سفارشات
                </a>
            </div>
        </div>

        <!-- نمایش پیام‌ها -->
        <div class="alerts-container">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-check-circle-fill alert-icon"></i>
                        <span>@TempData["SuccessMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                        <span>@TempData["ErrorMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>

        <div class="order-details-content">
            <div class="row g-4">
                <!-- اطلاعات اصلی سفارش -->
                <div class="col-lg-8">
                    <div class="order-info-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-info-circle header-icon"></i>
                                <h3 class="card-title">اطلاعات سفارش</h3>
                            </div>
                            <div class="header-badge">
                                <span class="status-badge status-@Model.StatusColor">
                                    <i class="@Model.StatusIcon"></i>
                                    @Model.Status
                                </span>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="order-info-grid">
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-hash info-icon"></i>
                                        شماره سفارش
                                    </div>
                                    <div class="info-value">@Model.OrderNumber</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-calendar info-icon"></i>
                                        تاریخ سفارش
                                    </div>
                                    <div class="info-value">
                                        <span class="persian-date">@Model.OrderDatePersian</span>
                                        <small class="miladi-date">(@Model.OrderDate.ToString("yyyy/MM/dd"))</small>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-cart-check info-icon"></i>
                                        تعداد آیتم‌ها
                                    </div>
                                    <div class="info-value">@Model.ItemCount عدد</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-currency-dollar info-icon"></i>
                                        مبلغ کل
                                    </div>
                                    <div class="info-value price">@Model.TotalAmount.ToString("N0") تومان</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- آیتم‌های سفارش -->
                    <div class="order-items-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-list-ul header-icon"></i>
                                <h3 class="card-title">محصولات سفارش</h3>
                            </div>
                            <div class="header-badge">
                                <span class="badge bg-primary">@Model.OrderItems.Count مورد</span>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="order-items-list">
                                @foreach (var item in Model.OrderItems)
                                {
                                    <div class="order-item">
                                        <div class="item-image">
                                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                                            {
                                                <img src="@item.ImageUrl" alt="@item.ProductName" class="img-fluid">
                                            }
                                            else
                                            {
                                                <div class="no-image">
                                                    <i class="bi bi-image"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="item-details">
                                            <div class="item-name">@item.ProductName</div>
                                            <div class="item-brand">برند: @item.Brand</div>
                                            <div class="item-price">
                                                <span class="unit-price">@item.UnitPrice.ToString("N0") تومان</span>
                                                <span class="quantity">× @item.Quantity</span>
                                            </div>
                                        </div>
                                        <div class="item-total">
                                            <div class="total-price">@item.TotalPrice.ToString("N0") تومان</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات ارسال و اقدامات -->
                <div class="col-lg-4">
                    <!-- اطلاعات ارسال -->
                    <div class="shipping-info-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-truck header-icon"></i>
                                <h3 class="card-title">اطلاعات ارسال</h3>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="shipping-info">
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-geo-alt"></i>
                                        آدرس ارسال
                                    </div>
                                    <div class="info-value">@Model.ShippingAddress</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-mailbox"></i>
                                        کد پستی
                                    </div>
                                    <div class="info-value">@Model.ShippingPostalCode</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-telephone"></i>
                                        شماره تماس
                                    </div>
                                    <div class="info-value">@Model.ContactPhone</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- اقدامات -->
                    <div class="actions-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-lightning header-icon"></i>
                                <h3 class="card-title">اقدامات</h3>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="actions-grid">
                                <a href="@Url.Action("Index", "Products")" class="btn btn-primary-modern w-100">
                                    <i class="bi bi-cart-plus btn-icon"></i>
                                    خرید مجدد
                                </a>

                                @if (Model.Status == "در انتظار پرداخت" || Model.Status == "پرداخت شده")
                                {
                                    <form asp-action="Cancel" asp-route-id="@Model.OrderID" method="post" class="w-100">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-danger-modern w-100"
                                                onclick="return confirm('آیا از لغو این سفارش مطمئن هستید؟')">
                                            <i class="bi bi-x-circle btn-icon"></i>
                                            لغو سفارش
                                        </button>
                                    </form>
                                }

                                <button class="btn btn-outline-secondary w-100" onclick="window.print()">
                                    <i class="bi bi-printer btn-icon"></i>
                                    چاپ فاکتور
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- خلاصه مالی -->
                    <div class="summary-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-receipt-cutoff header-icon"></i>
                                <h3 class="card-title">خلاصه مالی</h3>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="summary-grid">
                                <div class="summary-row">
                                    <span class="label">جمع کل:</span>
                                    <span class="value">@Model.TotalAmount.ToString("N0") تومان</span>
                                </div>
                                <div class="summary-row">
                                    <span class="label">تخفیف:</span>
                                    <span class="value">۰ تومان</span>
                                </div>
                                <div class="summary-row">
                                    <span class="label">هزینه ارسال:</span>
                                    <span class="value">۰ تومان</span>
                                </div>
                                <div class="summary-row total">
                                    <span class="label">مبلغ قابل پرداخت:</span>
                                    <span class="value">@Model.TotalAmount.ToString("N0") تومان</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* استایل‌های جزئیات سفارش */
        .order-details-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        /* هدر صفحه */
        .order-details-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            font-size: 3rem;
            color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #2d3748;
        }

        .header-subtitle {
            color: #718096;
            margin: 5px 0 0 0;
            font-size: 1.1rem;
        }

        /* کارت‌ها */
        .order-info-card,
        .order-items-card,
        .shipping-info-card,
        .actions-card,
        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

            .order-info-card:hover,
            .order-items-card:hover,
            .shipping-info-card:hover,
            .actions-card:hover,
            .summary-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            }

        /* هدر کارت */
        .card-header-modern {
            padding: 25px 25px 0;
            border-bottom: none;
            background: transparent;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 1.5rem;
            color: #667eea;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
        }

        .header-badge .badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* بدنه کارت */
        .card-body-modern {
            padding: 25px;
        }

        /* اطلاعات سفارش */
        .order-info-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .info-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .info-icon {
            color: #667eea;
        }

        .info-value {
            font-weight: 600;
            color: #2d3748;
        }

        .price {
            color: #38a169;
            font-family: 'Courier New', monospace;
        }

        .persian-date {
            font-weight: 700;
        }

        .miladi-date {
            color: #718096;
            font-size: 0.85rem;
        }

        /* آیتم‌های سفارش */
        .order-items-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

            .order-item:hover {
                background: rgba(102, 126, 234, 0.1);
                transform: translateX(5px);
            }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

            .item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .no-image {
            color: #a0aec0;
            font-size: 1.5rem;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .item-brand {
            color: #718096;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .item-price {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .unit-price {
            color: #4a5568;
        }

        .quantity {
            color: #667eea;
            font-weight: 600;
        }

        .item-total {
            text-align: left;
        }

        .total-price {
            font-weight: 700;
            color: #38a169;
            font-family: 'Courier New', monospace;
        }

        /* اطلاعات ارسال */
        .shipping-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

            .info-item .info-label {
                font-size: 0.9rem;
                color: #718096;
            }

            .info-item .info-value {
                font-size: 0.95rem;
                color: #2d3748;
                font-weight: 500;
            }

        /* اقدامات */
        .actions-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* خلاصه مالی */
        .summary-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

            .summary-row.total {
                border-bottom: none;
                border-top: 2px solid #667eea;
                padding-top: 12px;
                margin-top: 8px;
            }

                .summary-row.total .label {
                    font-weight: 700;
                    color: #2d3748;
                }

                .summary-row.total .value {
                    font-weight: 700;
                    color: #38a169;
                    font-size: 1.1rem;
                }

            .summary-row .label {
                color: #718096;
            }

            .summary-row .value {
                color: #4a5568;
                font-weight: 600;
            }

        /* دکمه‌ها */
        .btn-primary-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-primary-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
                color: white;
            }

        .btn-danger-modern {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-danger-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
                background: linear-gradient(135deg, #ee7af4 0%, #f34158 100%);
                color: white;
            }

        /* وضعیت‌ها */
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-warning {
            background: linear-gradient(135deg, #f6e05e, #d69e2e);
            color: #744210;
        }

        .status-info {
            background: linear-gradient(135deg, #63b3ed, #3182ce);
            color: white;
        }

        .status-primary {
            background: linear-gradient(135deg, #7f9cf5, #4c51bf);
            color: white;
        }

        .status-success {
            background: linear-gradient(135deg, #68d391, #38a169);
            color: white;
        }

        .status-dark {
            background: linear-gradient(135deg, #a0aec0, #718096);
            color: white;
        }

        .status-danger {
            background: linear-gradient(135deg, #fc8181, #e53e3e);
            color: white;
        }

        /* آلرت مدرن */
        .alert-modern {
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        /* ریسپانسیو */
        @@media (max-width: 768px) {
            .order-details-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .header-title {
                font-size: 1.6rem;
            }

            .card-header-modern {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .order-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: right;
            }

            .item-total {
                align-self: flex-end;
            }
        }

        @@media (max-width: 576px) {
            .header-title {
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 1rem;
            }

            .info-row {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        /* استایل‌های چاپ */
        @@media print {
            .order-details-container {
                background: white !important;
            }

            .order-details-header,
            .order-info-card,
            .order-items-card,
            .shipping-info-card,
            .summary-card {
                background: white !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            .btn, .actions-card {
                display: none !important;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // بسته شدن خودکار alert ها بعد از 5 ثانیه
            setTimeout(function () {
                $('.alert').alert('close');
            }, 5000);

            // افکت hover روی کارت‌ها
            $('.order-info-card, .order-items-card, .shipping-info-card, .actions-card, .summary-card').hover(
                function() {
                    $(this).css('transform', 'translateY(-2px)');
                },
                function() {
                    $(this).css('transform', 'translateY(0)');
                }
            );
        });
    </script>
}@model MyShopProject.Models.OrderViewModel

@{
    ViewData["Title"] = "جزئیات سفارش";
}

<div class="order-details-container">
    <div class="container-fluid">
        <!-- هدر صفحه -->
        <div class="order-details-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="bi bi-receipt"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">جزئیات سفارش</h1>
                    <p class="header-subtitle">شماره سفارش: @Model.OrderNumber</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-right btn-icon"></i>
                    بازگشت به سفارشات
                </a>
            </div>
        </div>

        <!-- نمایش پیام‌ها -->
        <div class="alerts-container">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-check-circle-fill alert-icon"></i>
                        <span>@TempData["SuccessMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                        <span>@TempData["ErrorMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>

        <div class="order-details-content">
            <div class="row g-4">
                <!-- اطلاعات اصلی سفارش -->
                <div class="col-lg-8">
                    <div class="order-info-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-info-circle header-icon"></i>
                                <h3 class="card-title">اطلاعات سفارش</h3>
                            </div>
                            <div class="header-badge">
                                <span class="status-badge status-@Model.StatusColor">
                                    <i class="@Model.StatusIcon"></i>
                                    @Model.Status
                                </span>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="order-info-grid">
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-hash info-icon"></i>
                                        شماره سفارش
                                    </div>
                                    <div class="info-value">@Model.OrderNumber</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-calendar info-icon"></i>
                                        تاریخ سفارش
                                    </div>
                                    <div class="info-value">
                                        <span class="persian-date">@Model.OrderDatePersian</span>
                                        <small class="miladi-date">(@Model.OrderDate.ToString("yyyy/MM/dd"))</small>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-cart-check info-icon"></i>
                                        تعداد آیتم‌ها
                                    </div>
                                    <div class="info-value">@Model.ItemCount عدد</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-currency-dollar info-icon"></i>
                                        مبلغ کل
                                    </div>
                                    <div class="info-value price">@Model.TotalAmount.ToString("N0") تومان</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- آیتم‌های سفارش -->
                    <div class="order-items-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-list-ul header-icon"></i>
                                <h3 class="card-title">محصولات سفارش</h3>
                            </div>
                            <div class="header-badge">
                                <span class="badge bg-primary">@Model.OrderItems.Count مورد</span>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="order-items-list">
                                @foreach (var item in Model.OrderItems)
                                {
                                    <div class="order-item">
                                        <div class="item-image">
                                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                                            {
                                                <img src="@item.ImageUrl" alt="@item.ProductName" class="img-fluid">
                                            }
                                            else
                                            {
                                                <div class="no-image">
                                                    <i class="bi bi-image"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="item-details">
                                            <div class="item-name">@item.ProductName</div>
                                            <div class="item-brand">برند: @item.Brand</div>
                                            <div class="item-price">
                                                <span class="unit-price">@item.UnitPrice.ToString("N0") تومان</span>
                                                <span class="quantity">× @item.Quantity</span>
                                            </div>
                                        </div>
                                        <div class="item-total">
                                            <div class="total-price">@item.TotalPrice.ToString("N0") تومان</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات ارسال و اقدامات -->
                <div class="col-lg-4">
                    <!-- اطلاعات ارسال -->
                    <div class="shipping-info-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-truck header-icon"></i>
                                <h3 class="card-title">اطلاعات ارسال</h3>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="shipping-info">
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-geo-alt"></i>
                                        آدرس ارسال
                                    </div>
                                    <div class="info-value">@Model.ShippingAddress</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-mailbox"></i>
                                        کد پستی
                                    </div>
                                    <div class="info-value">@Model.ShippingPostalCode</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-telephone"></i>
                                        شماره تماس
                                    </div>
                                    <div class="info-value">@Model.ContactPhone</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- اقدامات -->
                    <div class="actions-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-lightning header-icon"></i>
                                <h3 class="card-title">اقدامات</h3>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="actions-grid">
                                <a href="@Url.Action("Index", "Products")" class="btn btn-primary-modern w-100">
                                    <i class="bi bi-cart-plus btn-icon"></i>
                                    خرید مجدد
                                </a>

                                @if (Model.Status == "در انتظار پرداخت" || Model.Status == "پرداخت شده")
                                {
                                    <form asp-action="Cancel" asp-route-id="@Model.OrderID" method="post" class="w-100">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-danger-modern w-100"
                                                onclick="return confirm('آیا از لغو این سفارش مطمئن هستید؟')">
                                            <i class="bi bi-x-circle btn-icon"></i>
                                            لغو سفارش
                                        </button>
                                    </form>
                                }

                                <button class="btn btn-outline-secondary w-100" onclick="window.print()">
                                    <i class="bi bi-printer btn-icon"></i>
                                    چاپ فاکتور
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- خلاصه مالی -->
                    <div class="summary-card">
                        <div class="card-header-modern">
                            <div class="header-title-section">
                                <i class="bi bi-receipt-cutoff header-icon"></i>
                                <h3 class="card-title">خلاصه مالی</h3>
                            </div>
                        </div>

                        <div class="card-body-modern">
                            <div class="summary-grid">
                                <div class="summary-row">
                                    <span class="label">جمع کل:</span>
                                    <span class="value">@Model.TotalAmount.ToString("N0") تومان</span>
                                </div>
                                <div class="summary-row">
                                    <span class="label">تخفیف:</span>
                                    <span class="value">۰ تومان</span>
                                </div>
                                <div class="summary-row">
                                    <span class="label">هزینه ارسال:</span>
                                    <span class="value">۰ تومان</span>
                                </div>
                                <div class="summary-row total">
                                    <span class="label">مبلغ قابل پرداخت:</span>
                                    <span class="value">@Model.TotalAmount.ToString("N0") تومان</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* استایل‌های جزئیات سفارش */
        .order-details-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        /* هدر صفحه */
        .order-details-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            font-size: 3rem;
            color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #2d3748;
        }

        .header-subtitle {
            color: #718096;
            margin: 5px 0 0 0;
            font-size: 1.1rem;
        }

        /* کارت‌ها */
        .order-info-card,
        .order-items-card,
        .shipping-info-card,
        .actions-card,
        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

            .order-info-card:hover,
            .order-items-card:hover,
            .shipping-info-card:hover,
            .actions-card:hover,
            .summary-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            }

        /* هدر کارت */
        .card-header-modern {
            padding: 25px 25px 0;
            border-bottom: none;
            background: transparent;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 1.5rem;
            color: #667eea;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
        }

        .header-badge .badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* بدنه کارت */
        .card-body-modern {
            padding: 25px;
        }

        /* اطلاعات سفارش */
        .order-info-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .info-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .info-icon {
            color: #667eea;
        }

        .info-value {
            font-weight: 600;
            color: #2d3748;
        }

        .price {
            color: #38a169;
            font-family: 'Courier New', monospace;
        }

        .persian-date {
            font-weight: 700;
        }

        .miladi-date {
            color: #718096;
            font-size: 0.85rem;
        }

        /* آیتم‌های سفارش */
        .order-items-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

            .order-item:hover {
                background: rgba(102, 126, 234, 0.1);
                transform: translateX(5px);
            }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

            .item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .no-image {
            color: #a0aec0;
            font-size: 1.5rem;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .item-brand {
            color: #718096;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .item-price {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .unit-price {
            color: #4a5568;
        }

        .quantity {
            color: #667eea;
            font-weight: 600;
        }

        .item-total {
            text-align: left;
        }

        .total-price {
            font-weight: 700;
            color: #38a169;
            font-family: 'Courier New', monospace;
        }

        /* اطلاعات ارسال */
        .shipping-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

            .info-item .info-label {
                font-size: 0.9rem;
                color: #718096;
            }

            .info-item .info-value {
                font-size: 0.95rem;
                color: #2d3748;
                font-weight: 500;
            }

        /* اقدامات */
        .actions-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* خلاصه مالی */
        .summary-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

            .summary-row.total {
                border-bottom: none;
                border-top: 2px solid #667eea;
                padding-top: 12px;
                margin-top: 8px;
            }

                .summary-row.total .label {
                    font-weight: 700;
                    color: #2d3748;
                }

                .summary-row.total .value {
                    font-weight: 700;
                    color: #38a169;
                    font-size: 1.1rem;
                }

            .summary-row .label {
                color: #718096;
            }

            .summary-row .value {
                color: #4a5568;
                font-weight: 600;
            }

        /* دکمه‌ها */
        .btn-primary-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-primary-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
                color: white;
            }

        .btn-danger-modern {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-danger-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
                background: linear-gradient(135deg, #ee7af4 0%, #f34158 100%);
                color: white;
            }

        /* وضعیت‌ها */
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-warning {
            background: linear-gradient(135deg, #f6e05e, #d69e2e);
            color: #744210;
        }

        .status-info {
            background: linear-gradient(135deg, #63b3ed, #3182ce);
            color: white;
        }

        .status-primary {
            background: linear-gradient(135deg, #7f9cf5, #4c51bf);
            color: white;
        }

        .status-success {
            background: linear-gradient(135deg, #68d391, #38a169);
            color: white;
        }

        .status-dark {
            background: linear-gradient(135deg, #a0aec0, #718096);
            color: white;
        }

        .status-danger {
            background: linear-gradient(135deg, #fc8181, #e53e3e);
            color: white;
        }

        /* آلرت مدرن */
        .alert-modern {
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        /* ریسپانسیو */
        @@media (max-width: 768px) {
            .order-details-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .header-title {
                font-size: 1.6rem;
            }

            .card-header-modern {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .order-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: right;
            }

            .item-total {
                align-self: flex-end;
            }
        }

        @@media (max-width: 576px) {
            .header-title {
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 1rem;
            }

            .info-row {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        /* استایل‌های چاپ */
        @@media print {
            .order-details-container {
                background: white !important;
            }

            .order-details-header,
            .order-info-card,
            .order-items-card,
            .shipping-info-card,
            .summary-card {
                background: white !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            .btn, .actions-card {
                display: none !important;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // بسته شدن خودکار alert ها بعد از 5 ثانیه
            setTimeout(function () {
                $('.alert').alert('close');
            }, 5000);

            // افکت hover روی کارت‌ها
            $('.order-info-card, .order-items-card, .shipping-info-card, .actions-card, .summary-card').hover(
                function() {
                    $(this).css('transform', 'translateY(-2px)');
                },
                function() {
                    $(this).css('transform', 'translateY(0)');
                }
            );
        });
    </script>
}

--------------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Order\Index.cshtml

@model List<MyShopProject.Models.OrderViewModel>

@{
    ViewData["Title"] = "سفارشات من";
}

<div class="orders-container">
    <div class="container-fluid">
        <!-- هدر صفحه -->
        <div class="orders-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="bi bi-bag-check"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">سفارشات من</h1>
                    <p class="header-subtitle">مدیریت و پیگیری سفارشات شما</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="@Url.Action("Index", "Products")" class="btn btn-primary-modern">
                    <i class="bi bi-arrow-right btn-icon"></i>
                    ادامه خرید
                </a>
            </div>
        </div>

        <!-- نمایش پیام‌ها -->
        <div class="alerts-container">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-check-circle-fill alert-icon"></i>
                        <span>@TempData["SuccessMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-modern alert-dismissible fade show" role="alert">
                    <div class="alert-content">
                        <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                        <span>@TempData["ErrorMessage"]</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>

        <!-- محتوای اصلی -->
        <div class="orders-content">
            @if (!Model.Any())
            {
                <!-- حالت خالی -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-bag-x"></i>
                    </div>
                    <h3 class="empty-title">هنوز سفارشی ثبت نکرده‌اید</h3>
                    <p class="empty-subtitle">پس از ثبت اولین سفارش، اطلاعات آن در اینجا نمایش داده می‌شود</p>
                    <a href="@Url.Action("Index", "Products")" class="btn btn-primary-modern">
                        <i class="bi bi-cart-plus btn-icon"></i>
                        شروع خرید
                    </a>
                </div>
            }
            else
            {
                <!-- لیست سفارشات -->
                <div class="orders-list">
                    @foreach (var order in Model)
                    {
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-info">
                                    <div class="order-number">
                                        <i class="bi bi-hash"></i>
                                        <strong>شماره سفارش:</strong>
                                        <span class="number">@order.OrderNumber</span>
                                    </div>
                                    <div class="order-date">
                                        <i class="bi bi-calendar"></i>
                                        <span>@order.OrderDatePersian</span>
                                    </div>
                                </div>
                                <div class="order-status">
                                    <span class="status-badge status-@order.StatusColor">
                                        <i class="@order.StatusIcon"></i>
                                        @order.Status
                                    </span>
                                </div>
                            </div>

                            <div class="order-body">
                                <div class="order-details">
                                    <div class="detail-item">
                                        <i class="bi bi-cart-check"></i>
                                        <span class="label">تعداد آیتم‌ها:</span>
                                        <span class="value">@order.ItemCount عدد</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-currency-dollar"></i>
                                        <span class="label">مبلغ کل:</span>
                                        <span class="value price">@order.TotalAmount.ToString("N0") تومان</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-geo-alt"></i>
                                        <span class="label">آدرس:</span>
                                        <span class="value address">@order.ShippingAddress</span>
                                    </div>
                                </div>

                                <div class="order-actions">
                                    <a href="@Url.Action("Details", new { id = order.OrderID })" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye"></i>
                                        مشاهده جزئیات
                                    </a>

                                    @if (order.Status == "در انتظار پرداخت" || order.Status == "پرداخت شده")
                                    {
                                        <form asp-action="Cancel" asp-route-id="@order.OrderID" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                                    onclick="return confirm('آیا از لغو این سفارش مطمئن هستید؟')">
                                                <i class="bi bi-x-circle"></i>
                                                لغو سفارش
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>

                            <!-- آیتم‌های سفارش (پیش‌نمایش) -->
                            <div class="order-items-preview">
                                <div class="items-grid">
                                    @foreach (var item in order.OrderItems.Take(3))
                                    {
                                        <div class="order-item-preview">
                                            <div class="item-image">
                                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                                {
                                                    <img src="@item.ImageUrl" alt="@item.ProductName" class="img-fluid">
                                                }
                                                else
                                                {
                                                    <div class="no-image">
                                                        <i class="bi bi-image"></i>
                                                    </div>
                                                }
                                            </div>
                                            <div class="item-info">
                                                <div class="item-name">@item.ProductName</div>
                                                <div class="item-brand">@item.Brand</div>
                                                <div class="item-quantity">@item.Quantity عدد</div>
                                            </div>
                                        </div>
                                    }
                                    @if (order.OrderItems.Count > 3)
                                    {
                                        <div class="more-items">
                                            <span>+ @(order.OrderItems.Count - 3) مورد دیگر</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* استایل‌های سفارشات */
        .orders-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        /* هدر صفحه */
        .orders-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            font-size: 3rem;
            color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #2d3748;
        }

        .header-subtitle {
            color: #718096;
            margin: 5px 0 0 0;
            font-size: 1.1rem;
        }

        /* کارت سفارش */
        .order-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

            .order-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            }

        .order-header {
            padding: 25px 25px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
        }

        .order-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .order-number {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

            .order-number .number {
                font-family: 'Courier New', monospace;
                font-weight: 700;
                color: #2d3748;
            }

        .order-date {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #718096;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-warning {
            background: linear-gradient(135deg, #f6e05e, #d69e2e);
            color: #744210;
        }

        .status-info {
            background: linear-gradient(135deg, #63b3ed, #3182ce);
            color: white;
        }

        .status-primary {
            background: linear-gradient(135deg, #7f9cf5, #4c51bf);
            color: white;
        }

        .status-success {
            background: linear-gradient(135deg, #68d391, #38a169);
            color: white;
        }

        .status-dark {
            background: linear-gradient(135deg, #a0aec0, #718096);
            color: white;
        }

        .status-danger {
            background: linear-gradient(135deg, #fc8181, #e53e3e);
            color: white;
        }

        .order-body {
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

            .detail-item .label {
                color: #718096;
                font-weight: 500;
            }

            .detail-item .value {
                color: #2d3748;
                font-weight: 600;
            }

            .detail-item .price {
                color: #38a169;
                font-family: 'Courier New', monospace;
            }

            .detail-item .address {
                max-width: 300px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        /* پیش‌نمایش آیتم‌ها */
        .order-items-preview {
            background: rgba(102, 126, 234, 0.05);
            padding: 20px 25px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
        }

        .items-grid {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .order-item-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 200px;
        }

        .item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .no-image {
            color: #a0aec0;
            font-size: 1.2rem;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .item-brand {
            color: #718096;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .item-quantity {
            color: #667eea;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .more-items {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px 16px;
            border-radius: 12px;
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* حالت خالی */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .empty-icon {
            font-size: 4rem;
            color: #cbd5e0;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 1.5rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .empty-subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* دکمه‌های مدرن */
        .btn-primary-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

            .btn-primary-modern:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
                color: white;
            }

        /* آلرت مدرن */
        .alert-modern {
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        /* ریسپانسیو */
        @@media (max-width: 768px) {
            .orders-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .header-title {
                font-size: 1.6rem;
            }

            .order-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .order-body {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }

            .order-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .items-grid {
                flex-wrap: wrap;
                justify-content: flex-start;
            }

            .order-item-preview {
                min-width: calc(50% - 10px);
            }
        }

        @@media (max-width: 576px) {
            .order-item-preview {
                min-width: 100%;
            }

            .header-title {
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 1rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // بسته شدن خودکار alert ها بعد از 5 ثانیه
            setTimeout(function () {
                $('.alert').alert('close');
            }, 5000);

            // افکت hover روی کارت‌ها
            $('.order-card').hover(
                function() {
                    $(this).css('transform', 'translateY(-5px)');
                },
                function() {
                    $(this).css('transform', 'translateY(0)');
                }
            );
        });
    </script>
}
---------------------------------------------------------------------------------------------
D:\MyShopProject\Views\Order\Success.cshtml

@{
    ViewData["Title"] = "پرداخت موفق";
}

<div class="container mt-5">
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="mb-4">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            </div>
            <h2 class="text-success mb-3">پرداخت با موفقیت انجام شد!</h2>
            <div class="alert alert-light border">
                <p class="mb-2"><strong>شماره پیگیری:</strong> <span class="text-primary fs-5">@ViewBag.TrackingId</span></p>
                <p class="mb-2"><strong>مبلغ پرداختی:</strong> @ViewBag.TotalAmount تومان</p>
                <p class="mb-0"><strong>تاریخ:</strong> @ViewBag.OrderDatePersian</p>
            </div>
            <p class="text-muted">
                سفارش شما در حال پردازش است. ایمیل تأیید به زودی ارسال می‌شود.
            </p>
            <div class="mt-4">
                <a href="@Url.Action("Index", "Home")" class="btn btn-primary px-4">
                    بازگشت به فروشگاه
                </a>
                <a href="@Url.Action("Index", "Order")" class="btn btn-outline-secondary px-4">
                    مشاهده سفارشات
                </a>
            </div>
        </div>
    </div>
</div>

----------------------------------------------------------------------------------------------
D:\MyShopProject\Views\Products\Details.cshtml

@model MyShopProject.Models.Product
@{
    ViewData["Title"] = Model.ProductName;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- کارت اصلی محصول (مشابه صفحه اصلی) -->
            <div class="card h-100 product-card shadow-lg" data-product-id="@Model.ProductID">
                <div class="row g-0">
                    <!-- تصویر محصول -->
                    <div class="col-md-5">
                        <div class="text-center p-4">
                            @if (!string.IsNullOrEmpty(Model.ImageUrl))
                            {
                                <img src="@Model.ImageUrl" alt="@Model.ProductName"
                                     class="img-fluid rounded" style="max-height: 350px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="bg-light d-flex align-items-center justify-content-center rounded"
                                     style="height: 300px;">
                                    <i class="bi bi-image text-muted" style="font-size: 80px;"></i>
                                    <p class="text-muted mt-2">بدون تصویر</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- اطلاعات محصول -->
                    <div class="col-md-7">
                        <div class="card-body d-flex flex-column h-100">
                            <h3 class="card-title mb-2">@Model.ProductName</h3>
                            <h6 class="card-subtitle mb-3 text-muted">@Model.Brand</h6>

                            @if (!string.IsNullOrEmpty(Model.Description))
                            {
                                <div class="mb-3">
                                    <strong>توضیحات:</strong>
                                    <p class="text-muted small">@Model.Description</p>
                                </div>
                            }

                            <div class="mt-auto">
                                <p class="card-text mb-2">
                                    <strong>قیمت:</strong>
                                    <span class="text-success h5">@Model.Price.ToString("N0")</span> تومان
                                </p>
                                <p class="card-text mb-2">
                                    <strong>رنگ:</strong> @(string.IsNullOrEmpty(Model.Color) ? "نامشخص" : Model.Color)
                                </p>
                                <p class="card-text mb-3">
                                    <strong>موجودی:</strong>
                                    <span class="stock-quantity @(Model.StockQuantity > 0 ? "text-success" : "text-danger")">
                                        @Model.StockQuantity عدد
                                    </span>
                                </p>
                                <p class="card-text mb-3">
                                    <strong>دسته‌بندی:</strong> @Model.Category?.CategoryName
                                </p>

                                <!-- کنترل تعداد و افزودن به سبد -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="input-group" style="width: 140px;">
                                        <button class="btn btn-outline-secondary btn-sm decrease-qty" type="button">-</button>
                                        <input type="number" class="form-control form-control-sm text-center product-quantity"
                                               value="1" min="1" max="@Model.StockQuantity" @(Model.StockQuantity == 0 ? "disabled" : "")>
                                        <button class="btn btn-outline-secondary btn-sm increase-qty" type="button">+</button>
                                    </div>
                                    <button class="btn btn-success btn-sm add-to-cart-btn"
                                    @(Model.StockQuantity == 0 ? "disabled" : "")>
                                        افزودن به سبد
                                    </button>
                                </div>

                                <!-- اطلاعات سبد خرید -->
                                <div class="cart-info mt-2" style="display: none;">
                                    <small class="text-success">
                                        <span class="cart-quantity">0</span> عدد در سبد خرید شما
                                    </small>
                                </div>

                                <!-- دکمه بازگشت به فروشگاه -->
                                <div class="mt-4">
                                    <a href="@Url.Action("Index", "Products")"
                                       class="btn btn-outline-primary w-100">
                                        بازگشت به فروشگاه
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .product-card {
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

            .product-card:hover {
                transform: translateY(-5px);
            }

        .card-body {
            padding: 1.5rem;
        }

        .img-fluid {
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .decrease-qty, .increase-qty {
            width: 38px;
        }

        .product-quantity {
            width: 50px;
        }

        .add-to-cart-btn {
            min-width: 140px;
        }

        /* دکمه بازگشت - اندازه مناسب و جای درست */
        .btn-outline-primary {
            font-weight: 600;
            padding: 0.65rem 1rem;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

            .btn-outline-primary:hover {
                background-color: #0d6efd;
                color: white;
                transform: translateY(-1px);
            }
    </style>
}

@section Scripts {
    <script>
        // افزایش تعداد
        $(document).on('click', '.increase-qty', function () {
            var input = $(this).siblings('.product-quantity');
            var currentVal = parseInt(input.val());
            var maxVal = parseInt(input.attr('max'));
            if (currentVal < maxVal) {
                input.val(currentVal + 1);
            }
        });

        // کاهش تعداد
        $(document).on('click', '.decrease-qty', function () {
            var input = $(this).siblings('.product-quantity');
            var currentVal = parseInt(input.val());
            if (currentVal > 1) {
                input.val(currentVal - 1);
            }
        });

        // افزودن به سبد خرید
        $(document).on('click', '.add-to-cart-btn', function () {
            var productCard = $(this).closest('.product-card');
            var productId = productCard.data('product-id');
            var newQuantity = parseInt(productCard.find('.product-quantity').val());

            var btn = $(this);
            var originalText = btn.text();
            btn.prop('disabled', true).text('در حال پردازش...');

            $.ajax({
                url: '/Cart/UpdateProductQuantity',
                type: 'POST',
                data: { productId: productId, newQuantity: newQuantity },
                success: function (response) {
                    if (response.success) {
                        $('#cartCount').text(response.totalItems);
                        $('#floatingCartCount').text(response.totalItems);

                        showSuccessMessage(response.message);

                        var stockElement = productCard.find('.stock-quantity');
                        stockElement.text(response.newStock + ' عدد');

                        var quantityInput = productCard.find('.product-quantity');
                        quantityInput.attr('max', response.newStock);

                        var cartInfo = productCard.find('.cart-info');
                        var cartQuantitySpan = productCard.find('.cart-quantity');
                        cartQuantitySpan.text(newQuantity);
                        cartInfo.show();
                        btn.text('به‌روزرسانی سبد');

                        if (response.newStock === 0) {
                            stockElement.removeClass('text-success').addClass('text-danger');
                            btn.prop('disabled', true);
                            quantityInput.val(0);
                        }
                    } else {
                        showErrorMessage(response.message);
                    }
                },
                error: function () {
                    showErrorMessage('خطا در بروزرسانی سبد خرید');
                },
                complete: function () {
                    setTimeout(() => btn.prop('disabled', false).text(originalText), 800);
                }
            });
        });

        // بارگذاری تعداد از سبد خرید
        $(document).ready(function () {
            setTimeout(() => {
                $.ajax({
                    url: '/Cart/GetCartQuantities',
                    type: 'GET',
                    success: function (cartQuantities) {
                        var productId = $('.product-card').data('product-id');
                        if (cartQuantities[productId]) {
                            var qty = parseInt(cartQuantities[productId]);
                            $('.product-quantity').val(qty);
                            $('.cart-quantity').text(qty);
                            $('.cart-info').show();
                            $('.add-to-cart-btn').text('به‌روزرسانی سبد');
                        }
                    }
                });
            }, 100);
        });
    </script>
}

---------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Products\Home.cshtml

@{
    ViewData["Title"] = "صفحه اصلی";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-body text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-shop display-1 text-primary"></i>
                    </div>

                    <h1 class="display-4 mb-3">خوش آمدید به فروشگاه ما!</h1>

                    @if (!string.IsNullOrEmpty(ViewBag.UserName))
                    {
                        <h2 class="text-success mb-4">@ViewBag.UserName عزیز</h2>
                    }

                    <p class="lead mb-4">
                        به سیستم فروشگاه آنلاین خوش آمدید. از طریق منوی بالا می‌توانید به بخش‌های مختلف دسترسی داشته باشید.
                    </p>

                    <div class="row mt-5">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-grid-3x3-gap text-primary display-6 mb-3"></i>
                                    <h5>محصولات</h5>
                                    <p class="text-muted">مشاهده و خرید از محصولات متنوع</p>
                                    <a href="@Url.Action("Index", "Products")" class="btn btn-primary">مشاهده محصولات</a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-cart3 text-success display-6 mb-3"></i>
                                    <h5>سبد خرید</h5>
                                    <p class="text-muted">مدیریت سبد خرید و سفارشات</p>
                                    <a href="@Url.Action("Index", "Cart")" class="btn btn-success">مشاهده سبد خرید</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (ViewBag.UserRole == "Admin")
                    {
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                شما با دسترسی مدیر وارد شده‌اید. می‌توانید از پنل مدیریت استفاده کنید.
                            </div>
                            <a href="@Url.Action("Index", "Admin")" class="btn btn-outline-info">
                                <i class="bi bi-speedometer2"></i> پنل مدیریت
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .card {
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

            .card:hover {
                transform: translateY(-5px);
            }

        .display-1 {
            font-size: 5rem;
        }
    </style>
}

-----------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Products\Index.cshtml

@model IEnumerable<MyShopProject.Models.Product>

@{
    ViewData["Title"] = "محصولات فروشگاه";
    var isLoggedIn = ViewBag.IsLoggedIn as bool? ?? false;
}

<div class="container mt-4">
    <h1 class="text-center mb-4">@ViewData["Title"]</h1>

    <!-- پیام خوشامدگویی ساده برای همه کاربران -->
    <div class="alert alert-info text-center">
        <h5>سلام @(isLoggedIn ? ViewBag.UserName : "مهمان") عزیز!</h5>
        <p class="mb-2">می‌توانید محصولات را مشاهده کنید و برای خرید به سبد خرید اضافه کنید</p>
    </div>

    <div class="row">
        @foreach (var product in Model)
        {
            <div class="col-md-4 mb-4">
                <div class="card h-100 product-card" data-product-id="@product.ProductID">
                    <!-- نمایش تصویر محصول -->
                    @if (!string.IsNullOrEmpty(product.ImageUrl))
                    {
                        <div class="text-center p-3">
                            <img src="@Url.Content(product.ImageUrl)" alt="@product.ProductName"
                                 class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                        </div>
                    }
                    else
                    {
                        <div class="text-center p-3 bg-light">
                            <i class="bi bi-image text-muted" style="font-size: 100px;"></i>
                            <p class="text-muted mt-2">بدون تصویر</p>
                        </div>
                    }

                    <div class="card-body">
                        <h5 class="card-title">@product.ProductName</h5>
                        <h6 class="card-subtitle mb-2 text-muted">@product.Brand</h6>

                        <!-- نمایش توضیحات محصول -->
                        @if (!string.IsNullOrEmpty(product.Description))
                        {
                            <div class="card-text mb-3">
                                <strong>توضیحات:</strong>
                                <p class="text-muted mt-1">@product.Description</p>
                            </div>
                        }

                        <p class="card-text">
                            <strong>قیمت:</strong> <span class="text-success">@product.Price.ToString("N0")</span> تومان<br>
                            <strong>رنگ:</strong> @product.Color<br>
                            <strong>موجودی:</strong>
                            <span class="stock-quantity @(product.StockQuantity > 0 ? "text-success" : "text-danger")">
                                @product.StockQuantity عدد
                            </span><br>
                            <strong>دسته‌بندی:</strong> @product.Category?.CategoryName
                        </p>
                    </div>
                    <div class="card-footer">
                        <!-- این بخش برای همه کاربران (لاگین شده و مهمان) فعال است -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="input-group" style="width: 120px;">
                                <button class="btn btn-outline-secondary btn-sm decrease-qty" type="button">-</button>
                                <input type="number" class="form-control form-control-sm text-center product-quantity"
                                       value="1" min="1" max="@product.StockQuantity">
                                <button class="btn btn-outline-secondary btn-sm increase-qty" type="button">+</button>
                            </div>
                            <button class="btn btn-success btn-sm add-to-cart-btn"
                            @(product.StockQuantity == 0 ? "disabled" : "")>
                                افزودن به سبد
                            </button>
                        </div>
                        <div class="cart-info mt-1" style="display: none;">
                            <small class="text-success">
                                <span class="cart-quantity">0</span> عدد در سبد خرید شما
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // تابع بارگذاری تعدادهای سبد خرید - بهبود یافته
        function loadCartQuantities() {
            $.ajax({
                url: '/Cart/GetCartQuantities',
                type: 'GET',
                success: function (cartQuantities) {
                    console.log('تعدادهای سبد خرید از سرور:', cartQuantities);

                    $('.product-card').each(function() {
                        var productId = $(this).data('product-id');
                        var input = $(this).find('.product-quantity');
                        var cartInfo = $(this).find('.cart-info');
                        var cartQuantitySpan = $(this).find('.cart-quantity');
                        var btn = $(this).find('.add-to-cart-btn');

                        // تنظیم مقدار input بر اساس سبد خرید
                        if (cartQuantities[productId]) {
                            var cartQuantity = parseInt(cartQuantities[productId]);

                            // مقدار input را برابر با تعداد در سبد خرید قرار بده
                            input.val(cartQuantity);

                            if (cartQuantity > 0) {
                                cartQuantitySpan.text(cartQuantity);
                                cartInfo.show();
                                btn.text('به‌روزرسانی سبد');
                                console.log('محصول ' + productId + ' - مقدار: ' + cartQuantity + ' (از سبد خرید)');
                            } else {
                                // اگر مقدار 0 است، اطلاعات سبد خرید را پنهان کن
                                cartInfo.hide();
                                btn.text('افزودن به سبد');
                                console.log('محصول ' + productId + ' - مقدار: 1 (مقدار پیش‌فرض)');
                            }
                        } else {
                            // اگر محصول در سبد خرید نیست، روی 1 تنظیم کن
                            input.val(1);
                            cartInfo.hide();
                            btn.text('افزودن به سبد');
                            console.log('محصول ' + productId + ' روی مقدار 1 تنظیم شد (مقدار پیش‌فرض)');
                        }
                    });
                },
                error: function () {
                    console.log('خطا در دریافت تعدادهای سبد خرید');
                    // در صورت خطا همه counterها را روی 1 تنظیم کن
                    $('.product-quantity').each(function() {
                        $(this).val(1);
                    });
                    $('.cart-info').hide();
                    $('.add-to-cart-btn').text('افزودن به سبد');
                }
            });
        }

        // افزایش تعداد
        $(document).on('click', '.increase-qty', function () {
            var input = $(this).siblings('.product-quantity');
            var currentVal = parseInt(input.val());
            var maxVal = parseInt(input.attr('max'));
            if (currentVal < maxVal) {
                input.val(currentVal + 1);
            }
        });

        // کاهش تعداد
        $(document).on('click', '.decrease-qty', function () {
            var input = $(this).siblings('.product-quantity');
            var currentVal = parseInt(input.val());
            if (currentVal > 1) {
                input.val(currentVal - 1);
            }
        });

        // کلیک روی دکمه افزودن به سبد خرید - برای همه کاربران فعال
        $(document).on('click', '.add-to-cart-btn', function () {
            var productCard = $(this).closest('.product-card');
            var productId = productCard.data('product-id');
            var newQuantity = parseInt(productCard.find('.product-quantity').val());

            // غیرفعال کردن دکمه هنگام ارسال
            var btn = $(this);
            var originalText = btn.text();
            btn.prop('disabled', true).text('در حال پردازش...');

            $.ajax({
                url: '/Cart/UpdateProductQuantity',
                type: 'POST',
                data: {
                    productId: productId,
                    newQuantity: newQuantity
                },
                success: function (response) {
                    if (response.success) {
                        // به روزرسانی تعداد در منو
                        $('#cartCount').text(response.totalItems);
                        $('#floatingCartCount').text(response.totalItems);

                        // نمایش پیام موفقیت
                        showSuccessMessage(response.message);

                        // به روزرسانی موجودی در صفحه
                        var stockElement = productCard.find('.stock-quantity');
                        stockElement.text(response.newStock + ' عدد');

                        // به روزرسانی max مقدار input
                        var quantityInput = productCard.find('.product-quantity');
                        quantityInput.attr('max', response.newStock);

                        // به‌روزرسانی اطلاعات سبد خرید
                        var cartInfo = productCard.find('.cart-info');
                        var cartQuantitySpan = productCard.find('.cart-quantity');

                        cartQuantitySpan.text(newQuantity);
                        cartInfo.show();
                        btn.text('به‌روزرسانی سبد');

                        // اگر موجودی صفر شد
                        if (response.newStock === 0) {
                            stockElement.removeClass('text-success').addClass('text-danger');
                            btn.prop('disabled', true);
                            quantityInput.val(0);
                        }

                    } else {
                        showErrorMessage(response.message);
                    }
                },
                error: function () {
                    showErrorMessage('خطا در بروزرسانی سبد خرید');
                },
                complete: function () {
                    // فعال کردن دکمه
                    setTimeout(function() {
                        btn.prop('disabled', false);
                    }, 1000);
                }
            });
        });

        // نمایش پیام موفقیت
        function showSuccessMessage(message) {
            showToast('success', message);
        }

        // نمایش پیام خطا
        function showErrorMessage(message) {
            showToast('error', message);
        }

        // تابع عمومی نمایش toast
        function showToast(type, message) {
            var toastClass = '';
            var icon = '';

            switch(type) {
                case 'success':
                    toastClass = 'alert-success';
                    icon = '✅';
                    break;
                case 'error':
                    toastClass = 'alert-danger';
                    icon = '❌';
                    break;
                case 'warning':
                    toastClass = 'alert-warning';
                    icon = '⚠️';
                    break;
                case 'info':
                    toastClass = 'alert-info';
                    icon = 'ℹ️';
                    break;
                default:
                    toastClass = 'alert-info';
                    icon = '💡';
            }

            var toastId = 'toast-' + Date.now();
            var toastHtml = `
                <div id="${toastId}" class="alert ${toastClass} alert-dismissible fade show position-fixed"
                     style="top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;">
                    <strong>${icon}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            $('body').append(toastHtml);

            setTimeout(function() {
                $('#' + toastId).alert('close');
            }, 4000);
        }

        // بارگذاری تعداد سبد خرید هنگام لود صفحه
        $(document).ready(function () {
            updateCartCount();

            // بارگذاری تعدادهای سبد خرید از سرور (برای همه کاربران)
            setTimeout(function() {
                loadCartQuantities();
            }, 100);
        });

        // به روزرسانی تعداد سبد خرید در منو
        function updateCartCount() {
            $.ajax({
                url: '/Cart/GetCartItemCount',
                type: 'GET',
                success: function (response) {
                    $('#cartCount').text(response.count);
                    $('#floatingCartCount').text(response.count);
                },
                error: function () {
                    console.log('خطا در به روزرسانی تعداد سبد خرید');
                    $('#cartCount').text('0');
                    $('#floatingCartCount').text('0');
                }
            });
        }
    </script>
}

-----------------------------------------------------------------------------------------------

D:\MyShopProject\Areas\Admin\Views\Shared\_AdminLayout.cshtml

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MyShopProject</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

            .sidebar .nav-link {
                color: rgba(255,255,255,.8);
                padding: 12px 20px;
                margin: 4px 0;
                border-radius: 8px;
                transition: all 0.3s;
            }

                .sidebar .nav-link:hover {
                    color: white;
                    background: rgba(255,255,255,.1);
                }

                .sidebar .nav-link.active {
                    color: white;
                    background: rgba(255,255,255,.2);
                }

                .sidebar .nav-link i {
                    margin-left: 10px;
                }

        .main-content {
            padding: 20px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e3e6f0;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
        }

        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #4e73df;
        }
    </style>

    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- نوار کناری -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            پنل مدیریت
                        </h4>
                        <small class="text-white-50">MyShop Project</small>
                    </div>
                    <ul class="nav flex-column">
                        <!-- پیشخوان -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Home", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "home" ? "active" : "")">
                                پیشخوان
                            </a>
                        </li>

                        <!-- مدیریت محصولات -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Products", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "products" ? "active" : "")">
                                مدیریت محصولات
                            </a>
                        </li>

                        <!-- مدیریت دسته‌بندی‌ها -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Categories", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "categories" ? "active" : "")">
                                مدیریت دسته‌بندی‌ها
                            </a>
                        </li>

                        <!-- مدیریت کاربران -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Users", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "users" ? "active" : "")">
                                مدیریت کاربران
                            </a>
                        </li>

                        <!-- محصولات کم موجود -->
                        <li class="nav-item">
                            <a href="@Url.Action("LowStock", "Products", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "lowstock" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "products" ? "active" : "")">
                                محصولات کم موجود
                            </a>
                        </li>

                        <!-- بازگشت به فروشگاه -->
                        <li class="nav-item mt-4">
                            <a href="@Url.Action("Index", "Products", new { area = "" })"
                               class="nav-link text-warning">
                                بازگشت به فروشگاه
                            </a>
                        </li>

                        <!-- خروج -->
                        <li class="nav-item">
                            <a href="@Url.Action("Logout", "Account", new { area = "" })"
                               class="nav-link text-danger">
                                خروج از سیستم
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- محتوای اصلی -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                @RenderBody()
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
-----------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Shared\_Layout.cshtml

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - فروشگاه من</title>

    <!-- اضافه کردن این meta tag برای پشتیبانی از فارسی -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.rtl.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/MyShopProject.styles.css" asp-append-version="true" />
    <!-- آیکن‌های Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* استایل‌های جدید برای فوتر در انتهای صفحه - نسخه نهایی */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .container {
            flex: 1;
        }

        /* فوتر معمولی - در انتهای محتوا */
        .footer {
            position: relative;
            bottom: auto;
            width: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-top: 3px solid #3498db;
            margin-top: auto;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

            /* متن فوتر برای خوانایی بهتر */
            .footer.text-muted {
                color: #ecf0f1 !important;
            }

            .footer a.text-muted {
                color: #bdc3c7 !important;
                transition: color 0.3s ease;
            }

                .footer a.text-muted:hover {
                    color: #3498db !important;
                }

        /* محتوای اصلی */
        .main-content {
            flex: 1;
        }

        main {
            min-height: 60vh;
        }

        /* استایل برای صفحات با محتوای کم */
        .content-wrapper {
            min-height: 70vh;
            position: relative;
        }

        /* تضمین فاصله ایمن از فوتر */
        .page-end-space {
            height: 100px; /* فضای خالی در انتهای صفحه */
            background: transparent;
        }

        /* اصلاح badge برای اعداد دو رقمی */
        #cartCount {
            min-width: 25px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            padding: 0 6px;
        }

        /* استایل برای کارت‌های محصول */
        .product-card {
            margin-bottom: 2rem;
        }

        /* استایل برای سبد خرید */
        .cart-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        /* استایل برای فوتر */
        .footer-content {
            padding: 1.5rem 0;
        }

        /* سبد خرید شناور - موقعیت بهبود یافته */
        .floating-cart {
            position: fixed;
            top: 280px; /* افزایش فاصله از بالا */
            left: 30px;
            z-index: 999; /* کمتر از منو */
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            border: 2px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
        }

            .floating-cart:hover {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(0,0,0,0.3);
                background: #f8f9fa;
            }

        .floating-cart-link {
            display: block;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        .floating-cart-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .floating-cart-icon {
            font-size: 1.5rem;
            color: #28a745;
        }

        .floating-cart-count {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .floating-cart-text {
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c3e50;
        }

        /* سبد خرید غیرفعال در صفحه سبد خرید */
        .floating-cart.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #6c757d;
        }

            .floating-cart.disabled:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                background: #fff;
            }

            .floating-cart.disabled .floating-cart-icon {
                color: #6c757d;
            }

            .floating-cart.disabled .floating-cart-link {
                cursor: not-allowed;
            }

        /* راه حل قطعی: تنظیم موقعیت dropdown منوی کاربر */
        .user-dropdown-menu {
            left: auto !important;
            right: 0 !important;
            transform: translateX(80px) !important; /* 8 سانت به راست */
        }

        /* موقعیت منوی کاربر و سبد خرید */
        .user-menu-item {
            margin-left: 5rem !important; /* 5 سانت به راست */
        }

        .cart-menu-item {
            margin-left: 3rem !important; /* 3 سانت به راست */
        }

        /* رفع مشکل نمایش در موبایل */
        @@media (max-width: 768px) {
            .page-end-space {
                height: 80px;
            }

            .footer-content {
                padding: 1rem 0;
            }

            .floating-cart {
                top: 100px; /* برای موبایل کمتر */
                left: 15px;
                padding: 10px;
            }

            .floating-cart-icon {
                font-size: 1.2rem;
            }

            .floating-cart-text {
                font-size: 0.8rem;
            }
            /* تنظیمات موبایل برای منوی کاربر */
            .user-dropdown-menu {
                transform: translateX(40px) !important; /* کمتر برای موبایل */
            }

            .user-menu-item {
                margin-left: 2.5rem !important;
            }

            .cart-menu-item {
                margin-left: 1.5rem !important;
            }
        }

        /* برای صفحات بسیار کوچک */
        @@media (max-width: 576px) {
            .floating-cart {
                top: 90px;
                left: 10px;
                padding: 8px;
            }
            /* تنظیمات صفحات کوچک برای منوی کاربر */
            .user-dropdown-menu {
                transform: translateX(20px) !important; /* کمتر برای صفحات کوچک */
            }

            .user-menu-item {
                margin-left: 1.5rem !important;
            }

            .cart-menu-item {
                margin-left: 1rem !important;
            }
        }

        /* دیباگ برای نمایش اطلاعات session */
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #6c757d;
        }

        /* استایل جدید: کادر جستجو */
        .search-container {
            position: relative;
            display: inline-block;
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1050;
            display: none;
            padding: 10px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .search-results {
            margin-top: 8px;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-decoration: none;
            color: #2c3e50;
            transition: background 0.2s;
        }

            .search-result-item:hover {
                background: #f8f9fa;
                border-radius: 6px;
            }

        .search-result-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            margin-left: 10px;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .search-result-price {
            font-size: 0.85rem;
            color: #28a745;
            font-weight: bold;
        }

        .search-no-results {
            text-align: center;
            padding: 15px;
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* جدید: نمایش محل مچ */
        .search-result-match {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 2px;
        }

            .search-result-match strong {
                color: #dc3545;
            }
    </style>

    <!-- رندر Section Styles اگر وجود داشته باشد -->
    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid">
                <a class="navbar-brand" asp-area="" asp-controller="Products" asp-action="Index">
                    فروشگاه من
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-controller="Products" asp-action="Index">
                                محصولات
                            </a>
                        </li>
                        <li class="nav-item search-container">
                            <a class="nav-link text-dark" href="javascript:void(0);" id="searchToggle">
                                جستجو
                            </a>
                            <div class="search-dropdown" id="searchDropdown">
                                <input type="text" class="search-input" id="searchInput" placeholder="جستجوی محصول..." autocomplete="off">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                        </li>
                    </ul>

                    <!-- دیباگ اطلاعات session (فقط در حالت توسعه) -->
                    @if (Context.Session.GetString("UserID") != null)
                    {
                        <div class="debug-info d-none">
                            <!-- d-none برای مخفی کردن در حالت عادی -->
                            <strong>Session Debug:</strong><br>
                            UserID: @Context.Session.GetString("UserID")<br>
                            Name: @Context.Session.GetString("Name")<br>
                            Email: @Context.Session.GetString("Email")<br>
                            Role: @Context.Session.GetString("Role")
                        </div>
                    }

                    <!-- منوی کاربر -->
                    <ul class="navbar-nav">
                        @{
                            var userId = Context.Session.GetString("UserID");
                            var userName = Context.Session.GetString("Name");
                            var userEmail = Context.Session.GetString("Email");
                            var userRole = Context.Session.GetString("Role");
                            <!-- اصلاح شد: GetString -->
                        }

                        <!-- سبد خرید - نمایش برای همه کاربران (لاگین شده و مهمان) -->
                        <li class="nav-item cart-menu-item">
                            <a class="nav-link text-dark position-relative" asp-controller="Cart" asp-action="Index">
                                سبد خرید
                                <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    0
                                </span>
                            </a>
                        </li>

                        @if (!string.IsNullOrEmpty(userId))
                        {
                            <!-- منوی کاربر لاگین شده -->
                            <li class="nav-item dropdown user-menu-item">
                                <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    @(string.IsNullOrEmpty(userName) ? (string.IsNullOrEmpty(userEmail) ? "کاربر" : userEmail) : userName)
                                </a>
                                <ul class="dropdown-menu user-dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" asp-controller="Account" asp-action="Profile">
                                            پروفایل من
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Cart" asp-action="Index">
                                            سبد خرید
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Order" asp-action="Index">
                                            سفارشات من
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    @if (userRole == "Admin")
                                    {
                                        <li>
                                            <a class="dropdown-item text-success" asp-controller="Admin" asp-action="Index">
                                                پنل مدیریت
                                            </a>
                                        </li>
                                    }
                                    <li>
                                        <!-- تغییر مهم: اضافه کردن confirm برای خروج -->
                                        <a class="dropdown-item text-danger logout-link" href="javascript:void(0);"
                                           data-bs-toggle="modal" data-bs-target="#logoutModal">
                                            خروج
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <!-- منوی ورود -->
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Account" asp-action="Login">
                                    ورود
                                </a>
                            </li>
                            <!-- منوی ثبت نام -->
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Account" asp-action="Register">
                                    ثبت نام
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- سبد خرید شناور - نمایش برای همه کاربران (لاگین شده و مهمان) -->
    <div class="floating-cart" id="floatingCart">
        <a class="floating-cart-link" id="floatingCartLink" href="@Url.Action("Index", "Cart")">
            <div class="floating-cart-content">
                <i class="bi bi-cart3 floating-cart-icon"></i>
                <span id="floatingCartCount" class="floating-cart-count">0</span>
                <div class="floating-cart-text">سبد خرید</div>
            </div>
        </a>
    </div>

    <!-- تغییر مهم: Modal برای تایید خروج -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabel">تایید خروج</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>آیا می‌خواهید از سیستم خارج شوید؟</strong>
                        <br>
                        <small class="text-muted">در صورت خروج، محصولات سبد خرید شما از سبد حذف می‌گردد.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        انصراف
                    </button>
                    <a href="@Url.Action("Logout", "Account")" class="btn btn-danger" id="confirmLogout">
                        خروج
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-content">
        <!-- نمایش پیام‌های TempData -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["InfoMessage"] != null)
        {
            <div class="alert alert-info alert-dismissible fade show mt-3" role="alert">
                @TempData["InfoMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <main role="main" class="pb-3 content-wrapper">
            @RenderBody()
        </main>

        <!-- فضای خالی در انتهای صفحه -->
        <div class="page-end-space"></div>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container text-center py-3">
            <div class="row">
                <div class="col-md-4">
                    <h6>دسترسی سریع</h6>
                    <ul class="list-unstyled">
                        <li><a asp-controller="Products" asp-action="Index" class="text-muted text-decoration-none">محصولات</a></li>
                        <li><a asp-controller="Home" asp-action="Privacy" class="text-muted text-decoration-none">حریم خصوصی</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>تماس با ما</h6>
                    <p class="mb-1">۰۲۱-۱۲۳۴۵۶۷۸</p>
                    <p class="mb-0">info@myshop.com</p>
                </div>
                <div class="col-md-4">
                    <h6>فروشگاه من</h6>
                    <p>سامانه فروش آنلاین با قابلیت‌های پیشرفته</p>
                </div>
            </div>
            <hr class="my-3">
            <div class="row">
                <div class="col-12">
                    &copy; 2025 - فروشگاه من -
                    <a asp-area="" asp-controller="Home" asp-action="Privacy" class="text-muted text-decoration-none">حریم خصوصی</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
        // تابع برای به روزرسانی تعداد سبد خرید
        function updateCartCount() {
            $.ajax({
                url: '/Cart/GetCartItemCount',
                type: 'GET',
                success: function (response) {
                    $('#cartCount').text(response.count);
                    $('#floatingCartCount').text(response.count);
                },
                error: function () {
                    $('#cartCount').text('0');
                    $('#floatingCartCount').text('0');
                }
            });
        }

        // تابع جدید برای چک کردن دوره‌ای و همگام‌سازی شمارنده‌ها
        function syncCartCounters() {
            var mainCount = $('#cartCount').text().trim();
            var floatingCount = $('#floatingCartCount').text().trim();

            if (mainCount !== floatingCount) {
                $('#floatingCartCount').text(mainCount);
            }
        }

        // مدیریت رفتار سبد خرید شناور
        function setupFloatingCart() {
            var floatingCartLink = $('#floatingCartLink');
            var isCartPage = window.location.pathname.toLowerCase().includes('/cart');

            if (isCartPage) {
                floatingCartLink.attr('href', 'javascript:void(0)');
                floatingCartLink.css('cursor', 'default');
                $('#floatingCart').addClass('disabled');
            } else {
                floatingCartLink.attr('href', '@Url.Action("Index", "Cart")');
                floatingCartLink.css('cursor', 'pointer');
                $('#floatingCart').removeClass('disabled');
            }
        }

        // مدیریت Modal خروج
        function setupLogoutModal() {
            $('.logout-link').on('click', function(e) {
                e.preventDefault();
                $('#logoutModal').modal('show');
            });

            $('#logoutModal').on('hidden.bs.modal', function () {
                $('.logout-link').focus();
            });
        }

        // مدیریت جستجوی لحظه‌ای - نسخه نهایی با نمایش محل مچ
        function setupLiveSearch() {
            const $searchToggle = $('#searchToggle');
            const $searchDropdown = $('#searchDropdown');
            const $searchInput = $('#searchInput');
            const $searchResults = $('#searchResults');
            let timeout;

            $searchToggle.on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $searchDropdown.toggle();
                if ($searchDropdown.is(':visible')) {
                    $searchInput.focus();
                }
            });

            $(document).on('click', function(e) {
                if (!$(e.target).closest('.search-container').length) {
                    $searchDropdown.hide();
                }
            });

            $searchInput.on('input', function() {
                clearTimeout(timeout);
                const query = $(this).val().trim();

                if (query.length < 2) {
                    $searchResults.html('<div class="search-no-results">حداقل ۲ کاراکتر وارد کنید</div>');
                    return;
                }

                timeout = setTimeout(() => {
                    $.get('/Products/Search', { query: query })
                        .done(function(data) {
                            if (data.length === 0) {
                                $searchResults.html('<div class="search-no-results">محصولی یافت نشد</div>');
                                return;
                            }

                            const html = data.map(product => `
                                <a href="/Products/Details/${product.id}" class="search-result-item">
                                    <img src="${product.imageUrl || '/images/no-image.png'}"
                                         class="search-result-img" alt="${product.productName}">
                                    <div class="search-result-info">
                                        <div class="search-result-name">${product.productName}</div>
                                        <div class="search-result-price">${product.price.toLocaleString()} تومان</div>
                                        <div class="search-result-match">
                                            <strong>${product.matchText}</strong> در <em>${product.matchField}</em>
                                        </div>
                                    </div>
                                </a>
                            `).join('');

                            $searchResults.html(html);
                        })
                        .fail(function() {
                            $searchResults.html('<div class="search-no-results text-danger">خطا در جستجو</div>');
                        });
                }, 300);
            });
        }

        // بارگذاری اولیه
        $(document).ready(function () {
            updateCartCount();
            setupFloatingCart();
            setupLogoutModal();
            setupLiveSearch();

            setInterval(updateCartCount, 3000);
            setInterval(syncCartCounters, 500);
        });

        $(document).on('cartUpdated', function() {
            updateCartCount();
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

--------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Shared\_ValidationScriptsPartial.cshtml

<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
---------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\Shared\Error.cshtml

@model DateTimeExtensions
@{
    ViewData["Title"] = "Error";
}

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (Model.ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@Model.RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>
-----------------------------------------------------------------------------------------------------------

D:\MyShopProject\Views\_ViewImports.cshtml

@using MyShopProject
@using MyShopProject.Models
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
------------------------------------------------------------------------------------------

D:\MyShopProject\Views\_ViewStart.cshtml

@{
    Layout = "_Layout";
}

------------------------------------------------------------------------------------------

D:\MyShopProject\appsettings.json

{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost\\SQLEXPRESS;Database=MyShopDB;Trusted_Connection=true;TrustServerCertificate=true;MultipleActiveResultSets=true"
  },
  "EmailSettings": {
    "SmtpServer": "smtp.gmail.com",
    "SmtpPort": 587,
    "Username": "shoprecpass@gmail.com",
    "Password": "yzfm hyou ecln qtjh",
    "FromEmail": "shoprecpass@gmail.com",
    "EnableSsl": true
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.AspNetCore.Routing": "Trace",
      "Microsoft.EntityFrameworkCore.Database.Command": "Warning"
    }
  },
  "AllowedHosts": "*"
}

-------------------------------------------------------------------------------------------------

D:\MyShopProject\Program.cs

using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.DataProtection;
using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;
using System.Text;
using System.Text.Encodings.Web;
using System.Text.Unicode;
using Microsoft.Extensions.Logging;
using Serilog;
using Serilog.Events;

var builder = WebApplication.CreateBuilder(args);

// تنظیمات کنسول برای فارسی
Console.OutputEncoding = Encoding.UTF8;
Console.InputEncoding = Encoding.UTF8;

// تنظیم Serilog
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Debug()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Information)
    .Enrich.FromLogContext()
    .WriteTo.Console(
        outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}"
    )
    .WriteTo.File(
        path: "wwwroot/logs/app-.log",
        rollingInterval: RollingInterval.Day,
        encoding: Encoding.UTF8,
        outputTemplate: "{Timestamp:yyyy-MM-dd HH:mm:ss} | {Level:u3} | {SourceContext} | {Message:lj}{NewLine}{Exception}",
        retainedFileCountLimit: 31
    )
    .CreateLogger();

// استفاده از Serilog
builder.Host.UseSerilog();

// تنظیمات JSON برای فارسی
builder.Services.AddControllersWithViews()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.Encoder = JavaScriptEncoder.Create(UnicodeRanges.BasicLatin, UnicodeRanges.Arabic);
        options.JsonSerializerOptions.PropertyNamingPolicy = null;
    });

// HtmlEncoder برای فارسی
builder.Services.AddSingleton<HtmlEncoder>(
    HtmlEncoder.Create(allowedRanges: new[] { UnicodeRanges.BasicLatin, UnicodeRanges.Arabic }));

// DbContext
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Data Protection
builder.Services.AddDataProtection();

// Session
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
    options.Cookie.Name = "MyShop.Session";
});

// Authentication
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = "/Account/Login";
        options.LogoutPath = "/Account/Logout";
        options.AccessDeniedPath = "/Account/AccessDenied";
        options.ExpireTimeSpan = TimeSpan.FromMinutes(30);
        options.SlidingExpiration = true;
    });

// Authorization
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy =>
        policy.RequireAssertion(context =>
            context.User.HasClaim(c => c.Type == "Role" && c.Value == "Admin")));
});

builder.Services.AddHttpContextAccessor();

var app = builder.Build();

// خطاها
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();

// لاگ‌گیری دقیق هر درخواست
app.UseSerilogRequestLogging();

// احراز هویت و دسترسی
app.UseAuthentication();
app.UseAuthorization();
app.UseSession();

// روت Areaها — حتماً اول باشد!
app.MapControllerRoute(
    name: "areas",
    pattern: "{area:exists}/{controller=Home}/{action=Index}/{id?}");

// روت پیش‌فرض
app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Products}/{action=Index}/{id?}");

app.Run();

------------------------------------------------------------------------------------------------------

D:\MyShopProject\Areas\Admin\Controllers\UsersController.cs

using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using MyShopProject.Models;
using Serilog;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace MyShopProject.Areas.Admin.Controllers
{
    [Area("Admin")]
    [Authorize(Roles = "Admin")]
    public class UsersController : Controller
    {
        private readonly AppDbContext _context;
        private readonly ILogger<UsersController> _logger;

        // لیست استان‌های ایران
        private static readonly List<string> _iranProvinces = new List<string>
        {
            "آذربایجان شرقی", "آذربایجان غربی", "اردبیل", "اصفهان", "البرز",
            "ایلام", "بوشهر", "تهران", "چهارمحال و بختیاری", "خراسان جنوبی",
            "خراسان رضوی", "خراسان شمالی", "خوزستان", "زنجان", "سمنان",
            "سیستان و بلوچستان", "فارس", "قزوین", "قم", "کردستان",
            "کرمان", "کرمانشاه", "کهگیلویه و بویراحمد", "گلستان", "گیلان",
            "لرستان", "مازندران", "مرکزی", "هرمزگان", "همدان", "یزد"
        };

        public UsersController(AppDbContext context, ILogger<UsersController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: /Admin/Users
        public async Task<IActionResult> Index(
            int page = 1,
            string searchProvince = "",
            string searchPhone = "",
            string searchPostalCode = "",
            string searchLastName = "")
        {
            try
            {
                _logger.LogInformation("صفحه مدیریت کاربران لود شد. صفحه: {Page}, فیلترها: {Filters}",
                    page, new { searchProvince, searchPhone, searchPostalCode, searchLastName });

                const int pageSize = 10;

                IQueryable<User> query = _context.Users.AsQueryable();

                if (!string.IsNullOrWhiteSpace(searchProvince))
                    query = query.Where(u => u.Province != null && u.Province.Contains(searchProvince.Trim()));
                if (!string.IsNullOrWhiteSpace(searchPhone))
                    query = query.Where(u => u.PhoneNumber != null && u.PhoneNumber.Contains(searchPhone.Trim()));
                if (!string.IsNullOrWhiteSpace(searchPostalCode))
                    query = query.Where(u => u.PostalCode != null && u.PostalCode.Contains(searchPostalCode.Trim()));
                if (!string.IsNullOrWhiteSpace(searchLastName))
                    query = query.Where(u => u.LastName != null && u.LastName.Contains(searchLastName.Trim()));

                var totalItems = await query.CountAsync();

                var users = await query
                    .OrderByDescending(u => u.CreatedAt)
                    .Skip((page - 1) * pageSize)
                    .Take(pageSize)
                    .ToListAsync();

                ViewBag.CurrentPage = page;
                ViewBag.TotalPages = (int)Math.Ceiling(totalItems / (double)pageSize);
                ViewBag.TotalItems = totalItems;
                ViewBag.SearchProvince = searchProvince;
                ViewBag.SearchPhone = searchPhone;
                ViewBag.SearchPostalCode = searchPostalCode;
                ViewBag.SearchLastName = searchLastName;

                _logger.LogDebug("تعداد کاربران نمایش داده شده: {Count} از {Total}", users.Count, totalItems);

                return View(users);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "خطا در بارگذاری صفحه مدیریت کاربران");
                TempData["ErrorMessage"] = "خطا در بارگذاری اطلاعات کاربران";
                return RedirectToAction("Index", "Home", new { area = "Admin" });
            }
        }

        // GET: /Admin/Users/Edit/5
        [HttpGet]
        public async Task<IActionResult> Edit(int id)
        {
            try
            {
                _logger.LogInformation("درخواست ویرایش کاربر با آیدی: {Id}", id);

                var user = await _context.Users
                    .FirstOrDefaultAsync(u => u.UserID == id);

                if (user == null)
                {
                    TempData["ErrorMessage"] = "کاربر یافت نشد.";
                    return RedirectToAction(nameof(Index));
                }

                // تجزیه Address به Province و DetailedAddress برای نمایش در فرم
                if (!string.IsNullOrEmpty(user.Address))
                {
                    var parts = user.Address.Split(" - ", StringSplitOptions.RemoveEmptyEntries);
                    user.Province = parts.Length > 0 ? parts[0].Trim() : string.Empty;
                    user.DetailedAddress = parts.Length > 1 ? string.Join(" - ", parts.Skip(1)).Trim() : string.Empty;
                }
                else
                {
                    user.Province = user.DetailedAddress = string.Empty;
                }

                // ارسال لیست استان‌ها به ویو
                ViewBag.Provinces = _iranProvinces;

                return View(user);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "خطا در بارگذاری ویرایش کاربر");
                TempData["ErrorMessage"] = "خطا در بارگذاری اطلاعات کاربر";
                return RedirectToAction(nameof(Index));
            }
        }

        // POST: /Admin/Users/Edit/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(int id, User user)
        {
            try
            {
                _logger.LogInformation("درخواست به‌روزرسانی کاربر با آیدی: {Id}", id);
                _logger.LogDebug("اطلاعات ارسالی از فرم - UserID: {UserID}, FirstName: {FirstName}, LastName: {LastName}, Email: {Email}",
                    user.UserID, user.FirstName, user.LastName, user.Email);

                // همسان‌سازی UserID در صورت ارسال‌نشدن صحیح
                if (user.UserID == 0 && id > 0)
                {
                    user.UserID = id;
                }

                if (id != user.UserID)
                {
                    _logger.LogWarning("عدم تطابق آیدی کاربر. درخواست: {RequestId}, مدل: {ModelId}", id, user.UserID);
                    TempData["ErrorMessage"] = "کاربر نامعتبر";
                    return RedirectToAction(nameof(Index));
                }

                if (!ModelState.IsValid)
                {
                    var validationErrors = ModelState.Values
                        .SelectMany(v => v.Errors)
                        .Select(e => e.ErrorMessage);
                    _logger.LogWarning("خطای اعتبارسنجی برای ویرایش کاربر با آیدی {Id}: {Errors}",
                        id, string.Join("; ", validationErrors));
                    _logger.LogWarning("ModelState is invalid. Keys: {Keys}",
                        string.Join(", ", ModelState.Keys));

                    // ارسال مجدد لیست استان‌ها در صورت خطای اعتبارسنجی
                    ViewBag.Provinces = _iranProvinces;
                    return View(user);
                }

                var existingUser = await _context.Users.FindAsync(id);
                if (existingUser == null)
                {
                    _logger.LogWarning("کاربر با آیدی {Id} در دیتابیس یافت نشد", id);
                    TempData["ErrorMessage"] = "کاربر یافت نشد";
                    return RedirectToAction(nameof(Index));
                }

                // جلوگیری از تغییر ایمیل به ایمیل تکراری
                if (!string.Equals(existingUser.Email, user.Email?.Trim(), StringComparison.OrdinalIgnoreCase))
                {
                    var emailExists = await _context.Users
                        .AnyAsync(u => u.Email == user.Email && u.UserID != id);
                    if (emailExists)
                    {
                        ModelState.AddModelError("Email", "این ایمیل قبلاً توسط کاربر دیگری استفاده شده است");
                        _logger.LogWarning("ایمیل تکراری برای ویرایش کاربر: {Email}", user.Email);
                        ViewBag.Provinces = _iranProvinces;
                        return View(user);
                    }
                }

                // به‌روزرسانی فیلدها
                existingUser.FirstName = user.FirstName?.Trim();
                existingUser.LastName = user.LastName?.Trim();
                existingUser.Email = user.Email?.Trim();
                existingUser.PhoneNumber = user.PhoneNumber?.Trim();
                existingUser.Province = user.Province?.Trim();
                existingUser.PostalCode = user.PostalCode?.Trim();
                existingUser.DetailedAddress = user.DetailedAddress?.Trim();
                existingUser.IsAdmin = user.IsAdmin;

                // به‌روزرسانی آدرس ترکیبی
                if (!string.IsNullOrEmpty(user.Province) && !string.IsNullOrEmpty(user.DetailedAddress))
                {
                    existingUser.Address = $"{user.Province.Trim()} - {user.DetailedAddress.Trim()}";
                }
                else if (!string.IsNullOrEmpty(user.Province))
                {
                    existingUser.Address = user.Province.Trim();
                }
                else
                {
                    existingUser.Address = string.Empty;
                }

                await _context.SaveChangesAsync();

                _logger.LogInformation("اطلاعات کاربر {Name} (ID: {Id}) با موفقیت به‌روزرسانی شد",
                    $"{user.FirstName} {user.LastName}", id);

                // پیام ساده و بدون کاراکتر اضافه
                TempData["SuccessMessage"] = $"اطلاعات کاربر {user.FirstName} {user.LastName} با موفقیت به‌روزرسانی شد";

                return RedirectToAction(nameof(Index));
            }
            catch (DbUpdateException dbEx)
            {
                _logger.LogError(dbEx, "خطای دیتابیس در ویرایش کاربر با آیدی {Id}", id);
                TempData["ErrorMessage"] = "خطا در به‌روزرسانی اطلاعات کاربر در دیتابیس";
                return RedirectToAction(nameof(Index));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "خطا در ویرایش کاربر با آیدی {Id}", id);
                TempData["ErrorMessage"] = "خطا در ویرایش کاربر. لطفاً دوباره تلاش کنید.";
                return RedirectToAction(nameof(Index));
            }
        }

        // POST: /Admin/Users/Delete/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Delete(int id)
        {
            try
            {
                _logger.LogInformation("درخواست حذف کاربر با آیدی: {Id}", id);

                var user = await _context.Users.FindAsync(id);
                if (user == null)
                {
                    _logger.LogWarning("کاربر با آیدی {Id} یافت نشد.", id);
                    TempData["ErrorMessage"] = "کاربر یافت نشد.";
                    return RedirectToAction(nameof(Index));
                }

                // جلوگیری از حذف خود ادمین
                var currentUserEmail = User.Identity?.Name;
                if (!string.IsNullOrEmpty(currentUserEmail) &&
                    string.Equals(user.Email, currentUserEmail, StringComparison.OrdinalIgnoreCase))
                {
                    _logger.LogWarning("کاربر جاری سعی در حذف خودش دارد. Email: {Email}", currentUserEmail);
                    TempData["ErrorMessage"] = "شما نمی‌توانید حساب کاربری خود را حذف کنید.";
                    return RedirectToAction(nameof(Index));
                }

                var userName = $"{user.FirstName} {user.LastName}";
                _context.Users.Remove(user);
                await _context.SaveChangesAsync();

                _logger.LogInformation("کاربر {Name} (ID: {Id}) با موفقیت حذف شد.", userName, id);
                TempData["SuccessMessage"] = $"کاربر {userName} با موفقیت حذف شد";
                return RedirectToAction(nameof(Index));
            }
            catch (DbUpdateException dbEx)
            {
                _logger.LogError(dbEx, "خطای دیتابیس در حذف کاربر با آیدی {Id}", id);
                TempData["ErrorMessage"] = "خطا در حذف کاربر. ممکن است کاربر دارای اطلاعات وابسته باشد.";
                return RedirectToAction(nameof(Index));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "خطا در حذف کاربر با آیدی {Id}", id);
                TempData["ErrorMessage"] = "خطا در حذف کاربر. لطفاً دوباره تلاش کنید.";
                return RedirectToAction(nameof(Index));
            }
        }

        // POST: /Admin/Users/DeleteSelected
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> DeleteSelected(int[] selectedIds)
        {
            _logger.LogInformation("درخواست حذف گروهی کاربران. تعداد: {Count}", selectedIds?.Length ?? 0);

            if (selectedIds == null || selectedIds.Length == 0)
            {
                _logger.LogWarning("هیچ کاربری برای حذف گروهی انتخاب نشده بود.");
                TempData["ErrorMessage"] = "هیچ کاربری انتخاب نشده است";
                return RedirectToAction(nameof(Index));
            }

            try
            {
                var users = await _context.Users
                    .Where(u => selectedIds.Contains(u.UserID))
                    .ToListAsync();

                if (!users.Any())
                {
                    _logger.LogWarning("کاربران با آیدی‌های {@Ids} یافت نشدند.", selectedIds);
                    TempData["ErrorMessage"] = "کاربران انتخاب‌شده یافت نشدند";
                    return RedirectToAction(nameof(Index));
                }

                // جلوگیری از حذف خود ادمین
                var currentUserEmail = User.Identity?.Name;
                var selfDeleteAttempt = !string.IsNullOrEmpty(currentUserEmail) &&
                                        users.Any(u => string.Equals(u.Email, currentUserEmail, StringComparison.OrdinalIgnoreCase));
                if (selfDeleteAttempt)
                {
                    _logger.LogWarning("کاربر جاری سعی در حذف خودش دارد. Email: {Email}", currentUserEmail);
                    TempData["ErrorMessage"] = "شما نمی‌توانید حساب کاربری خود را حذف کنید";
                    return RedirectToAction(nameof(Index));
                }

                var userNames = users.Select(u => $"{u.FirstName} {u.LastName}").ToList();
                _context.Users.RemoveRange(users);
                await _context.SaveChangesAsync();

                _logger.LogInformation("{Count} کاربر با موفقیت حذف شدند. آیدی‌ها: {@Ids}", users.Count, users.Select(u => u.UserID));
                TempData["SuccessMessage"] = $"{users.Count} کاربر با موفقیت حذف شدند: {string.Join("، ", userNames)}";
                return RedirectToAction(nameof(Index));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "خطا در حذف گروهی کاربران");
                TempData["ErrorMessage"] = "خطا در حذف کاربران. لطفاً دوباره تلاش کنید";
                return RedirectToAction(nameof(Index));
            }
        }

        // POST: /Admin/Users/ToggleAdmin/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ToggleAdmin(int id)
        {
            try
            {
                _logger.LogInformation("درخواست تغییر نقش کاربر با آیدی: {Id}", id);

                var user = await _context.Users.FindAsync(id);
                if (user == null)
                {
                    _logger.LogWarning("کاربر با آیدی {Id} برای تغییر نقش یافت نشد", id);
                    return Json(new { success = false, message = "کاربر یافت نشد" });
                }

                // جلوگیری از تغییر نقش خود ادمین
                var currentUserEmail = User.Identity?.Name;
                if (!string.IsNullOrEmpty(currentUserEmail) &&
                    string.Equals(user.Email, currentUserEmail, StringComparison.OrdinalIgnoreCase))
                {
                    _logger.LogWarning("کاربر جاری سعی در تغییر نقش خودش دارد. Email: {Email}", currentUserEmail);
                    return Json(new { success = false, message = "شما نمی‌توانید نقش خود را تغییر دهید" });
                }

                user.IsAdmin = !user.IsAdmin;
                await _context.SaveChangesAsync();

                var newRole = user.IsAdmin ? "مدیر" : "کاربر";
                _logger.LogInformation("نقش کاربر {Name} به {Role} تغییر کرد", $"{user.FirstName} {user.LastName}", newRole);

                return Json(new
                {
                    success = true,
                    message = $"نقش کاربر به {newRole} تغییر کرد",
                    isAdmin = user.IsAdmin
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "خطا در تغییر نقش کاربر با آیدی {Id}", id);
                return Json(new { success = false, message = "خطا در تغییر نقش کاربر" });
            }
        }

        // API برای جستجوی استان‌ها
        [HttpGet]
        public IActionResult SearchProvinces(string term)
        {
            if (string.IsNullOrWhiteSpace(term))
            {
                return Json(_iranProvinces);
            }

            var filteredProvinces = _iranProvinces
                .Where(p => p.Contains(term, StringComparison.OrdinalIgnoreCase))
                .ToList();

            return Json(filteredProvinces);
        }

        // لاگ کلیک‌های مرورگر (از JS)
        [HttpPost]
        [AllowAnonymous]
        public IActionResult LogClick([FromBody] object data)
        {
            _logger.LogInformation("کلیک دکمه از مرورگر: {@ClickData}", data);
            return Ok();
        }

        // لاگ خطاهای جاوااسکریپت
        [HttpPost]
        [AllowAnonymous]
        public IActionResult LogJsError([FromBody] object error)
        {
            _logger.LogError("خطای جاوااسکریپت: {@Error}", error);
            return Ok();
        }
    }
}

-----------------------------------------------------------------------------------------------------

D:\MyShopProject\Areas\Admin\Views\Users\Edit.cshtml


@model MyShopProject.Models.User
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "ویرایش کاربر";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    var provinces = ViewBag.Provinces as List<string> ?? new List<string>();
}

<div class="container-fluid">
    <!-- هدر صفحه -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2 text-gray-800">ویرایش کاربر</h1>
            <p class="mb-0">ویرایش اطلاعات کاربر: @Model?.FirstName @Model?.LastName</p>
        </div>
        <a href="@Url.Action("Index")" class="btn btn-secondary">
            بازگشت به لیست کاربران
        </a>
    </div>

    <!-- کارت ویرایش -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">اطلاعات کاربر</h6>
        </div>
        <div class="card-body">
            <!-- نمایش پیام‌ها -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>خطا در اعتبارسنجی:</strong>
                    <ul class="mb-0 mt-2">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <!-- فرم: id در route و hidden ارسال می‌شود -->
            <form asp-action="Edit" asp-route-id="@Model?.UserID" method="post" id="editForm">
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="UserID" />
                <input type="hidden" asp-for="Address" />
                <input type="hidden" name="id" value="@Model?.UserID" />

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="FirstName" class="form-label">نام *</label>
                            <input asp-for="FirstName" class="form-control"
                                   style="border: 2px solid #000;"
                                   placeholder="نام کاربر را وارد کنید" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Email" class="form-label">ایمیل *</label>
                            <input asp-for="Email" class="form-control"
                                   style="border: 2px solid #000;"
                                   placeholder="ایمیل کاربر را وارد کنید" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="PostalCode" class="form-label">کد پستی *</label>
                            <input asp-for="PostalCode" class="form-control"
                                   style="border: 2px solid #000;"
                                   placeholder="کد پستی را وارد کنید" />
                            <span asp-validation-for="PostalCode" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="DetailedAddress" class="form-label">آدرس دقیق</label>
                            <textarea asp-for="DetailedAddress" class="form-control" rows="3"
                                      style="border: 2px solid #000;"
                                      placeholder="آدرس دقیق را وارد کنید"></textarea>
                            <span asp-validation-for="DetailedAddress" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="LastName" class="form-label">نام خانوادگی *</label>
                            <input asp-for="LastName" class="form-control"
                                   style="border: 2px solid #000;"
                                   placeholder="نام خانوادگی کاربر را وارد کنید" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="PhoneNumber" class="form-label">شماره تلفن</label>
                            <input asp-for="PhoneNumber" class="form-control"
                                   style="border: 2px solid #000;"
                                   placeholder="شماره تلفن را وارد کنید" />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Province" class="form-label">استان</label>
                            <select asp-for="Province" class="form-control" id="provinceSelect"
                                    style="border: 2px solid #000;"
                                    data-live-search="true" title="استان را انتخاب یا جستجو کنید...">
                                <option value="">-- انتخاب استان --</option>
                                @foreach (var province in provinces)
                                {
                                    <option value="@province">@province</option>
                                }
                            </select>
                            <span asp-validation-for="Province" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="IsAdmin" class="form-check-input"
                                       style="transform: scale(1.5); margin-left: 10px; border: 2px solid #000;" />
                                <label asp-for="IsAdmin" class="form-check-label fw-bold">دسترسی مدیر سیستم</label>
                            </div>
                            <small class="form-text text-muted">
                                در صورت فعال بودن، کاربر به پنل مدیریت دسترسی خواهد داشت
                            </small>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات سیستمی -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="card-title mb-0">اطلاعات سیستمی</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>شناسه کاربر:</strong> @Model?.UserID
                                    </div>
                                    <div class="col-md-4">
                                        <strong>تاریخ ایجاد:</strong> @Model?.CreatedAt.ToString("yyyy/MM/dd")
                                    </div>
                                    <div class="col-md-4">
                                        <strong>وضعیت فعلی:</strong>
                                        <span class="badge @(Model != null && Model.IsAdmin ? "bg-success" : "bg-secondary")">
                                            @(Model != null && Model.IsAdmin ? "مدیر سیستم" : "کاربر عادی")
                                        </span>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(Model?.Address))
                                {
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <strong>آدرس کامل:</strong>
                                            <span class="text-muted">@Model.Address</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- دکمه‌های عملیات -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success" id="submitBtn" style="border: 2px solid #000;">
                                ذخیره تغییرات
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary" style="border: 2px solid #000;">
                                انصراف
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <style>
        /* استایل اضافی برای نمایش بهتر borderها */
        .form-control:focus {
            border-color: #000;
            box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
        }

        .bootstrap-select .dropdown-toggle {
            border: 2px solid #000 !important;
        }

        .btn {
            font-weight: bold;
        }
    </style>
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/i18n/defaults-fa_IR.min.js"></script>

    <script>
        $(document).ready(function () {
            console.log('صفحه ویرایش کاربر لود شد');

            // راه‌اندازی SelectPicker برای فیلد استان
            $('#provinceSelect').selectpicker({
                liveSearch: true,
                size: 5,
                noneSelectedText: 'استان را انتخاب کنید',
                noneResultsText: 'نتیجه‌ای برای {0} یافت نشد',
                countSelectedText: '{0} استان انتخاب شده',
                selectAllText: 'انتخاب همه',
                deselectAllText: 'عدم انتخاب همه'
            });

            // تنظیم مقدار فعلی استان در selectpicker
            var currentProvince = '@Model?.Province';
            if (currentProvince) {
                $('#provinceSelect').selectpicker('val', currentProvince);
            }

            function checkFieldValues() {
                console.log('بررسی مقادیر فیلدها:');
                console.log('UserID:', $('#UserID').val() || 'خالی');
                console.log('FirstName:', $('#FirstName').val() || 'خالی');
                console.log('LastName:', $('#LastName').val() || 'خالی');
                console.log('Email:', $('#Email').val() || 'خالی');
                console.log('PhoneNumber:', $('#PhoneNumber').val() || 'خالی');
                console.log('Province:', $('#provinceSelect').val() || 'خالی');
                console.log('PostalCode:', $('#PostalCode').val() || 'خالی');
                console.log('DetailedAddress:', $('#DetailedAddress').val() || 'خالی');
                console.log('IsAdmin:', $('#IsAdmin').is(':checked'));
            }

            setTimeout(checkFieldValues, 100);

            $('.alert').delay(5000).fadeOut();

            $('#editForm').on('submit', function (e) {
                console.log('فرم در حال ارسال است...');
                checkFieldValues();
                if (!$(this).valid()) {
                    e.preventDefault();
                } else {
                    $('#submitBtn').prop('disabled', true).html('در حال ذخیره...');
                }
            });

            $('input[required], textarea[required]').each(function () {
                var ph = $(this).attr('placeholder') || '';
                if (!ph.includes('(الزامی)')) {
                    $(this).attr('placeholder', ph + ' (الزامی)');
                }
            });

            $.validator.setDefaults({
                errorElement: 'span',
                errorClass: 'text-danger',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.mb-3').append(error);
                },
                highlight: function (element) {
                    $(element).addClass('is-invalid').removeClass('is-valid');
                    $(element).css('border', '2px solid #dc3545');
                },
                unhighlight: function (element) {
                    $(element).removeClass('is-invalid').addClass('is-valid');
                    $(element).css('border', '2px solid #000');
                }
            });

            $('#editForm').validate({
                rules: {
                    FirstName: { required: true },
                    LastName: { required: true },
                    Email: { required: true, email: true },
                    PostalCode: { required: true }
                },
                messages: {
                    FirstName: { required: "نام الزامی است" },
                    LastName: { required: "نام خانوادگی الزامی است" },
                    Email: { required: "ایمیل الزامی است", email: "فرمت ایمیل نامعتبر است" },
                    PostalCode: { required: "کد پستی الزامی است" }
                }
            });

            // هندل تغییرات در selectpicker
            $('#provinceSelect').on('changed.bs.select', function (e) {
                console.log('استان انتخاب شده:', $(this).val());
            });

            // اعمال border مشکی روی همه فیلدها پس از لود صفحه
            $('.form-control').css('border', '2px solid #000');
        });
    </script>
}

------------------------------------------------------------------------------------------------

D:\MyShopProject\Areas\Admin\Views\Users\Index.cshtml

@model List<MyShopProject.Models.User>
@{
    ViewData["Title"] = "مدیریت کاربران";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- هدر صفحه -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2 text-gray-800">مدیریت کاربران</h1>
            <p class="mb-0">مدیریت کامل کاربران فروشگاه</p>
        </div>
        <a href="/Admin" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-2"></i>بازگشت به پیشخوان
        </a>
    </div>

    <!-- کارت فیلترها -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">فیلتر و جستجو</h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">استان</label>
                    <input type="text" name="searchProvince" class="form-control filter-input-black"
                           value="@ViewBag.SearchProvince" placeholder="جستجو بر اساس استان">
                </div>
                <div class="col-md-3">
                    <label class="form-label">تلفن</label>
                    <input type="text" name="searchPhone" class="form-control filter-input-black"
                           value="@ViewBag.SearchPhone" placeholder="جستجو بر اساس تلفن">
                </div>
                <div class="col-md-3">
                    <label class="form-label">کد پستی</label>
                    <input type="text" name="searchPostalCode" class="form-control filter-input-black"
                           value="@ViewBag.SearchPostalCode" placeholder="جستجو بر اساس کد پستی">
                </div>
                <div class="col-md-3">
                    <label class="form-label">نام خانوادگی</label>
                    <input type="text" name="searchLastName" class="form-control filter-input-black"
                           value="@ViewBag.SearchLastName" placeholder="جستجو بر اساس نام خانوادگی">
                </div>
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>اعمال فیلتر
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>حذف فیلتر
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- کارت لیست کاربران -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">لیست کاربران</h6>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-info text-dark">تعداد کل: @ViewBag.TotalItems کاربر</span>

                <!-- دکمه حذف گروهی -->
                <button type="button" class="btn btn-danger" id="deleteSelectedBtn" style="display: none;">
                    <i class="fas fa-trash me-2"></i>حذف کاربران انتخاب شده
                </button>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <!-- فرم حذف گروهی -->
                <form id="bulkDeleteForm" method="post" asp-action="DeleteSelected">
                    @Html.AntiForgeryToken()

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover users-table users-table--excel" id="usersTable" width="100%" cellspacing="0">
                            <thead class="bg-light">
                                <tr>
                                    <th width="50px">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th width="60px">#</th>
                                    <th>نام و نام خانوادگی</th>
                                    <th>ایمیل</th>
                                    <th>تلفن</th>
                                    <th>استان</th>
                                    <th>کد پستی</th>
                                    <th>نقش</th>
                                    <th>تاریخ ثبت</th>
                                    <th width="120px">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int counter = (ViewBag.CurrentPage - 1) * 10 + 1;
                                }
                                @foreach (var user in Model)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="selectedIds" value="@user.UserID"
                                                   class="form-check-input user-checkbox">
                                        </td>
                                        <td>@counter</td>
                                        @{
                                            counter++;
                                        }
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                                                     style="width: 40px; height: 40px; font-size: 14px;">
                                                    @(user.FirstName?.Substring(0, 1) ?? "?")@(user.LastName?.Substring(0, 1) ?? "")
                                                </div>
                                                <div>
                                                    <div class="fw-bold">@user.FirstName @user.LastName</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <a href="mailto:@user.Email" class="text-decoration-none">@user.Email</a>
                                        </td>
                                        <td dir="ltr" class="text-start">@user.PhoneNumber</td>
                                        <td>
                                            <span class="badge bg-info text-dark">
                                                @(string.IsNullOrEmpty(user.Province) ? "نامشخص" : user.Province)
                                            </span>
                                        </td>
                                        <td>@user.PostalCode</td>
                                        <td>
                                            <span class="badge @(user.IsAdmin ? "bg-success" : "bg-secondary")">
                                                @(user.IsAdmin ? "مدیر" : "کاربر")
                                            </span>
                                        </td>
                                        <td>@user.CreatedAt.ToString("yyyy/MM/dd")</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <!-- دکمه ویرایش -->
                                                <a href="@Url.Action("Edit", new { id = user.UserID })"
                                                   class="btn btn-warning text-white" title="ویرایش کاربر">
                                                    <i class="fas fa-edit"></i>
                                                </a>

                                                <!-- دکمه حذف -->
                                                <button type="button" class="btn btn-danger"
                                                        onclick="deleteUser(@user.UserID, '@user.FirstName @user.LastName')"
                                                        title="حذف کاربر">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </form>

                <!-- صفحه‌بندی -->
                @if (ViewBag.TotalPages > 1)
                {
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            @for (int i = 1; i <= ViewBag.TotalPages; i++)
                            {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link"
                                       href="@Url.Action("Index", new {
                                           page = i,
                                           searchProvince = ViewBag.SearchProvince,
                                           searchPhone = ViewBag.SearchPhone,
                                           searchPostalCode = ViewBag.SearchPostalCode,
                                           searchLastName = ViewBag.SearchLastName
                                       })">
                                        @i
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">هیچ کاربری یافت نشد</p>
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-refresh me-2"></i>بارگذاری مجدد
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // تابع برای حذف کاربر
        function deleteUser(userId, userName) {
            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: `کاربر "${userName}" حذف خواهد شد. این عمل قابل بازگشت نیست!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'بله، حذف شود',
                cancelButtonText: 'لغو',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // ایجاد فرم برای ارسال درخواست POST
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/Admin/Users/Delete/${userId}`;

                    // افزودن token برای جلوگیری از CSRF
                    const token = document.createElement('input');
                    token.type = 'hidden';
                    token.name = '__RequestVerificationToken';
                    token.value = $('input[name="__RequestVerificationToken"]').val();
                    form.appendChild(token);

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        // مدیریت چک‌باکس‌ها برای حذف گروهی
        $(document).ready(function () {
            // انتخاب همه / عدم انتخاب همه
            $('#selectAll').change(function() {
                $('.user-checkbox').prop('checked', this.checked);
                toggleDeleteSelectedBtn();
            });

            // تغییر در چک‌باکس‌های کاربران
            $('.user-checkbox').change(function() {
                // اگر همه چک‌باکس‌ها انتخاب شده‌اند، selectAll رو هم چک کن
                $('#selectAll').prop('checked',
                    $('.user-checkbox:checked').length === $('.user-checkbox').length
                );
                toggleDeleteSelectedBtn();
            });

            // نمایش/مخفی کردن دکمه حذف گروهی
            function toggleDeleteSelectedBtn() {
                const checkedCount = $('.user-checkbox:checked').length;
                if (checkedCount > 0) {
                    $('#deleteSelectedBtn').show();
                    $('#deleteSelectedBtn').html(`<i class="fas fa-trash me-2"></i>حذف ${checkedCount} کاربر انتخاب شده`);
                } else {
                    $('#deleteSelectedBtn').hide();
                }
            }

            // حذف گروهی کاربران - راه‌حل قطعی
            $('#deleteSelectedBtn').click(function() {
                const selectedCount = $('.user-checkbox:checked').length;
                const selectedUsers = [];

                $('.user-checkbox:checked').each(function() {
                    selectedUsers.push(parseInt($(this).val()));
                });

                console.log('Selected Users IDs:', selectedUsers);

                Swal.fire({
                    title: 'آیا مطمئن هستید؟',
                    text: `${selectedCount} کاربر انتخاب شده حذف خواهند شد. این عمل قابل بازگشت نیست!`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: `بله، ${selectedCount} کاربر حذف شوند`,
                    cancelButtonText: 'لغو',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        // راه‌حل 1: استفاده از AJAX
                        $.ajax({
                            url: '/Admin/Users/DeleteSelected',
                            type: 'POST',
                            traditional: true, // این خط مهمه برای ارسال آرایه
                            data: {
                                selectedIds: selectedUsers,
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function(response) {
                                // ریدایرکت به صفحه لیست کاربران
                                window.location.href = '/Admin/Users';
                            },
                            error: function(xhr, status, error) {
                                console.error('Error:', error);
                                Swal.fire({
                                    title: 'خطا!',
                                    text: 'خطا در حذف کاربران. لطفاً دوباره تلاش کنید.',
                                    icon: 'error',
                                    confirmButtonText: 'متوجه شدم'
                                });
                            }
                        });
                    }
                });
            });

            // نمایش پیام‌های موفقیت یا خطا
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                                Swal.fire({
                                    title: 'موفقیت',
                                    text: '@TempData["SuccessMessage"]',
                                    icon: 'success',
                                    confirmButtonText: 'متوجه شدم'
                                });
            </text>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <text>
                                Swal.fire({
                                    title: 'خطا',
                                    text: '@TempData["ErrorMessage"]',
                                    icon: 'error',
                                    confirmButtonText: 'متوجه شدم'
                                });
            </text>
        }

            // لاگ کلیک‌ها برای دیباگ
            $('button').on('click', function() {
                const buttonText = $(this).text() || $(this).attr('title') || 'Unknown Button';
                console.log('Button clicked:', buttonText);
            });
        });

        // هندل خطاهای جاوااسکریپت
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
        });
    </script>
}

<!-- اضافه کردن SweetAlert2 برای modal های زیبا -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
-----------------------------------------------------------------------------------------------------------

D:\MyShopProject\Areas\Admin\Views\_ViewImports.cshtml

@using MyShopProject
@using MyShopProject.Models
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@namespace MyShopProject.Areas.Admin.Views


----------------------------------------------------------------------------------------------------

D:\MyShopProject\Areas\Admin\Views\Shared\_AdminLayout.cshtml

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MyShopProject</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

            .sidebar .nav-link {
                color: rgba(255,255,255,.8);
                padding: 12px 20px;
                margin: 4px 0;
                border-radius: 8px;
                transition: all 0.3s;
            }

                .sidebar .nav-link:hover {
                    color: white;
                    background: rgba(255,255,255,.1);
                }

                .sidebar .nav-link.active {
                    color: white;
                    background: rgba(255,255,255,.2);
                }

                .sidebar .nav-link i {
                    margin-left: 10px;
                }

        .main-content {
            padding: 20px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e3e6f0;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
        }

        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #4e73df;
        }
    </style>

    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- نوار کناری -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            پنل مدیریت
                        </h4>
                        <small class="text-white-50">MyShop Project</small>
                    </div>
                    <ul class="nav flex-column">
                        <!-- پیشخوان -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Home", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "home" ? "active" : "")">
                                پیشخوان
                            </a>
                        </li>

                        <!-- مدیریت محصولات -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Products", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "products" ? "active" : "")">
                                مدیریت محصولات
                            </a>
                        </li>

                        <!-- مدیریت دسته‌بندی‌ها -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Categories", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "categories" ? "active" : "")">
                                مدیریت دسته‌بندی‌ها
                            </a>
                        </li>

                        <!-- مدیریت کاربران -->
                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Users", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "index" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "users" ? "active" : "")">
                                مدیریت کاربران
                            </a>
                        </li>

                        <!-- محصولات کم موجود -->
                        <li class="nav-item">
                            <a href="@Url.Action("LowStock", "Products", new { area = "Admin" })"
                               class="nav-link @(ViewContext.RouteData.Values["action"]?.ToString()?.ToLower() == "lowstock" && ViewContext.RouteData.Values["controller"]?.ToString()?.ToLower() == "products" ? "active" : "")">
                                محصولات کم موجود
                            </a>
                        </li>

                        <!-- بازگشت به فروشگاه -->
                        <li class="nav-item mt-4">
                            <a href="@Url.Action("Index", "Products", new { area = "" })"
                               class="nav-link text-warning">
                                بازگشت به فروشگاه
                            </a>
                        </li>

                        <!-- خروج -->
                        <li class="nav-item">
                            <a href="@Url.Action("Logout", "Account", new { area = "" })"
                               class="nav-link text-danger">
                                خروج از سیستم
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- محتوای اصلی -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                @RenderBody()
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>